<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>虚拟dom | yiluhuakai</title>
    <meta name="generator" content="VuePress 1.7.1">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/assets/css/0.styles.992cb7aa.css" as="style"><link rel="preload" href="/assets/js/app.9b56a05a.js" as="script"><link rel="preload" href="/assets/js/2.b22280cb.js" as="script"><link rel="preload" href="/assets/js/50.497cb73f.js" as="script"><link rel="prefetch" href="/assets/js/10.413ab2ab.js"><link rel="prefetch" href="/assets/js/100.2d785741.js"><link rel="prefetch" href="/assets/js/101.a9fd3349.js"><link rel="prefetch" href="/assets/js/11.99f54ddd.js"><link rel="prefetch" href="/assets/js/12.c46f64f3.js"><link rel="prefetch" href="/assets/js/13.6add00c5.js"><link rel="prefetch" href="/assets/js/14.40115781.js"><link rel="prefetch" href="/assets/js/15.c3827c6c.js"><link rel="prefetch" href="/assets/js/16.304d275d.js"><link rel="prefetch" href="/assets/js/17.006e2fe4.js"><link rel="prefetch" href="/assets/js/18.7f93828f.js"><link rel="prefetch" href="/assets/js/19.a72c6116.js"><link rel="prefetch" href="/assets/js/20.d175ff74.js"><link rel="prefetch" href="/assets/js/21.7092a034.js"><link rel="prefetch" href="/assets/js/22.1419ba41.js"><link rel="prefetch" href="/assets/js/23.ce5e3c1b.js"><link rel="prefetch" href="/assets/js/24.9f9edaa3.js"><link rel="prefetch" href="/assets/js/25.a57ae5dc.js"><link rel="prefetch" href="/assets/js/26.5ba697f1.js"><link rel="prefetch" href="/assets/js/27.9ecaa5dc.js"><link rel="prefetch" href="/assets/js/28.290c65fe.js"><link rel="prefetch" href="/assets/js/29.bdbc3eeb.js"><link rel="prefetch" href="/assets/js/3.ac44586b.js"><link rel="prefetch" href="/assets/js/30.6f37d998.js"><link rel="prefetch" href="/assets/js/31.b1ac1238.js"><link rel="prefetch" href="/assets/js/32.024f8182.js"><link rel="prefetch" href="/assets/js/33.202e11b5.js"><link rel="prefetch" href="/assets/js/34.e755ffc0.js"><link rel="prefetch" href="/assets/js/35.376b8f63.js"><link rel="prefetch" href="/assets/js/36.56735f24.js"><link rel="prefetch" href="/assets/js/37.b7d03c63.js"><link rel="prefetch" href="/assets/js/38.d9407e30.js"><link rel="prefetch" href="/assets/js/39.4f87e45d.js"><link rel="prefetch" href="/assets/js/4.a4a037c8.js"><link rel="prefetch" href="/assets/js/40.5a53ee48.js"><link rel="prefetch" href="/assets/js/41.f7fa6a68.js"><link rel="prefetch" href="/assets/js/42.3c07d4ad.js"><link rel="prefetch" href="/assets/js/43.2965402d.js"><link rel="prefetch" href="/assets/js/44.fef5da48.js"><link rel="prefetch" href="/assets/js/45.ff058ba7.js"><link rel="prefetch" href="/assets/js/46.5a74f2cd.js"><link rel="prefetch" href="/assets/js/47.5931bb97.js"><link rel="prefetch" href="/assets/js/48.cbf85ab3.js"><link rel="prefetch" href="/assets/js/49.0319f8e4.js"><link rel="prefetch" href="/assets/js/5.d0d45788.js"><link rel="prefetch" href="/assets/js/51.4b6e5c5b.js"><link rel="prefetch" href="/assets/js/52.f4edf34f.js"><link rel="prefetch" href="/assets/js/53.df9c0557.js"><link rel="prefetch" href="/assets/js/54.1654be3b.js"><link rel="prefetch" href="/assets/js/55.c9e37e1f.js"><link rel="prefetch" href="/assets/js/56.052c5808.js"><link rel="prefetch" href="/assets/js/57.cf8cebef.js"><link rel="prefetch" href="/assets/js/58.220252cd.js"><link rel="prefetch" href="/assets/js/59.7e76271a.js"><link rel="prefetch" href="/assets/js/6.b5583d51.js"><link rel="prefetch" href="/assets/js/60.38c88311.js"><link rel="prefetch" href="/assets/js/61.c4b0da1c.js"><link rel="prefetch" href="/assets/js/62.d8be952c.js"><link rel="prefetch" href="/assets/js/63.19c02fd0.js"><link rel="prefetch" href="/assets/js/64.9d51d342.js"><link rel="prefetch" href="/assets/js/65.31c63e7c.js"><link rel="prefetch" href="/assets/js/66.badcb6df.js"><link rel="prefetch" href="/assets/js/67.83764c63.js"><link rel="prefetch" href="/assets/js/68.152c45b6.js"><link rel="prefetch" href="/assets/js/69.2119cafb.js"><link rel="prefetch" href="/assets/js/7.d21b1042.js"><link rel="prefetch" href="/assets/js/70.ff7211f3.js"><link rel="prefetch" href="/assets/js/71.26e7783e.js"><link rel="prefetch" href="/assets/js/72.dc5a3ba6.js"><link rel="prefetch" href="/assets/js/73.d8356ad1.js"><link rel="prefetch" href="/assets/js/74.10184aff.js"><link rel="prefetch" href="/assets/js/75.716811ca.js"><link rel="prefetch" href="/assets/js/76.046e6155.js"><link rel="prefetch" href="/assets/js/77.d287e80f.js"><link rel="prefetch" href="/assets/js/78.635ed9d3.js"><link rel="prefetch" href="/assets/js/79.4485123f.js"><link rel="prefetch" href="/assets/js/8.8bd3dfa9.js"><link rel="prefetch" href="/assets/js/80.74fc122c.js"><link rel="prefetch" href="/assets/js/81.cb3ce31c.js"><link rel="prefetch" href="/assets/js/82.bf81591e.js"><link rel="prefetch" href="/assets/js/83.01b0002d.js"><link rel="prefetch" href="/assets/js/84.6af4ae46.js"><link rel="prefetch" href="/assets/js/85.31122a7c.js"><link rel="prefetch" href="/assets/js/86.7641b1ab.js"><link rel="prefetch" href="/assets/js/87.63912fdd.js"><link rel="prefetch" href="/assets/js/88.01d6d061.js"><link rel="prefetch" href="/assets/js/89.ec494ad7.js"><link rel="prefetch" href="/assets/js/9.17f8341c.js"><link rel="prefetch" href="/assets/js/90.a2905192.js"><link rel="prefetch" href="/assets/js/91.5b1b5e00.js"><link rel="prefetch" href="/assets/js/92.f8112523.js"><link rel="prefetch" href="/assets/js/93.8e9fd5a8.js"><link rel="prefetch" href="/assets/js/94.41217af6.js"><link rel="prefetch" href="/assets/js/95.b253d44f.js"><link rel="prefetch" href="/assets/js/96.76495ed0.js"><link rel="prefetch" href="/assets/js/97.9f48729e.js"><link rel="prefetch" href="/assets/js/98.0e36c4a8.js"><link rel="prefetch" href="/assets/js/99.5b6ab9af.js">
    <link rel="stylesheet" href="/assets/css/0.styles.992cb7aa.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">yiluhuakai</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/leetcode/" class="nav-link">
  LeetCode
</a></div><div class="nav-item"><a href="/golang/" class="nav-link">
  Go
</a></div><div class="nav-item"><a href="/mysql/" class="nav-link">
  Mysql
</a></div><div class="nav-item"><a href="/clang/" class="nav-link">
  C语言
</a></div><div class="nav-item"><a href="/es/" class="nav-link router-link-active">
  前端
</a></div><div class="nav-item"><a href="/nodejs/" class="nav-link">
  nodejs
</a></div><div class="nav-item"><a href="/react/" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/java/" class="nav-link">
  Java
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/leetcode/" class="nav-link">
  LeetCode
</a></div><div class="nav-item"><a href="/golang/" class="nav-link">
  Go
</a></div><div class="nav-item"><a href="/mysql/" class="nav-link">
  Mysql
</a></div><div class="nav-item"><a href="/clang/" class="nav-link">
  C语言
</a></div><div class="nav-item"><a href="/es/" class="nav-link router-link-active">
  前端
</a></div><div class="nav-item"><a href="/nodejs/" class="nav-link">
  nodejs
</a></div><div class="nav-item"><a href="/react/" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/java/" class="nav-link">
  Java
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/es/const_let.html" class="sidebar-link">let和const</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/es/obj.html" class="sidebar-link">对象</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/es/obj.html#对象字面量的增强" class="sidebar-link">对象字面量的增强</a></li><li class="sidebar-sub-header"><a href="/es/obj.html#object-assign" class="sidebar-link">Object.assign</a></li><li class="sidebar-sub-header"><a href="/es/obj.html#object-is" class="sidebar-link">Object.is</a></li><li class="sidebar-sub-header"><a href="/es/obj.html#proxy" class="sidebar-link">Proxy</a></li><li class="sidebar-sub-header"><a href="/es/obj.html#reflect" class="sidebar-link">Reflect</a></li><li class="sidebar-sub-header"><a href="/es/obj.html#promise" class="sidebar-link">Promise</a></li><li class="sidebar-sub-header"><a href="/es/obj.html#class" class="sidebar-link">Class</a></li></ul></li><li><a href="/es/func.html" class="sidebar-link">函数</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/es/func.html#默认值参数" class="sidebar-link">默认值参数</a></li><li class="sidebar-sub-header"><a href="/es/func.html#剩余参数" class="sidebar-link">剩余参数</a></li><li class="sidebar-sub-header"><a href="/es/func.html#数组的解构" class="sidebar-link">数组的解构</a></li><li class="sidebar-sub-header"><a href="/es/func.html#箭头函数" class="sidebar-link">箭头函数</a></li></ul></li><li><a href="/es/string.html" class="sidebar-link">ES中的模版字符串</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/es/string.html#es中的模版字符串" class="sidebar-link">ES中的模版字符串</a></li><li class="sidebar-sub-header"><a href="/es/string.html#es2015中新增的关于操作字符串的方法" class="sidebar-link">ES2015中新增的关于操作字符串的方法</a></li></ul></li><li><a href="/es/set_map.html" class="sidebar-link">set 和 map</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/es/set_map.html#set" class="sidebar-link">set</a></li><li class="sidebar-sub-header"><a href="/es/set_map.html#map" class="sidebar-link">map</a></li></ul></li><li><a href="/es/deconstruction.html" class="sidebar-link">解构</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/es/deconstruction.html#数组的解构" class="sidebar-link">数组的解构</a></li><li class="sidebar-sub-header"><a href="/es/deconstruction.html#对象的解构" class="sidebar-link">对象的解构</a></li><li class="sidebar-sub-header"><a href="/es/deconstruction.html#字符串的解构" class="sidebar-link">字符串的解构</a></li></ul></li><li><a href="/es/Symbol.html" class="sidebar-link">Symbol</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/es/for_of.html" class="sidebar-link">for..of 和迭代器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/es/for_of.html#for-of-和迭代器" class="sidebar-link">for..of 和迭代器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/es/for_of.html#for-of-循环" class="sidebar-link">for ... of 循环</a></li><li class="sidebar-sub-header"><a href="/es/for_of.html#迭代器模式和迭代器" class="sidebar-link">迭代器模式和迭代器</a></li><li class="sidebar-sub-header"><a href="/es/for_of.html#生成器函数" class="sidebar-link">生成器函数</a></li></ul></li></ul></li><li><a href="/es/es2016_17.html" class="sidebar-link">ES2016和ES2017新特性</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/es/es2016_17.html#es2016和es2017新特性" class="sidebar-link">ES2016和ES2017新特性</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/es/es2016_17.html#es2016" class="sidebar-link">ES2016</a></li><li class="sidebar-sub-header"><a href="/es/es2016_17.html#es2017" class="sidebar-link">ES2017</a></li></ul></li></ul></li><li><a href="/es/Ts.html" class="sidebar-link">TypeScript</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/es/Ts.html#typescript" class="sidebar-link">TypeScript</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/es/Ts.html#强类型和弱类型" class="sidebar-link">强类型和弱类型</a></li><li class="sidebar-sub-header"><a href="/es/Ts.html#typescript简介" class="sidebar-link">TypeScript简介</a></li><li class="sidebar-sub-header"><a href="/es/Ts.html#typescript上手" class="sidebar-link">TypeScript上手</a></li><li class="sidebar-sub-header"><a href="/es/Ts.html#ts的原始类型" class="sidebar-link">ts的原始类型</a></li><li class="sidebar-sub-header"><a href="/es/Ts.html#中文错误消息" class="sidebar-link">中文错误消息</a></li><li class="sidebar-sub-header"><a href="/es/Ts.html#ts作用域问题" class="sidebar-link">TS作用域问题</a></li><li class="sidebar-sub-header"><a href="/es/Ts.html#ts中的类型注解" class="sidebar-link">TS中的类型注解</a></li><li class="sidebar-sub-header"><a href="/es/Ts.html#ts的polyfill-垫片" class="sidebar-link">TS的polyfill(垫片)</a></li><li class="sidebar-sub-header"><a href="/es/Ts.html#在vue项目中加入ts-https-cn-vuejs-org-v2-guide-typescript-html" class="sidebar-link">[在vue项目中加入ts]（https://cn.vuejs.org/v2/guide/typescript.html）</a></li><li class="sidebar-sub-header"><a href="/es/Ts.html#标注-prop" class="sidebar-link" style="padding-left:3rem;">标注 Prop</a></li><li class="sidebar-sub-header"><a href="/es/Ts.html#再已有的js项目中加入类型验https-cloud-tencent-com-developer-article-1006180" class="sidebar-link">再已有的JS项目中加入类型验https://cloud.tencent.com/developer/article/1006180</a></li></ul></li></ul></li><li><a href="/es/flow.html" class="sidebar-link">flow</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/es/flow.html#flow" class="sidebar-link">flow</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/es/flow.html#flow的使用" class="sidebar-link">flow的使用</a></li><li class="sidebar-sub-header"><a href="/es/flow.html#flow的语法规则" class="sidebar-link">flow的语法规则</a></li><li class="sidebar-sub-header"><a href="/es/flow.html#flow类型文档" class="sidebar-link">flow类型文档</a></li><li class="sidebar-sub-header"><a href="/es/flow.html#运行环境api" class="sidebar-link">运行环境api</a></li></ul></li></ul></li><li><a href="/es/js-better.html" class="sidebar-link">JS性能优化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/es/js-better.html#js性能优化" class="sidebar-link">JS性能优化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/es/js-better.html#什么是性能优化" class="sidebar-link">什么是性能优化</a></li><li class="sidebar-sub-header"><a href="/es/js-better.html#js的内存管理" class="sidebar-link">JS的内存管理</a></li><li class="sidebar-sub-header"><a href="/es/js-better.html#js的垃圾回收" class="sidebar-link">JS的垃圾回收</a></li><li class="sidebar-sub-header"><a href="/es/js-better.html#gc的定义与作用" class="sidebar-link">GC的定义与作用</a></li><li class="sidebar-sub-header"><a href="/es/js-better.html#gc里面的垃圾" class="sidebar-link">GC里面的垃圾</a></li><li class="sidebar-sub-header"><a href="/es/js-better.html#gc算法" class="sidebar-link">GC算法</a></li><li class="sidebar-sub-header"><a href="/es/js-better.html#常见的gc算法" class="sidebar-link">常见的GC算法</a></li><li class="sidebar-sub-header"><a href="/es/js-better.html#引用计数算法" class="sidebar-link">引用计数算法</a></li><li class="sidebar-sub-header"><a href="/es/js-better.html#标记清除算法" class="sidebar-link">标记清除算法</a></li><li class="sidebar-sub-header"><a href="/es/js-better.html#标记整理算法" class="sidebar-link">标记整理算法</a></li><li class="sidebar-sub-header"><a href="/es/js-better.html#v8介绍" class="sidebar-link">V8介绍</a></li><li class="sidebar-sub-header"><a href="/es/js-better.html#v8的垃圾回收" class="sidebar-link">v8的垃圾回收</a></li><li class="sidebar-sub-header"><a href="/es/js-better.html#使用performance" class="sidebar-link">使用performance</a></li><li class="sidebar-sub-header"><a href="/es/js-better.html#如何判断是否存在频繁的gc" class="sidebar-link">如何判断是否存在频繁的GC</a></li><li class="sidebar-sub-header"><a href="/es/js-better.html#频繁gc的带来的问题" class="sidebar-link">频繁GC的带来的问题</a></li><li class="sidebar-sub-header"><a href="/es/js-better.html#代码优化介绍" class="sidebar-link">代码优化介绍</a></li><li class="sidebar-sub-header"><a href="/es/js-better.html#遍历对象" class="sidebar-link">遍历对象</a></li></ul></li></ul></li><li><a href="/es/project.html" class="sidebar-link">前端工程化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/es/project.html#前端工程化" class="sidebar-link">前端工程化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/es/project.html#前端工程化的目的" class="sidebar-link">前端工程化的目的</a></li><li class="sidebar-sub-header"><a href="/es/project.html#前端工程化的表现" class="sidebar-link">前端工程化的表现</a></li><li class="sidebar-sub-header"><a href="/es/project.html#一些成熟的工程化集成" class="sidebar-link">一些成熟的工程化集成</a></li><li class="sidebar-sub-header"><a href="/es/project.html#脚手架工具" class="sidebar-link">脚手架工具</a></li><li class="sidebar-sub-header"><a href="/es/project.html#常用的脚手架工具" class="sidebar-link">常用的脚手架工具</a></li><li class="sidebar-sub-header"><a href="/es/project.html#yeoman的使用" class="sidebar-link">yeoman的使用</a></li><li class="sidebar-sub-header"><a href="/es/project.html#自定义generator" class="sidebar-link">自定义generator</a></li><li class="sidebar-sub-header"><a href="/es/project.html#创建一个vue-js的脚手架" class="sidebar-link">创建一个vue.js的脚手架</a></li><li class="sidebar-sub-header"><a href="/es/project.html#plop脚手架" class="sidebar-link">plop脚手架</a></li><li class="sidebar-sub-header"><a href="/es/project.html#plop的使用" class="sidebar-link">plop的使用</a></li><li class="sidebar-sub-header"><a href="/es/project.html#使用plop在react中创建组件" class="sidebar-link">使用plop在react中创建组件</a></li><li class="sidebar-sub-header"><a href="/es/project.html#脚手架的工具原理" class="sidebar-link">脚手架的工具原理</a></li><li class="sidebar-sub-header"><a href="/es/project.html#脚手架具体实现" class="sidebar-link">脚手架具体实现</a></li><li class="sidebar-sub-header"><a href="/es/project.html#自动化构建" class="sidebar-link">自动化构建</a></li><li class="sidebar-sub-header"><a href="/es/project.html#自动化构建初体验" class="sidebar-link">自动化构建初体验</a></li><li class="sidebar-sub-header"><a href="/es/project.html#常用的自动化构建工具" class="sidebar-link">常用的自动化构建工具</a></li><li class="sidebar-sub-header"><a href="/es/project.html#grunt的基本使用" class="sidebar-link">grunt的基本使用</a></li><li class="sidebar-sub-header"><a href="/es/project.html#grunt常用插件的使用" class="sidebar-link">grunt常用插件的使用</a></li><li class="sidebar-sub-header"><a href="/es/project.html#gulp的使用" class="sidebar-link">gulp的使用</a></li><li class="sidebar-sub-header"><a href="/es/project.html#创建项目目录并进入" class="sidebar-link" style="padding-left:3rem;">创建项目目录并进入</a></li><li class="sidebar-sub-header"><a href="/es/project.html#在项目目录下创建-package-json-文件" class="sidebar-link" style="padding-left:3rem;">在项目目录下创建 package.json 文件</a></li><li class="sidebar-sub-header"><a href="/es/project.html#安装-gulp-作为开发时依赖项" class="sidebar-link" style="padding-left:3rem;">安装 gulp，作为开发时依赖项</a></li><li class="sidebar-sub-header"><a href="/es/project.html#创建-gulpfile-文件" class="sidebar-link" style="padding-left:3rem;">创建 gulpfile 文件</a></li><li class="sidebar-sub-header"><a href="/es/project.html#测试" class="sidebar-link" style="padding-left:3rem;">测试</a></li><li class="sidebar-sub-header"><a href="/es/project.html#gulp的组合任务" class="sidebar-link" style="padding-left:3rem;">gulp的组合任务</a></li><li class="sidebar-sub-header"><a href="/es/project.html#测试-2" class="sidebar-link" style="padding-left:3rem;">测试</a></li><li class="sidebar-sub-header"><a href="/es/project.html#gulp的异步任务" class="sidebar-link" style="padding-left:3rem;">gulp的异步任务</a></li><li class="sidebar-sub-header"><a href="/es/project.html#gulp的核心工作原理" class="sidebar-link">gulp的核心工作原理</a></li><li class="sidebar-sub-header"><a href="/es/project.html#gulp中关系文件的api" class="sidebar-link">gulp中关系文件的API</a></li><li class="sidebar-sub-header"><a href="/es/project.html#fis-fis3" class="sidebar-link" style="padding-left:3rem;">fis(fis3)</a></li></ul></li></ul></li><li><a href="/es/gulp-demo.html" class="sidebar-link">使用gulp构建一个web项目</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/es/gulp-demo.html#使用gulp构建一个web项目" class="sidebar-link">使用gulp构建一个web项目</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/es/gulp-demo.html#安装gulp的依赖" class="sidebar-link" style="padding-left:3rem;">安装gulp的依赖</a></li><li class="sidebar-sub-header"><a href="/es/gulp-demo.html#使用gulp-sass插件对样式文件做处理" class="sidebar-link" style="padding-left:3rem;">使用gulp-sass插件对样式文件做处理</a></li><li class="sidebar-sub-header"><a href="/es/gulp-demo.html#配置gulpfile-js文件" class="sidebar-link" style="padding-left:3rem;">配置gulpfile.js文件</a></li><li class="sidebar-sub-header"><a href="/es/gulp-demo.html#测试" class="sidebar-link" style="padding-left:3rem;">测试</a></li><li class="sidebar-sub-header"><a href="/es/gulp-demo.html#使用gulp-babel转换es语法-安装依赖" class="sidebar-link" style="padding-left:3rem;">使用gulp-babel转换ES语法，安装依赖</a></li><li class="sidebar-sub-header"><a href="/es/gulp-demo.html#在gulpfile-js中加入下面的内容" class="sidebar-link" style="padding-left:3rem;">在gulpfile.js中加入下面的内容</a></li><li class="sidebar-sub-header"><a href="/es/gulp-demo.html#测试-2" class="sidebar-link" style="padding-left:3rem;">测试</a></li><li class="sidebar-sub-header"><a href="/es/gulp-demo.html#使用gulp-swim处理html模版文件" class="sidebar-link" style="padding-left:3rem;">使用gulp-swim处理html模版文件</a></li><li class="sidebar-sub-header"><a href="/es/gulp-demo.html#安装gulp-swim的依赖" class="sidebar-link" style="padding-left:3rem;">安装gulp-swim的依赖</a></li><li class="sidebar-sub-header"><a href="/es/gulp-demo.html#修改gulpfile-js文件" class="sidebar-link" style="padding-left:3rem;">修改gulpfile.js文件</a></li><li class="sidebar-sub-header"><a href="/es/gulp-demo.html#测试-3" class="sidebar-link" style="padding-left:3rem;">测试</a></li><li class="sidebar-sub-header"><a href="/es/gulp-demo.html#让上面的三个任务同时执行" class="sidebar-link" style="padding-left:3rem;">让上面的三个任务同时执行</a></li><li class="sidebar-sub-header"><a href="/es/gulp-demo.html#测试-4" class="sidebar-link" style="padding-left:3rem;">测试</a></li><li class="sidebar-sub-header"><a href="/es/gulp-demo.html#处理图片和字体文件" class="sidebar-link" style="padding-left:3rem;">处理图片和字体文件</a></li><li class="sidebar-sub-header"><a href="/es/gulp-demo.html#复制public下的文件" class="sidebar-link" style="padding-left:3rem;">复制public下的文件</a></li><li class="sidebar-sub-header"><a href="/es/gulp-demo.html#清除dist目录下的文件" class="sidebar-link" style="padding-left:3rem;">清除dist目录下的文件</a></li><li class="sidebar-sub-header"><a href="/es/gulp-demo.html#自动加载插件" class="sidebar-link" style="padding-left:3rem;">自动加载插件</a></li><li class="sidebar-sub-header"><a href="/es/gulp-demo.html#构建一个开发服务器" class="sidebar-link" style="padding-left:3rem;">构建一个开发服务器</a></li><li class="sidebar-sub-header"><a href="/es/gulp-demo.html#处理生产环境的路径问题" class="sidebar-link" style="padding-left:3rem;">处理生产环境的路径问题</a></li><li class="sidebar-sub-header"><a href="/es/gulp-demo.html#删除gulpfile中不需要到处的任务" class="sidebar-link" style="padding-left:3rem;">删除gulpfile中不需要到处的任务</a></li><li class="sidebar-sub-header"><a href="/es/gulp-demo.html#自动化工作流的复用" class="sidebar-link" style="padding-left:3rem;">自动化工作流的复用</a></li><li class="sidebar-sub-header"><a href="/es/gulp-demo.html#工作流的封装" class="sidebar-link" style="padding-left:3rem;">工作流的封装</a></li><li class="sidebar-sub-header"><a href="/es/gulp-demo.html#发布我们的包到npm" class="sidebar-link" style="padding-left:3rem;">发布我们的包到npm</a></li><li class="sidebar-sub-header"><a href="/es/gulp-demo.html#在项目中使用我们发布的包" class="sidebar-link" style="padding-left:3rem;">在项目中使用我们发布的包</a></li></ul></li></ul></li><li><a href="/es/this.html" class="sidebar-link">this 的指向</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/es/module.html" class="sidebar-link">模块化的发展历程</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/es/webpack.html" class="sidebar-link">webpack</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/es/webpack2.html" class="sidebar-link">使用webpack去增强开发体验</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/es/rollup.html" class="sidebar-link">rollup</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/es/ruler.html" class="sidebar-link">前端规范化</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/es/webpack-source.html" class="sidebar-link">webpack源码分析</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/es/webpack3.html" class="sidebar-link">webpack和tapable</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/es/webpack4.html" class="sidebar-link">webpack的打包入口</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/es/webpack5.html" class="sidebar-link">手写 webpack源码</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/es/webpack6.html" class="sidebar-link">webpack源码分析（二）</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/es/webpack7.html" class="sidebar-link">处理模块依赖</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/es/debound.html" class="sidebar-link">防抖和节流</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/es/vue_router.html" class="sidebar-link">VueRouter</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/es/vue-observer.html" class="sidebar-link">Vue.js响应式原理</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/es/virtual-dom.html" aria-current="page" class="active sidebar-link">虚拟dom</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/es/vuejs-source.html" class="sidebar-link">Vue 源码解析 响应式原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#课程目标" class="sidebar-link">课程目标</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#准备工作" class="sidebar-link">准备工作</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#源码目录结构" class="sidebar-link">源码目录结构</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#了解-flow" class="sidebar-link">了解 Flow</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#调试设置" class="sidebar-link">调试设置</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#打包" class="sidebar-link" style="padding-left:3rem;">打包</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#调试" class="sidebar-link" style="padding-left:3rem;">调试</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#vue-的不同构建版本" class="sidebar-link">Vue 的不同构建版本</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#术语" class="sidebar-link" style="padding-left:3rem;">术语</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#runtime-compiler-vs-runtime-only" class="sidebar-link">Runtime + Compiler vs. Runtime-only</a></li></ul></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#寻找入口文件" class="sidebar-link">寻找入口文件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#执行构建" class="sidebar-link">执行构建</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#结果" class="sidebar-link">结果</a></li></ul></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#从入口开始" class="sidebar-link">从入口开始</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#通过查看源码解决下面问题" class="sidebar-link">通过查看源码解决下面问题</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#vue-的构造函数在哪里" class="sidebar-link">Vue 的构造函数在哪里</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#四个导出-vue-的模块" class="sidebar-link">四个导出 Vue 的模块</a></li></ul></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#vue-的初始化" class="sidebar-link">Vue 的初始化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#src-core-global-api-index-js" class="sidebar-link">src/core/global-api/index.js</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#src-core-instance-index-js" class="sidebar-link">src/core/instance/index.js</a></li></ul></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#首次渲染过程" class="sidebar-link">首次渲染过程</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#数据响应式原理" class="sidebar-link">数据响应式原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#通过查看源码解决下面问题-2" class="sidebar-link">通过查看源码解决下面问题</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#响应式处理的入口" class="sidebar-link">响应式处理的入口</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#observer" class="sidebar-link">Observer</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#definereactive" class="sidebar-link">defineReactive()</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#对象响应式处理" class="sidebar-link" style="padding-left:3rem;">对象响应式处理</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#数组的响应式处理" class="sidebar-link" style="padding-left:3rem;">数组的响应式处理</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#dep-类" class="sidebar-link">Dep 类</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#watcher-类" class="sidebar-link">Watcher 类</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#调试响应式数据执行过程" class="sidebar-link">调试响应式数据执行过程</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#回答以下问题" class="sidebar-link">回答以下问题</a></li></ul></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#实例方法-数据" class="sidebar-link">实例方法/数据</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#vm-set" class="sidebar-link">vm.\$set</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#定义位置" class="sidebar-link" style="padding-left:3rem;">定义位置</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#源码" class="sidebar-link" style="padding-left:3rem;">源码</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#调试-2" class="sidebar-link" style="padding-left:3rem;">调试</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#vm-delete" class="sidebar-link">vm.\$delete</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#定义位置-2" class="sidebar-link" style="padding-left:3rem;">定义位置</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#源码-2" class="sidebar-link" style="padding-left:3rem;">源码</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#vm-watch" class="sidebar-link">vm.\$watch</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#三种类型的-watcher-对象" class="sidebar-link" style="padding-left:3rem;">三种类型的 Watcher 对象</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#源码-3" class="sidebar-link" style="padding-left:3rem;">源码</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#调试-3" class="sidebar-link" style="padding-left:3rem;">调试</a></li></ul></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#异步更新队列-nexttick" class="sidebar-link">异步更新队列-nextTick()</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#vm-nexttick-代码演示" class="sidebar-link">vm.\$nextTick() 代码演示</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#定义位置-3" class="sidebar-link">定义位置</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#源码-4" class="sidebar-link">源码</a></li></ul></li></ul></li><li><a href="/es/bind.html" class="sidebar-link">Function.prototype.bind()</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/es/circleDep.html" class="sidebar-link">循环依赖</a><ul class="sidebar-sub-headers"></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h4 id="虚拟dom"><a href="#虚拟dom" class="header-anchor">#</a> 虚拟dom</h4> <h5 id="什么是虚拟dom"><a href="#什么是虚拟dom" class="header-anchor">#</a> 什么是虚拟dom</h5> <ul><li>真实的<code>dom</code> <ul><li><code>document.querySelector(&quot;#app&quot;)</code></li> <li>真实的<code>dom</code>上会存在很多的属性和方法</li></ul></li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> el <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#app&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">undefined</span>
<span class="token keyword">let</span> s <span class="token operator">=</span><span class="token string">&quot;&quot;</span>
<span class="token keyword">undefined</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> el<span class="token punctuation">)</span><span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> s<span class="token operator">+=</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,</span><span class="token template-punctuation string">`</span></span>  <span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token comment">// 输出一个很长的字符串</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ul><li>虚拟<code>dom</code> <ul><li>虚拟<code>dom</code>本质上是用一个<code>JavaScript</code>对象来描述真实的<code>dom</code>对象</li></ul></li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
  sel<span class="token operator">:</span><span class="token string">'div'</span><span class="token punctuation">,</span>
  data<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  children<span class="token operator">:</span><span class="token keyword">undefined</span><span class="token punctuation">,</span>
  text<span class="token operator">:</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">,</span>
  ele<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
  key<span class="token operator">:</span> <span class="token keyword">undefined</span>  
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ul><li>所以创建一个虚拟<code>dom</code>比创建一个真实的<code>dom</code>的成本要小</li></ul> <h5 id="为什么需要虚拟dom"><a href="#为什么需要虚拟dom" class="header-anchor">#</a> 为什么需要虚拟<code>dom</code></h5> <p>前端开发的过程：</p> <ul><li>使用<code>js</code>操作<code>dom</code>和数据来维护视图，需要考虑兼容性问题</li> <li>使用<code>jQuery</code>操作<code>dom</code>和数据来维护视图,解决浏览器兼容性的问题</li> <li>MVVM框架的出现解决了视图和状态同步的问题</li> <li>MVVM框架本质上是基于模版引擎的，如果没有虚拟<code>dom</code>,没法跟踪状态(每次状态变化都要销毁重新渲染)</li> <li>参考<code>github</code>上的<code>virtual-dom</code>的动机描述：
<ul><li>虚拟<code>dom</code>可以维护程序的状态，跟踪上一次的状态</li> <li>通过比较前后两次状态差异更新真实<code>dom</code></li></ul></li></ul> <h5 id="虚拟dom的作用"><a href="#虚拟dom的作用" class="header-anchor">#</a> 虚拟<code>dom</code>的作用</h5> <ul><li>维护视图和状态的关系</li> <li>复杂的情况下可以提高渲染性能(简单情况下初次渲染因为需要创建虚拟<code>dom</code>会更慢)</li> <li>跨平台
<ul><li>浏览器端渲染<code>dom</code></li> <li>服务器端渲染<code>ssr</code>(<code>Nuxt.js</code>和<code>Next.js</code>)</li> <li>原生应用(<code>Weex</code>,<code>RN</code>)</li> <li>小程序(<code>mpvue</code>和<code>uni-app</code>)</li></ul></li></ul> <h5 id="虚拟dom库"><a href="#虚拟dom库" class="header-anchor">#</a> 虚拟<code>dom</code>库</h5> <ul><li><code>Snabbdom</code> <ul><li><code>Vue2.X</code>内部的虚拟<code>dom</code>是改良的<code>Snabbdom</code></li> <li>核心代码大约200行</li> <li>通过模块可扩展</li> <li>源码使用<code>TypeScript</code>开发</li> <li>最快的虚拟<code>dom</code>之一</li> <li><a href="https://github.com/snabbdom/snabbdom" target="_blank" rel="noopener noreferrer">文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li> <li><code>virtual-dom</code></li></ul> <h5 id="使用虚拟dom"><a href="#使用虚拟dom" class="header-anchor">#</a> 使用虚拟dom</h5> <p>我们首先创建一个项目</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">mkdir</span> snabbdom-demo <span class="token operator">&amp;</span> <span class="token builtin class-name">cd</span> snabbdom-demo

<span class="token function">npm</span> init -y
<span class="token comment"># 使用parcel作为打包工具</span>
<span class="token function">npm</span> <span class="token function">install</span> parcel-bundler -D
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>添加构建的命令在<code>package.json</code>中：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;dev&quot;</span><span class="token operator">:</span> <span class="token string">&quot;parcel index.html --open&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;build&quot;</span><span class="token operator">:</span><span class="token string">&quot;parcel build index.html&quot;</span>
 <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>项目结构：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>├── index.html
├── package-lock.json
├── package.json
└── src
    └── 01-basicusage.js
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><code>inde.html</code></p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>X-UA-Compatible<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>IE=edge<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Document<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>app<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./src/01-basicusage.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>导入<code>snabbdom</code></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">npm</span> <span class="token function">install</span> snabbdom@2.1.0
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>使用parcel的自动导包功能，我们无须自己手动安装依赖，这里是为了指定版本。</p></div> <p><code>01-basicusage.js</code>导入</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> h <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;snabbdom/h&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> init <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;snabbdom/init&quot;</span><span class="token punctuation">;</span>  

<span class="token keyword">const</span> patch <span class="token operator">=</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p><code>h</code>函数是用来创建虚拟<code>dom</code>的，而<code>patch</code>函数是将虚拟<code>dom</code>转化成真实的<code>dom</code>的函数</p></div> <p>运行保错：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ <span class="token function">npm</span> run dev

<span class="token operator">&gt;</span> snabbdom-demo@1.0.0 dev /Users/lijunjie/js-code/virtual-dom/snabbdom-demo
<span class="token operator">&gt;</span> parcel index.html --open

Server running at http://localhost:1234 
🚨  /Users/lijunjie/js-code/virtual-dom/snabbdom-demo/src/01-basicusage.js:10:21: Cannot resolve dependency <span class="token string">'snabbdom/init'</span>
   <span class="token number">8</span> <span class="token operator">|</span>  */
   <span class="token number">9</span> <span class="token operator">|</span> <span class="token function">import</span> <span class="token punctuation">{</span> h <span class="token punctuation">}</span> from <span class="token string">&quot;snabbdom/h&quot;</span><span class="token punctuation">;</span>
<span class="token operator">&gt;</span> <span class="token number">10</span> <span class="token operator">|</span> <span class="token function">import</span> <span class="token punctuation">{</span> init <span class="token punctuation">}</span> from <span class="token string">&quot;snabbdom/init&quot;</span><span class="token punctuation">;</span>  
     <span class="token operator">|</span>                     ^
  <span class="token number">11</span> <span class="token operator">|</span>
  <span class="token number">12</span> <span class="token operator">|</span> const patch <span class="token operator">=</span> init<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>查看<code>snabbdom</code>包，会发现我们的<code>h</code>和<code>init</code>都在<code>/build/package</code>下:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  <span class="token string">&quot;exports&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;./init&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./build/package/init.js&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;./h&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./build/package/h.js&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;./helpers/attachto&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./build/package/helpers/attachto.js&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;./hooks&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./build/package/hooks.js&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;./htmldomapi&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./build/package/htmldomapi.js&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;./is&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./build/package/is.js&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;./jsx&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./build/package/jsx.js&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;./modules/attributes&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./build/package/modules/attributes.js&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;./modules/class&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./build/package/modules/class.js&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;./modules/dataset&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./build/package/modules/dataset.js&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;./modules/eventlisteners&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./build/package/modules/eventlisteners.js&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;./modules/hero&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./build/package/modules/hero.js&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;./modules/module&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./build/package/modules/module.js&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;./modules/props&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./build/package/modules/props.js&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;./modules/style&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./build/package/modules/style.js&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;./thunk&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./build/package/thunk.js&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;./tovnode&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./build/package/tovnode.js&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;./vnode&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./build/package/vnode.js&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p><code>exports</code>是<code>node12.x</code>开始支持的，<code>webpack4.x</code>和<code>parcel</code>并不能识别该字段，我们需要使用完整路径来导入。</p></div> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> h <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;snabbdom/build/package/h&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> init <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;snabbdom/build/package/init&quot;</span><span class="token punctuation">;</span>  

<span class="token keyword">const</span> patch <span class="token operator">=</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>修改代码去使用这两个函数：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> h <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;snabbdom/build/package/h&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> init <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;snabbdom/build/package/init&quot;</span><span class="token punctuation">;</span>  

<span class="token keyword">const</span> patch <span class="token operator">=</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 第一个参数是元素的标签和选择器</span>
<span class="token comment">// 第二个参数是元素的内容</span>
<span class="token keyword">const</span> vNode <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&quot;div#container.test&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Hello world&quot;</span><span class="token punctuation">)</span> 


<span class="token comment">// 第一个参数可以是旧的vNode，也可以是真实dom</span>
<span class="token comment">// 第一个参数是新vNode</span>
<span class="token comment">// 返回值是的新的vNode</span>

<span class="token keyword">const</span> el <span class="token operator">=</span>  document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#app&quot;</span><span class="token punctuation">)</span>
<span class="token comment">// 为下一次更新去使用</span>
<span class="token keyword">const</span> oldVnode <span class="token operator">=</span> <span class="token function">patch</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span>vNode<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>获取将页面的元素替换成</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>container<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>test<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Hello world<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> h <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;snabbdom/build/package/h&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> init <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;snabbdom/build/package/init&quot;</span><span class="token punctuation">;</span>  

<span class="token keyword">const</span> patch <span class="token operator">=</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 第一个参数是元素的标签和选择器</span>
<span class="token comment">// 第二个参数是元素的内容</span>
<span class="token keyword">const</span> vNode <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&quot;div#container.test&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Hello world&quot;</span><span class="token punctuation">)</span> 


<span class="token comment">// 第一个参数可以是旧的vNode，也可以是真实dom</span>
<span class="token comment">// 第二个参数是新vNode</span>
<span class="token comment">// 返回值是的新的vNode</span>

<span class="token keyword">const</span> el <span class="token operator">=</span>  document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#app&quot;</span><span class="token punctuation">)</span>
<span class="token comment">// 为下一次更新去使用</span>
<span class="token keyword">const</span> oldVnode <span class="token operator">=</span> <span class="token function">patch</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span>vNode<span class="token punctuation">)</span>

<span class="token comment">// 继续更新节点</span>

<span class="token function">patch</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&quot;div.xxx&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Hello,Snabbsom&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>更新后的<code>dom</code>元素</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;xxx&quot;</span><span class="token operator">&gt;</span>Hello<span class="token punctuation">,</span>Snabbsom<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>h</code>函数的第二个参数还可以是子元素的数组，这些子元素可以是<code>vNode</code>:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> h <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;snabbdom/build/package/h&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> init <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;snabbdom/build/package/init&quot;</span><span class="token punctuation">;</span>  

<span class="token keyword">const</span> patch <span class="token operator">=</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 第一个参数是元素的标签和选择器</span>
<span class="token comment">// 第二个参数可以是子元素</span>
<span class="token keyword">const</span> vNode <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&quot;div#container.test&quot;</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&quot;p&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;helo snabbdom&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&quot;h1&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;------&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 

<span class="token keyword">const</span> el <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> oldVnode <span class="token operator">=</span> <span class="token function">patch</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span>vNode<span class="token punctuation">)</span>


<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> vNode <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&quot;div#container.test&quot;</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&quot;p&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;helo world&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&quot;h1&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;zzzzz&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
    <span class="token function">patch</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span>vNode<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">2000</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p><code>h</code>函数可以接受一个<code>!</code>作为参数，这样子可以创建一个注释节点：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> h <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;snabbdom/build/package/h&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> init <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;snabbdom/build/package/init&quot;</span><span class="token punctuation">;</span>  

<span class="token keyword">const</span> patch <span class="token operator">=</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 第一个参数是元素的标签和选择器</span>
<span class="token comment">// 第二个参数可以是子元素</span>
<span class="token keyword">const</span> vNode <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&quot;div#container.test&quot;</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&quot;p&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;helo snabbdom&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&quot;h1&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;------&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 

<span class="token keyword">const</span> el <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> oldVnode <span class="token operator">=</span> <span class="token function">patch</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span>vNode<span class="token punctuation">)</span>


<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token comment">// const vNode = h(&quot;div#container.test&quot;,[h(&quot;p&quot;,&quot;helo world&quot;),h(&quot;h1&quot;,&quot;zzzzz&quot;)]) </span>
    <span class="token comment">// patch(oldVnode,vNode)</span>
    <span class="token comment">// 替换成空的注释节点</span>
    <span class="token function">patch</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&quot;!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">2000</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p><code>2s</code>后元素的内容被替换成一个空注释：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token comment">&lt;!----&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h5 id="snabbdom的模块"><a href="#snabbdom的模块" class="header-anchor">#</a> snabbdom的模块</h5> <ul><li><code>snabbdom</code>的作用
<ul><li><code>snabbdom</code>核心库并不能处理<code>dom</code>元素的属性、样式和事件等。可以通过注册<code>snabbdom</code>默认提供的模块来实现</li> <li><code>snabbdom</code>中的模块可以用来扩展<code>snabbdom</code>的功能</li> <li><code>snabbdom</code>中的模块是通过注册全局的钩子函数来实现的</li></ul></li> <li>官方提供的模块
<ul><li><code>attributes</code>:使用<code>setAttribute/removeAttribute</code>等标准<code>api</code>来设置<code>dom</code>的属性，支持<code>boolean</code>类型的属性</li> <li><code>props</code>通过给<code>dom</code>对象添加属性来实现的，不支持<code>boolean</code>类型的属性</li> <li><code>dataset</code>是用来给<code>dom</code>元素设置自定义属性(data-*)的.</li> <li><code>style</code>使用来给元素添加行内样式，且可以添加过渡动画</li> <li><code>class</code>可以元素添加便于切换的样式</li> <li><code>eventlisteners</code>给元素绑定事件</li></ul></li> <li><code>snabbdom</code>的使用
<ul><li>导入需要使用的模块</li> <li><code>init</code>函数中注册模块</li> <li><code>h</code>函数的第二个参数处使用模块</li></ul></li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> h <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;snabbdom/build/package/h&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> init <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;snabbdom/build/package/init&quot;</span><span class="token punctuation">;</span>  
<span class="token keyword">import</span> <span class="token punctuation">{</span> styleModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;snabbdom/build/package/modules/style&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> eventListenersModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;snabbdom/build/package/modules/eventlisteners&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> patch <span class="token operator">=</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">[</span>styleModule<span class="token punctuation">,</span>eventListenersModule<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 第一个参数是元素的标签和选择器</span>
<span class="token comment">// 第三个参数可以是子元素</span>
<span class="token keyword">const</span> vNode <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&quot;div#container.test&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> style<span class="token operator">:</span> <span class="token punctuation">{</span> color<span class="token operator">:</span> <span class="token string">'red'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>on<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token function-variable function">click</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;hello world&quot;</span><span class="token punctuation">)</span> 

<span class="token keyword">const</span> el <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> oldVnode <span class="token operator">=</span> <span class="token function">patch</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span>vNode<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>生成的真实<code>dom</code>:</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>container<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>test<span class="token punctuation">&quot;</span></span><span class="token style-attr language-css"><span class="token attr-name"> <span class="token attr-name">style</span></span><span class="token punctuation">=&quot;</span><span class="token attr-value"><span class="token property">color</span><span class="token punctuation">:</span> red<span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>hello world<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>元素上有一个点击事件，这里没有体现。</p> <h5 id="如何学习源码"><a href="#如何学习源码" class="header-anchor">#</a> 如何学习源码</h5> <ul><li>宏观了解</li> <li>带着目标看源码</li> <li>看源码的过程要不求甚解</li> <li>调试</li> <li>参考资料</li></ul> <h5 id="snabbdom的核心"><a href="#snabbdom的核心" class="header-anchor">#</a> snabbdom的核心</h5> <ul><li>使用<code>init</code>设置模块，创建<code>patch</code>函数</li> <li>使用<code>h</code>函数创建虚拟<code>VNode</code></li> <li>使用<code>patch</code>函数比较两个新旧虚拟<code>dom</code>,将变化的内容更新成真实<code>dom</code> <ul><li>当<code>patch</code>函数的第一个参数不是虚拟<code>dom</code>时，会将它转成虚拟<code>dom</code></li></ul></li></ul> <h5 id="snabbdom源码"><a href="#snabbdom源码" class="header-anchor">#</a> snabbdom源码</h5> <ul><li>源码地址
<ul><li><a href="https://github.com/snabbdom/snabbdom" target="_blank" rel="noopener noreferrer">github地址<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>当前版本[v3.0.3]</li></ul></li> <li>克隆代码
<ul><li><code>git clone -b v2.1.0 --depth 1 https://github.com/snabbdom/snabbdom.git</code></li> <li>我们没有拉取最新的版本</li> <li><code>-b &lt;name&gt;, --branch &lt;name&gt;</code>,<code>--depth &lt;depth&gt;</code>指定我们克隆的深度，这里只克隆最近的提交</li></ul></li></ul> <h5 id="snabbdom的项目结构"><a href="#snabbdom的项目结构" class="header-anchor">#</a> <code>snabbdom的项目结构</code></h5> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>snabbdom
├── examples  //使用例子
│   ├── carousel-svg
│   ├── hero
│   ├── reorder-animation
│   └── svg
├── perf //性能测试
└── src	// 源码
    ├── package
    └── <span class="token builtin class-name">test</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>我们先来看<code>reorder-animation</code>(带有动画的列表)这个例子：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>snabbdom/examples
├── carousel-svg
│   ├── README.md
│   ├── index.html
│   └── index.js
├── hero
│   ├── index.html
│   └── index.js
├── reorder-animation
│   ├── index.html
│   └── index.js
└── svg
    ├── index.html
    └── index.js
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p><code>index.js</code>:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> init <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../../build/package/init.js'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> classModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../../build/package/modules/class.js'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> propsModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../../build/package/modules/props.js'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> styleModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../../build/package/modules/style.js'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> eventListenersModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../../build/package/modules/eventlisteners.js'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> h <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../../build/package/h.js'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>例子中使用的依赖时从<code>snabbdom/build</code>中获取的，我们需要去手动编译</p> <p><code>snabbdom/package.json</code>:</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;mark-pr-head-as-trusted&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node --unhandled-rejections=strict mark-pr-head-as-trusted.cjs&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;docs&quot;</span><span class="token operator">:</span> <span class="token string">&quot;remark . --output&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;check-clean&quot;</span><span class="token operator">:</span> <span class="token string">&quot;git diff --exit-code&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;lint:js&quot;</span><span class="token operator">:</span> <span class="token string">&quot;eslint --ext .ts,.tsx,.cjs,.md,.mjs --ignore-path .gitignore .&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;lint:editorconfig&quot;</span><span class="token operator">:</span> <span class="token string">&quot;editorconfig-checker&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;lint&quot;</span><span class="token operator">:</span> <span class="token string">&quot;run-s lint:editorconfig lint:js&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;unit&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cross-env FILES_PATTERN=\&quot;test-bundles/unit/**/*.js\&quot; karma start karma.conf.cjs&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;benchmark&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cross-env FILES_PATTERN=\&quot;test-bundles/benchmark/**/*.js\&quot; karma start karma.conf.cjs --concurrency=1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;make-release-commit&quot;</span><span class="token operator">:</span> <span class="token string">&quot;standard-version&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;test&quot;</span><span class="token operator">:</span> <span class="token string">&quot;run-s lint compile bundle-tests unit&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;compile&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ttsc --build src/test/tsconfig.json&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;bundle-tests&quot;</span><span class="token operator">:</span> <span class="token string">&quot;webpack --config tests.webpack.config.cjs&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;prepublishOnly&quot;</span><span class="token operator">:</span> <span class="token string">&quot;npm run compile&quot;</span>
 <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token builtin class-name">cd</span> snabbdom
<span class="token function">npm</span> <span class="token function">install</span>
<span class="token function">npm</span> run compile
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>编译完成后会生成一个<code>build</code>文件：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">.</span>
├── build
├── examples
├── node_modules
├── perf
└── src
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>然后打开这个例子：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token builtin class-name">cd</span> snabbdom 
serve <span class="token builtin class-name">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>然后在浏览器中找到<code>example/reorder-animation</code>：</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p><code>serve</code>可以让我们快速创建一个<code>http</code>服务,需要<code>npm install -g serve</code>去安装</p></div> <p>例子中的删除和排序有问题：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>
<span class="token keyword">function</span> <span class="token function">remove</span> <span class="token punctuation">(</span><span class="token parameter">movie</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  data <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">m</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> m <span class="token operator">!==</span> movie
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">movieView</span> <span class="token punctuation">(</span><span class="token parameter">movie</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div.row'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    key<span class="token operator">:</span> movie<span class="token punctuation">.</span>rank<span class="token punctuation">,</span>
    style<span class="token operator">:</span> <span class="token punctuation">{</span>
      opacity<span class="token operator">:</span> <span class="token string">'0'</span><span class="token punctuation">,</span>
      transform<span class="token operator">:</span> <span class="token string">'translate(-200px)'</span><span class="token punctuation">,</span>
      delayed<span class="token operator">:</span> <span class="token punctuation">{</span> transform<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">translateY(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>movie<span class="token punctuation">.</span>offset<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> opacity<span class="token operator">:</span> <span class="token string">'1'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      remove<span class="token operator">:</span> <span class="token punctuation">{</span> opacity<span class="token operator">:</span> <span class="token string">'0'</span><span class="token punctuation">,</span> transform<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">translateY(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>movie<span class="token punctuation">.</span>offset<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px) translateX(200px)</span><span class="token template-punctuation string">`</span></span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    hook<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token function-variable function">insert</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">vnode</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> movie<span class="token punctuation">.</span>elmHeight <span class="token operator">=</span> vnode<span class="token punctuation">.</span>elm<span class="token punctuation">.</span>offsetHeight <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> style<span class="token operator">:</span> <span class="token punctuation">{</span> fontWeight<span class="token operator">:</span> <span class="token string">'bold'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> movie<span class="token punctuation">.</span>rank<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> movie<span class="token punctuation">.</span>title<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> movie<span class="token punctuation">.</span>desc<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div.btn.rm-btn'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> on<span class="token operator">:</span> <span class="token punctuation">{</span> click<span class="token operator">:</span> <span class="token punctuation">[</span>remove<span class="token punctuation">,</span> movie<span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'x'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code>
<span class="token keyword">function</span> <span class="token function">changeSort</span> <span class="token punctuation">(</span><span class="token parameter">prop</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  sortBy <span class="token operator">=</span> prop
  data<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">[</span>prop<span class="token punctuation">]</span> <span class="token operator">&gt;</span> b<span class="token punctuation">[</span>prop<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">[</span>prop<span class="token punctuation">]</span> <span class="token operator">&lt;</span> b<span class="token punctuation">[</span>prop<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token operator">...</span>
<span class="token keyword">function</span> <span class="token function">view</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'h1'</span><span class="token punctuation">,</span> <span class="token string">'Top 10 movies'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
      <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'a.btn.add'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> on<span class="token operator">:</span> <span class="token punctuation">{</span> click<span class="token operator">:</span> add <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'Add'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token string">'Sort by: '</span><span class="token punctuation">,</span>
      <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span.btn-group'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
        <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'a.btn.rank'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token punctuation">{</span> active<span class="token operator">:</span> sortBy <span class="token operator">===</span> <span class="token string">'rank'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> on<span class="token operator">:</span> <span class="token punctuation">{</span> click<span class="token operator">:</span> <span class="token punctuation">[</span>changeSort<span class="token punctuation">,</span> <span class="token string">'rank'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'Rank'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'a.btn.title'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token punctuation">{</span> active<span class="token operator">:</span> sortBy <span class="token operator">===</span> <span class="token string">'title'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> on<span class="token operator">:</span> <span class="token punctuation">{</span> click<span class="token operator">:</span> <span class="token punctuation">[</span>changeSort<span class="token punctuation">,</span> <span class="token string">'title'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'Title'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'a.btn.desc'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token punctuation">{</span> active<span class="token operator">:</span> sortBy <span class="token operator">===</span> <span class="token string">'desc'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> on<span class="token operator">:</span> <span class="token punctuation">{</span> click<span class="token operator">:</span> <span class="token punctuation">[</span>changeSort<span class="token punctuation">,</span> <span class="token string">'desc'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'Description'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div.list'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> style<span class="token operator">:</span> <span class="token punctuation">{</span> height<span class="token operator">:</span> totalHeight <span class="token operator">+</span> <span class="token string">'px'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>movieView<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>原因是高版本中不支持这种方式绑定事件：我们可以修改成：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>
<span class="token keyword">function</span> <span class="token function">view</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'h1'</span><span class="token punctuation">,</span> <span class="token string">'Top 10 movies'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
      <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'a.btn.add'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> on<span class="token operator">:</span> <span class="token punctuation">{</span> click<span class="token operator">:</span> add <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'Add'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token string">'Sort by: '</span><span class="token punctuation">,</span>
      <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span.btn-group'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
        <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'a.btn.rank'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token punctuation">{</span> active<span class="token operator">:</span> sortBy <span class="token operator">===</span> <span class="token string">'rank'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> on<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token function-variable function">click</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token function">changeSort</span><span class="token punctuation">(</span><span class="token string">'rank'</span><span class="token punctuation">)</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'Rank'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'a.btn.title'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token punctuation">{</span> active<span class="token operator">:</span> sortBy <span class="token operator">===</span> <span class="token string">'title'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> on<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token function-variable function">click</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token function">changeSort</span><span class="token punctuation">(</span><span class="token string">'title'</span><span class="token punctuation">)</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'Title'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'a.btn.desc'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token punctuation">{</span> active<span class="token operator">:</span> sortBy <span class="token operator">===</span> <span class="token string">'desc'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> on<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token function-variable function">click</span><span class="token operator">:</span>  <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token function">changeSort</span><span class="token punctuation">(</span><span class="token string">'desc'</span><span class="token punctuation">)</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'Description'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div.list'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> style<span class="token operator">:</span> <span class="token punctuation">{</span> height<span class="token operator">:</span> totalHeight <span class="token operator">+</span> <span class="token string">'px'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>movieView<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>


<span class="token keyword">function</span> <span class="token function">movieView</span> <span class="token punctuation">(</span><span class="token parameter">movie</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div.row'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    key<span class="token operator">:</span> movie<span class="token punctuation">.</span>rank<span class="token punctuation">,</span>
    style<span class="token operator">:</span> <span class="token punctuation">{</span>
      opacity<span class="token operator">:</span> <span class="token string">'0'</span><span class="token punctuation">,</span>
      transform<span class="token operator">:</span> <span class="token string">'translate(-200px)'</span><span class="token punctuation">,</span>
      delayed<span class="token operator">:</span> <span class="token punctuation">{</span> transform<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">translateY(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>movie<span class="token punctuation">.</span>offset<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> opacity<span class="token operator">:</span> <span class="token string">'1'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      remove<span class="token operator">:</span> <span class="token punctuation">{</span> opacity<span class="token operator">:</span> <span class="token string">'0'</span><span class="token punctuation">,</span> transform<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">translateY(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>movie<span class="token punctuation">.</span>offset<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px) translateX(200px)</span><span class="token template-punctuation string">`</span></span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    hook<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token function-variable function">insert</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">vnode</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> movie<span class="token punctuation">.</span>elmHeight <span class="token operator">=</span> vnode<span class="token punctuation">.</span>elm<span class="token punctuation">.</span>offsetHeight <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> style<span class="token operator">:</span> <span class="token punctuation">{</span> fontWeight<span class="token operator">:</span> <span class="token string">'bold'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> movie<span class="token punctuation">.</span>rank<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> movie<span class="token punctuation">.</span>title<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> movie<span class="token punctuation">.</span>desc<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div.btn.rm-btn'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> on<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token function-variable function">click</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token function">remove</span><span class="token punctuation">(</span>movie<span class="token punctuation">)</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'x'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p><code>src</code>/package/*下的内容：</p> <div class="language-shel line-numbers-mode"><pre class="language-text"><code>$ tree snabbdom/src/package 
snabbdom/src/package
├── h.ts  //创建虚拟dom的函数
├── helpers
│   └── attachto.ts
├── hooks.ts
├── htmldomapi.ts
├── init.ts //注册模块，返回patch函数
├── is.ts
├── jsx-global.ts
├── jsx.ts
├── modules // 内置模块和自定义模块
│   ├── attributes.ts
│   ├── class.ts
│   ├── dataset.ts
│   ├── eventlisteners.ts
│   ├── hero.ts //自定义的模块
│   ├── module.ts
│   ├── props.ts
│   └── style.ts
├── thunk.ts
├── tovnode.ts
├── ts-transform-js-extension.cjs
├── tsconfig.json
└── vnode.ts //h中生成虚拟dom时具体调用的方法
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><ul><li><code>h</code>函数
<ul><li>定义在<code>h.ts</code>中</li> <li>处理传入的参数然后创建<code>VNode</code>对象</li> <li>函数的定义用到了函数的重载(函数名称相同但是参数类型或者个数不同)</li></ul></li></ul> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">h</span> <span class="token punctuation">(</span><span class="token parameter">sel<span class="token operator">:</span> string</span><span class="token punctuation">)</span><span class="token operator">:</span> VNode
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">h</span> <span class="token punctuation">(</span><span class="token parameter">sel<span class="token operator">:</span> string<span class="token punctuation">,</span> data<span class="token operator">:</span> VNodeData <span class="token operator">|</span> <span class="token keyword">null</span></span><span class="token punctuation">)</span><span class="token operator">:</span> VNode
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">h</span> <span class="token punctuation">(</span><span class="token parameter">sel<span class="token operator">:</span> string<span class="token punctuation">,</span> children<span class="token operator">:</span> VNodeChildren</span><span class="token punctuation">)</span><span class="token operator">:</span> VNode
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">h</span> <span class="token punctuation">(</span><span class="token parameter">sel<span class="token operator">:</span> string<span class="token punctuation">,</span> data<span class="token operator">:</span> VNodeData <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span> children<span class="token operator">:</span> VNodeChildren</span><span class="token punctuation">)</span><span class="token operator">:</span> VNode
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">h</span> <span class="token punctuation">(</span><span class="token parameter">sel<span class="token operator">:</span> any<span class="token punctuation">,</span> b<span class="token operator">?</span><span class="token operator">:</span> any<span class="token punctuation">,</span> c<span class="token operator">?</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span><span class="token operator">:</span> VNode <span class="token punctuation">{</span>
  <span class="token keyword">var</span> data<span class="token operator">:</span> VNodeData <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">var</span> children<span class="token operator">:</span> <span class="token builtin">any</span>
  <span class="token keyword">var</span> text<span class="token operator">:</span> <span class="token builtin">any</span>
  <span class="token keyword">var</span> i<span class="token operator">:</span> <span class="token builtin">number</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>b <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      data <span class="token operator">=</span> b
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">is</span><span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      children <span class="token operator">=</span> c
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">is</span><span class="token punctuation">.</span><span class="token function">primitive</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      text <span class="token operator">=</span> c
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">&amp;&amp;</span> c<span class="token punctuation">.</span>sel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      children <span class="token operator">=</span> <span class="token punctuation">[</span>c<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>b <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">&amp;&amp;</span> b <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">is</span><span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      children <span class="token operator">=</span> b
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">is</span><span class="token punctuation">.</span><span class="token function">primitive</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      text <span class="token operator">=</span> b
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>b <span class="token operator">&amp;&amp;</span> b<span class="token punctuation">.</span>sel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      children <span class="token operator">=</span> <span class="token punctuation">[</span>b<span class="token punctuation">]</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> data <span class="token operator">=</span> b <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>children <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">is</span><span class="token punctuation">.</span><span class="token function">primitive</span><span class="token punctuation">(</span>children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> children<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">vnode</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    sel<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'s'</span> <span class="token operator">&amp;&amp;</span> sel<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'v'</span> <span class="token operator">&amp;&amp;</span> sel<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'g'</span> <span class="token operator">&amp;&amp;</span>
    <span class="token punctuation">(</span>sel<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">3</span> <span class="token operator">||</span> sel<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'.'</span> <span class="token operator">||</span> sel<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'#'</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">addNS</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> children<span class="token punctuation">,</span> sel<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">vnode</span><span class="token punctuation">(</span>sel<span class="token punctuation">,</span> data<span class="token punctuation">,</span> children<span class="token punctuation">,</span> text<span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><ul><li>vnode函数
<ul><li>定义在<code>vnode.ts</code>中</li> <li>接受参数去创建<code>vnode</code>对象</li></ul></li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Hooks <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./hooks'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AttachData <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./helpers/attachto'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> VNodeStyle <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./modules/style'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> On <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./modules/eventlisteners'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Attrs <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./modules/attributes'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Classes <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./modules/class'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Props <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./modules/props'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Dataset <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./modules/dataset'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Hero <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./modules/hero'</span>

<span class="token keyword">export</span> type Key <span class="token operator">=</span> string <span class="token operator">|</span> number

<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">VNode</span> <span class="token punctuation">{</span>
  sel<span class="token operator">:</span> string <span class="token operator">|</span> <span class="token keyword">undefined</span>
  data<span class="token operator">:</span> VNodeData <span class="token operator">|</span> <span class="token keyword">undefined</span>
  children<span class="token operator">:</span> Array<span class="token operator">&lt;</span>VNode <span class="token operator">|</span> string<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">undefined</span>
  elm<span class="token operator">:</span> Node <span class="token operator">|</span> <span class="token keyword">undefined</span>
  text<span class="token operator">:</span> string <span class="token operator">|</span> <span class="token keyword">undefined</span>
  key<span class="token operator">:</span> Key <span class="token operator">|</span> <span class="token keyword">undefined</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">VNodeData</span> <span class="token punctuation">{</span>
  props<span class="token operator">?</span><span class="token operator">:</span> Props
  attrs<span class="token operator">?</span><span class="token operator">:</span> Attrs
  <span class="token keyword">class</span><span class="token operator">?</span><span class="token operator">:</span> Classes
  style<span class="token operator">?</span><span class="token operator">:</span> VNodeStyle
  dataset<span class="token operator">?</span><span class="token operator">:</span> Dataset
  on<span class="token operator">?</span><span class="token operator">:</span> On
  hero<span class="token operator">?</span><span class="token operator">:</span> Hero
  attachData<span class="token operator">?</span><span class="token operator">:</span> AttachData
  hook<span class="token operator">?</span><span class="token operator">:</span> Hooks
  key<span class="token operator">?</span><span class="token operator">:</span> Key
  ns<span class="token operator">?</span><span class="token operator">:</span> string <span class="token comment">// for SVGs</span>
  fn<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> VNode <span class="token comment">// for thunks</span>
  args<span class="token operator">?</span><span class="token operator">:</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// for thunks</span>
  <span class="token punctuation">[</span>key<span class="token operator">:</span> string<span class="token punctuation">]</span><span class="token operator">:</span> any <span class="token comment">// for any other 3rd party module</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">vnode</span> <span class="token punctuation">(</span><span class="token parameter">sel<span class="token operator">:</span> string <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
  data<span class="token operator">:</span> any <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
  children<span class="token operator">:</span> Array<span class="token operator">&lt;</span>VNode <span class="token operator">|</span> string<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
  text<span class="token operator">:</span> string <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
  elm<span class="token operator">:</span> Element <span class="token operator">|</span> Text <span class="token operator">|</span> <span class="token keyword">undefined</span></span><span class="token punctuation">)</span><span class="token operator">:</span> VNode <span class="token punctuation">{</span>
  <span class="token keyword">const</span> key <span class="token operator">=</span> data <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> <span class="token keyword">undefined</span> <span class="token operator">:</span> data<span class="token punctuation">.</span>key
  <span class="token keyword">return</span> <span class="token punctuation">{</span> sel<span class="token punctuation">,</span> data<span class="token punctuation">,</span> children<span class="token punctuation">,</span> text<span class="token punctuation">,</span> elm<span class="token punctuation">,</span> key <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><ul><li><code>init</code>函数
<ul><li><code>init</code>函数是一个高阶函数。</li> <li>接受<code>moudle</code>数组和<code>domApi</code>作为参数</li> <li>返回<code>patch</code>函数</li> <li><code>domApi</code>默认是操作<code>html</code>的<code>api</code>,我们可以提供其他平台的<code>api</code>来将虚拟<code>dom</code>转成其他平台的<code>dom</code></li></ul></li></ul> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code>
<span class="token comment">// init.ts</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">init</span> <span class="token punctuation">(</span>modules<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span>Partial<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Module</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">&gt;, domApi?: DOMAPI) </span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> i<span class="token operator">:</span> <span class="token builtin">number</span>
  <span class="token keyword">let</span> j<span class="token operator">:</span> <span class="token builtin">number</span>
  <span class="token comment">// 保存模块中的勾子函数</span>
  <span class="token keyword">const</span> cbs<span class="token operator">:</span> ModuleHooks <span class="token operator">=</span> <span class="token punctuation">{</span>
    create<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    update<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    remove<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    destroy<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    pre<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    post<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
 <span class="token comment">// 设置api的值，默认是htmlDomApi</span>
  <span class="token keyword">const</span> api<span class="token operator">:</span> <span class="token constant">DOMAPI</span> <span class="token operator">=</span> domApi <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> domApi <span class="token operator">:</span> htmlDomApi
	<span class="token comment">// 外层循环没有意义，设置的就是默认值和上面初始化的值一样，都是[]</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> hooks<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    cbs<span class="token punctuation">[</span>hooks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> modules<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//将模块中的勾子函数依次放入到对应的数组中</span>
      <span class="token comment">// cbs['create'].push(fn1)</span>
      <span class="token keyword">const</span> hook <span class="token operator">=</span> modules<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span>hooks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>hook <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span>cbs<span class="token punctuation">[</span>hooks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>hook<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
	<span class="token comment">//下面是一些patch函数需要用到的内部函数</span>
  <span class="token keyword">function</span> <span class="token function">emptyNodeAt</span> <span class="token punctuation">(</span><span class="token parameter">elm<span class="token operator">:</span> Element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">createRmCb</span> <span class="token punctuation">(</span><span class="token parameter">childElm<span class="token operator">:</span> Node<span class="token punctuation">,</span> listeners<span class="token operator">:</span> number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 返回一个patch:用来将后面的虚拟dom替换前面的dom</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">patch</span> <span class="token punctuation">(</span><span class="token parameter">oldVnode<span class="token operator">:</span> VNode <span class="token operator">|</span> Element<span class="token punctuation">,</span> vnode<span class="token operator">:</span> VNode</span><span class="token punctuation">)</span><span class="token operator">:</span> VNode <span class="token punctuation">{</span>
    <span class="token operator">...</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> vnode
  <span class="token punctuation">}</span>
    
 <span class="token comment">//   上面的Module</span>
 <span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">Module</span> <span class="token operator">=</span> Partial<span class="token operator">&lt;</span><span class="token punctuation">{</span>
  pre<span class="token operator">:</span> PreHook
  create<span class="token operator">:</span> CreateHook
  update<span class="token operator">:</span> UpdateHook
  destroy<span class="token operator">:</span> DestroyHook
  remove<span class="token operator">:</span> RemoveHook
  post<span class="token operator">:</span> PostHook
<span class="token punctuation">}</span><span class="token operator">&gt;</span>   

<span class="token comment">//  htmlDomApi.ts </span>
<span class="token keyword">function</span> <span class="token function">insertBefore</span> <span class="token punctuation">(</span><span class="token parameter">parentNode<span class="token operator">:</span> Node<span class="token punctuation">,</span> newNode<span class="token operator">:</span> Node<span class="token punctuation">,</span> referenceNode<span class="token operator">:</span> Node <span class="token operator">|</span> <span class="token keyword">null</span></span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  parentNode<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>newNode<span class="token punctuation">,</span> referenceNode<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">removeChild</span> <span class="token punctuation">(</span><span class="token parameter">node<span class="token operator">:</span> Node<span class="token punctuation">,</span> child<span class="token operator">:</span> Node</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  node<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
  
 <span class="token keyword">export</span> <span class="token keyword">const</span> htmlDomApi<span class="token operator">:</span> <span class="token constant">DOMAPI</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  createElement<span class="token punctuation">,</span>
  createElementNS<span class="token punctuation">,</span>
  createTextNode<span class="token punctuation">,</span>
  createComment<span class="token punctuation">,</span>
  insertBefore<span class="token punctuation">,</span>
  removeChild<span class="token punctuation">,</span>
  appendChild<span class="token punctuation">,</span>
  parentNode<span class="token punctuation">,</span>
  nextSibling<span class="token punctuation">,</span>
  tagName<span class="token punctuation">,</span>
  setTextContent<span class="token punctuation">,</span>
  getTextContent<span class="token punctuation">,</span>
  isElement<span class="token punctuation">,</span>
  isText<span class="token punctuation">,</span>
  isComment<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br></div></div><ul><li><code>patch</code>函数
<ul><li><code>patch(oldVNode,newVode)</code></li> <li>把新节点渲染到真实<code>dom</code>中去，返回新的<code>VNode</code>作为下次的处理的<code>oldVNode</code></li> <li>对比新旧节点是否相同(<code>key</code>和<code>sel</code>)</li> <li>如果不同，删除之前的节点重新创建</li> <li>如果相同，判断新的<code>VNode</code>是否有文本节点，如果有并且和旧的<code>VNode</code>的文本不同，直切更新文本的内容</li> <li>如果新的<code>VNode</code>有子节点，对比子节点是否有变化</li></ul></li></ul> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token keyword">function</span> <span class="token function">patch</span> <span class="token punctuation">(</span><span class="token parameter">oldVnode<span class="token operator">:</span> VNode <span class="token operator">|</span> Element<span class="token punctuation">,</span> vnode<span class="token operator">:</span> VNode</span><span class="token punctuation">)</span><span class="token operator">:</span> VNode <span class="token punctuation">{</span>
    <span class="token keyword">let</span> i<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> elm<span class="token operator">:</span> Node<span class="token punctuation">,</span> parent<span class="token operator">:</span> Node
    <span class="token comment">// 保存要插入的虚拟dom的列表，当插入到真实dom中后执行insert虚拟dom的insert勾子</span>
    <span class="token keyword">const</span> insertedVnodeQueue<span class="token operator">:</span> VNodeQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token comment">// 执行pre勾子</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span>pre<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> cbs<span class="token punctuation">.</span>pre<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 如果不是vNode,将真实dom转成虚拟dom</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isVnode</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      oldVnode <span class="token operator">=</span> <span class="token function">emptyNodeAt</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 判断vNode和原来的老的vNode是否相同</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 更新他的子节点</span>
      <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      elm <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>elm<span class="token operator">!</span>
      parent <span class="token operator">=</span> api<span class="token punctuation">.</span><span class="token function">parentNode</span><span class="token punctuation">(</span>elm<span class="token punctuation">)</span> <span class="token keyword">as</span> Node
      <span class="token comment">// 将vNode转成真实的dom，并将vnode保存到insertedVnodeQueue</span>
      <span class="token function">createElm</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>
      <span class="token comment">// 将新的dom插入到原来dom的后面</span>
      <span class="token comment">// 删除原来的dom</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        api<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> vnode<span class="token punctuation">.</span>elm<span class="token operator">!</span><span class="token punctuation">,</span> api<span class="token punctuation">.</span><span class="token function">nextSibling</span><span class="token punctuation">(</span>elm<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">removeVnodes</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> <span class="token punctuation">[</span>oldVnode<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 执行插入的vNode的insert勾子</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> insertedVnodeQueue<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ！.类似js的?.(可选链) </span>
      insertedVnodeQueue<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token operator">!</span><span class="token punctuation">.</span>hook<span class="token operator">!</span><span class="token punctuation">.</span>insert<span class="token operator">!</span><span class="token punctuation">(</span>insertedVnodeQueue<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
     <span class="token comment">// 执行 post勾子</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span>post<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> cbs<span class="token punctuation">.</span>post<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> vnode
  <span class="token punctuation">}</span>

<span class="token comment">// 内部的一些函数</span>

<span class="token keyword">function</span> <span class="token function">sameVnode</span> <span class="token punctuation">(</span><span class="token parameter">vnode1<span class="token operator">:</span> VNode<span class="token punctuation">,</span> vnode2<span class="token operator">:</span> VNode</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> vnode1<span class="token punctuation">.</span>key <span class="token operator">===</span> vnode2<span class="token punctuation">.</span>key <span class="token operator">&amp;&amp;</span> vnode1<span class="token punctuation">.</span>sel <span class="token operator">===</span> vnode2<span class="token punctuation">.</span>sel
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">isVnode</span> <span class="token punctuation">(</span><span class="token parameter">vnode<span class="token operator">:</span> any</span><span class="token punctuation">)</span><span class="token operator">:</span> vnode <span class="token keyword">is</span> VNode <span class="token punctuation">{</span>
  <span class="token keyword">return</span> vnode<span class="token punctuation">.</span>sel <span class="token operator">!==</span> <span class="token keyword">undefined</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">emptyNodeAt</span> <span class="token punctuation">(</span><span class="token parameter">elm<span class="token operator">:</span> Element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> id <span class="token operator">=</span> elm<span class="token punctuation">.</span>id <span class="token operator">?</span> <span class="token string">'#'</span> <span class="token operator">+</span> elm<span class="token punctuation">.</span>id <span class="token operator">:</span> <span class="token string">''</span>
  <span class="token keyword">const</span> c <span class="token operator">=</span> elm<span class="token punctuation">.</span>className <span class="token operator">?</span> <span class="token string">'.'</span> <span class="token operator">+</span> elm<span class="token punctuation">.</span>className<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">''</span>
  <span class="token keyword">return</span> <span class="token function">vnode</span><span class="token punctuation">(</span>api<span class="token punctuation">.</span><span class="token function">tagName</span><span class="token punctuation">(</span>elm<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> id <span class="token operator">+</span> c<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> elm<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 其他的函数可以去源码中找</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><p>可以对上面我们搭建的<code>snabbdom-demo</code>进行断点调试来观察<code>patch</code>函数的执行过程,打包后的源文件位于控制台-&gt;<code>source</code>-&gt;<code>http://localhost:1234/</code>-&gt;<code>src/*</code>,可以对其设置断点。</p> <p><img src="/frontend/parcel-source.png" alt="patch-source"></p> <div class="language-html line-numbers-mode"><pre class="language-html"><code>
<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>X-UA-Compatible<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>IE=edge<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Document<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>app<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./src/01-basicusage.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
&lt;/html
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p><code>div</code>后面的兄弟节点是文本节点而不是<code>script</code>节点</p></div> <ul><li><code>createElm</code>函数
<ul><li>将<code>VNode</code>转换成<code>dom</code>对象保存到<code>VNode.elm</code>属性中</li> <li><code>createElm</code>函数在创建真实<code>dom</code>对象的时候会执行我们设置的<code>hook</code>函数</li> <li><code>createElm</code>可以创建注释节点、元素节点、文本节点</li> <li>当我们传入的<code>VNode</code>对象有<code>insert</code>勾子时，会被加入到<code>insertedVnodeQueue</code>里</li></ul></li></ul> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code>
  <span class="token keyword">function</span> <span class="token function">createElm</span> <span class="token punctuation">(</span><span class="token parameter">vnode<span class="token operator">:</span> VNode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token operator">:</span> VNodeQueue</span><span class="token punctuation">)</span><span class="token operator">:</span> Node <span class="token punctuation">{</span>
    <span class="token keyword">let</span> i<span class="token operator">:</span> <span class="token builtin">any</span>
    <span class="token keyword">let</span> data <span class="token operator">=</span> vnode<span class="token punctuation">.</span>data
    <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 执行我们在创建VNode的时候传入的data的init勾子函数</span>
      <span class="token keyword">const</span> init <span class="token operator">=</span> data<span class="token punctuation">.</span>hook<span class="token operator">?.</span>init
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>init<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">init</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span>
        <span class="token comment">// init函数可能会修改data</span>
        data <span class="token operator">=</span> vnode<span class="token punctuation">.</span>data
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 获取VNode对象的children 和sel属性</span>
    <span class="token comment">// sel == &quot;!&quot;&quot; 是注释节点</span>
    <span class="token comment">// sel !== &quot;!&quot; &amp;&amp; sel !== undefined 是元素节点</span>
    <span class="token comment">// 否则是文本节点 </span>
    <span class="token keyword">const</span> children <span class="token operator">=</span> vnode<span class="token punctuation">.</span>children
    <span class="token keyword">const</span> sel <span class="token operator">=</span> vnode<span class="token punctuation">.</span>sel
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sel <span class="token operator">===</span> <span class="token string">'!'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 讲注释内容修改成字符串</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        vnode<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token string">''</span>
      <span class="token punctuation">}</span>
      vnode<span class="token punctuation">.</span>elm <span class="token operator">=</span> api<span class="token punctuation">.</span><span class="token function">createComment</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>text<span class="token operator">!</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>sel <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Parse selector</span>
      <span class="token comment">// 将我们传入的选择器解析成tag,id,class </span>
      <span class="token class-name"><span class="token keyword">const</span></span> hashIdx <span class="token operator">=</span> sel<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'#'</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> dotIdx <span class="token operator">=</span> sel<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">,</span> hashIdx<span class="token punctuation">)</span>
      <span class="token keyword">const</span> hash <span class="token operator">=</span> hashIdx <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">?</span> hashIdx <span class="token operator">:</span> sel<span class="token punctuation">.</span>length
      <span class="token keyword">const</span> dot <span class="token operator">=</span> dotIdx <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">?</span> dotIdx <span class="token operator">:</span> sel<span class="token punctuation">.</span>length
      <span class="token keyword">const</span> tag <span class="token operator">=</span> hashIdx <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> dotIdx <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">?</span> sel<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> dot<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> sel
      <span class="token comment">// data.ns存在的是svg</span>
      <span class="token keyword">const</span> elm <span class="token operator">=</span> vnode<span class="token punctuation">.</span>elm <span class="token operator">=</span> <span class="token function">isDef</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> data<span class="token punctuation">.</span>ns<span class="token punctuation">)</span>
        <span class="token operator">?</span> api<span class="token punctuation">.</span><span class="token function">createElementNS</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> tag<span class="token punctuation">)</span>
        <span class="token operator">:</span> api<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span>
      <span class="token comment">// 向创建的元素节点上添加id和class  </span>
      <span class="token class-name"><span class="token keyword">if</span></span> <span class="token punctuation">(</span>hash <span class="token operator">&lt;</span> dot<span class="token punctuation">)</span> elm<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> sel<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>hash <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> dot<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>dotIdx <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> elm<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'class'</span><span class="token punctuation">,</span> sel<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>dot <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">// 执行模块的create勾子</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span>create<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> cbs<span class="token punctuation">.</span>create<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>emptyNode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>
      <span class="token comment">// 如果children存在，那么该节点含有子元素，负责元素的内容是文本节点</span>
      <span class="token comment">// children和text只能存在一个</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">is</span><span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> ch <span class="token operator">=</span> children<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
          <span class="token comment">// 递归调用createElm来创建子元素</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>ch <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            api<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> <span class="token function">createElm</span><span class="token punctuation">(</span>ch <span class="token keyword">as</span> VNode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">is</span><span class="token punctuation">.</span><span class="token function">primitive</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        api<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> api<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 执行VNode的create勾子</span>
      <span class="token keyword">const</span> hook <span class="token operator">=</span> vnode<span class="token punctuation">.</span>data<span class="token operator">!</span><span class="token punctuation">.</span>hook
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>hook<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        hook<span class="token punctuation">.</span>create<span class="token operator">?.</span><span class="token punctuation">(</span>emptyNode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>
        <span class="token comment">// insert勾子存在，将对应的Vnode放入insertedVnodeQueue里面</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>hook<span class="token punctuation">.</span>insert<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          insertedVnodeQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 创建文本节点</span>
      vnode<span class="token punctuation">.</span>elm <span class="token operator">=</span> api<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>text<span class="token operator">!</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 返回我们创建的dom对象</span>
    <span class="token keyword">return</span> vnode<span class="token punctuation">.</span>elm
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br></div></div><p><code>我们可以使用下面的代码来调试</code>：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 04-basicusage.js </span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> h <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;snabbdom/build/package/h&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> init <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;snabbdom/build/package/init&quot;</span><span class="token punctuation">;</span>  

<span class="token keyword">const</span> patch <span class="token operator">=</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 第一个参数是元素的标签和选择器</span>
<span class="token comment">// 第二个参数是元素的内容</span>
<span class="token keyword">const</span> vNode <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">&quot;div#container.test&quot;</span><span class="token punctuation">,</span><span class="token punctuation">{</span> 
    hook<span class="token operator">:</span><span class="token punctuation">{</span> 
        <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'init hook'</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'create hook'</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>   
    <span class="token punctuation">}</span>    
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&quot;Hello world&quot;</span><span class="token punctuation">)</span> 


<span class="token comment">// 第一个参数可以是旧的vNode，也可以是真实dom</span>
<span class="token comment">// 第一个参数是新vNode</span>
<span class="token comment">// 返回值是的新的vNode</span>

<span class="token keyword">const</span> el <span class="token operator">=</span>  document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#app&quot;</span><span class="token punctuation">)</span>
<span class="token comment">// 为下一次更新去使用</span>
<span class="token function">patch</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span>vNode<span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><ul><li><code>removeVnodes.ts</code>函数
<ul><li>批量删除<code>VNode</code>从<code>dom</code>上</li></ul></li></ul> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code>  <span class="token comment">/**
   * 批量删除VNode
   * @param parentElm 父节点，真实dom 
   * @param vnodes  VNode的列表
   * @param startIdx 删除的开始下标 
   * @param endIdx  删除的结束下标
   */</span>
  <span class="token keyword">function</span> <span class="token function">removeVnodes</span> <span class="token punctuation">(</span><span class="token parameter">parentElm<span class="token operator">:</span> Node<span class="token punctuation">,</span>
    vnodes<span class="token operator">:</span> VNode<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    startIdx<span class="token operator">:</span> number<span class="token punctuation">,</span>
    endIdx<span class="token operator">:</span> number</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> startIdx <span class="token operator">&lt;=</span> endIdx<span class="token punctuation">;</span> <span class="token operator">++</span>startIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> listeners<span class="token operator">:</span> <span class="token builtin">number</span>
      <span class="token keyword">let</span> <span class="token function-variable function">rm</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span>
      <span class="token keyword">const</span> ch <span class="token operator">=</span> vnodes<span class="token punctuation">[</span>startIdx<span class="token punctuation">]</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>ch <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>ch<span class="token punctuation">.</span>sel<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 调用VNode中的destroy勾子，如果有children,递归调用invokeDestroyHook</span>
          <span class="token function">invokeDestroyHook</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span>
          <span class="token comment">// 一个计数器,当计数器的数字变成0时，去掉用下面的rm</span>
          listeners <span class="token operator">=</span> cbs<span class="token punctuation">.</span>remove<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">1</span>
          <span class="token comment">// createRmCb返回一个高阶函数，返回rm函数，rm函数执行一次，--listeners</span>
          <span class="token comment">// 当listeners == 0时,从ch.elm的父元素上移除该节点</span>
          rm <span class="token operator">=</span> <span class="token function">createRmCb</span><span class="token punctuation">(</span>ch<span class="token punctuation">.</span>elm<span class="token operator">!</span><span class="token punctuation">,</span> listeners<span class="token punctuation">)</span>
          <span class="token comment">// 执行chs.remove勾子函数(全局模块中提供的)</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span>remove<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> cbs<span class="token punctuation">.</span>remove<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>ch<span class="token punctuation">,</span> rm<span class="token punctuation">)</span>
          <span class="token keyword">const</span> removeHook <span class="token operator">=</span> ch<span class="token operator">?.</span>data<span class="token operator">?.</span>hook<span class="token operator">?.</span>remove
          <span class="token comment">// 如果ch这个VNode有remove勾子函数，触发它的勾子函数</span>
          <span class="token comment">// 这里再次执行rm时因为我们`init`函数可能没接受modules,那么我们也要确保rm执行一次</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>removeHook<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">removeHook</span><span class="token punctuation">(</span>ch<span class="token punctuation">,</span> rm<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 当我们没有提供模块和Vnode中的romove勾子，也要去删除该节点</span>
            <span class="token function">rm</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// Text node</span>
          api<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> ch<span class="token punctuation">.</span>elm<span class="token operator">!</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">createRmCb</span> <span class="token punctuation">(</span><span class="token parameter">childElm<span class="token operator">:</span> Node<span class="token punctuation">,</span> listeners<span class="token operator">:</span> number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">rmCb</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>listeners <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> parent <span class="token operator">=</span> api<span class="token punctuation">.</span><span class="token function">parentNode</span><span class="token punctuation">(</span>childElm<span class="token punctuation">)</span> <span class="token keyword">as</span> Node
        api<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> childElm<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/**
   * 调用VNode中的destroy勾子，如果有children,递归调用invokeDestroyHook
   * @param vnode 
   */</span>
  <span class="token keyword">function</span> <span class="token function">invokeDestroyHook</span> <span class="token punctuation">(</span><span class="token parameter">vnode<span class="token operator">:</span> VNode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> data <span class="token operator">=</span> vnode<span class="token punctuation">.</span>data
    <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      data<span class="token operator">?.</span>hook<span class="token operator">?.</span>destroy<span class="token operator">?.</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span>destroy<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> cbs<span class="token punctuation">.</span>destroy<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>children <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> vnode<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> child <span class="token operator">=</span> vnode<span class="token punctuation">.</span>children<span class="token punctuation">[</span>j<span class="token punctuation">]</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>child <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> child <span class="token operator">!==</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">invokeDestroyHook</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br></div></div><ul><li><code>addVnodes</code>函数
<ul><li>批量添加<code>VNode</code>到<code>dom</code>上</li></ul></li></ul> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code>
  <span class="token comment">/**
   * 
   * @param parentElm 父元素
   * @param before 插入节点的在before节点之前
   * @param vnodes  要插入的VNode的列表
   * @param startIdx VNodes中 的开始下标
   * @param endIdx  VNodes中 的结束下标
   * @param insertedVnodeQueue 记录要提供了insert勾子的VNode列表
   */</span>
  <span class="token keyword">function</span> <span class="token function">addVnodes</span> <span class="token punctuation">(</span>
    <span class="token parameter">parentElm<span class="token operator">:</span> Node<span class="token punctuation">,</span>
    before<span class="token operator">:</span> Node <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    vnodes<span class="token operator">:</span> VNode<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    startIdx<span class="token operator">:</span> number<span class="token punctuation">,</span>
    endIdx<span class="token operator">:</span> number<span class="token punctuation">,</span>
    insertedVnodeQueue<span class="token operator">:</span> VNodeQueue</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> startIdx <span class="token operator">&lt;=</span> endIdx<span class="token punctuation">;</span> <span class="token operator">++</span>startIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> ch <span class="token operator">=</span> vnodes<span class="token punctuation">[</span>startIdx<span class="token punctuation">]</span>
      <span class="token comment">// 直接将Vnode创建成真实dom然后插入</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>ch <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        api<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> <span class="token function">createElm</span><span class="token punctuation">(</span>ch<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">,</span> before<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><ul><li><code>patchVnode</code>函数
<ul><li>当发现两个新旧dom相同(key和选择器相同)，那么对比两个虚拟dom的子节点和文本节点的内容
<img src="/frontEnd/patchVode.png" alt="patchVnode"></li></ul></li></ul> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token comment">/**
   * 当发现两个新旧dom相同(key和选择器相同)，那么对比两个虚拟dom的子节点和文本节点的内容
   * @param oldVnode 旧的虚拟dom
   * @param vnode 新的虚拟dom
   * @param insertedVnodeQueue 需要执行insert勾子的VNode的数组
   * @returns 
   */</span>
  <span class="token keyword">function</span> <span class="token function">patchVnode</span> <span class="token punctuation">(</span><span class="token parameter">oldVnode<span class="token operator">:</span> VNode<span class="token punctuation">,</span> vnode<span class="token operator">:</span> VNode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token operator">:</span> VNodeQueue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 先执行新的VNode的prepatch勾子</span>
    <span class="token keyword">const</span> hook <span class="token operator">=</span> vnode<span class="token punctuation">.</span>data<span class="token operator">?.</span>hook
    hook<span class="token operator">?.</span>prepatch<span class="token operator">?.</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>
    <span class="token comment">// 这里我们使用旧的dom进行更新</span>
    <span class="token keyword">const</span> elm <span class="token operator">=</span> vnode<span class="token punctuation">.</span>elm <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>elm<span class="token operator">!</span>
    <span class="token keyword">const</span> oldCh <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>children <span class="token keyword">as</span> VNode<span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">const</span> ch <span class="token operator">=</span> vnode<span class="token punctuation">.</span>children <span class="token keyword">as</span> VNode<span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token comment">// 两个VNode相同应用，那么直接返回</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldVnode <span class="token operator">===</span> vnode<span class="token punctuation">)</span> <span class="token keyword">return</span>
    <span class="token comment">// 触发moduels中的update勾子和新的VNode的update勾子</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>data <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span>update<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> cbs<span class="token punctuation">.</span>update<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>
      vnode<span class="token punctuation">.</span>data<span class="token punctuation">.</span>hook<span class="token operator">?.</span>update<span class="token operator">?.</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 新的VNode没有文本节点</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 那么新的VNode的children应该存在</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 新旧VNode的children都存在且不相等</span>
        <span class="token comment">// 调用updateChildren函数去跟旧VNode的children</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldCh <span class="token operator">!==</span> ch<span class="token punctuation">)</span> <span class="token function">updateChildren</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> ch<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 新的VNode的children存在而旧的Vnode的children不存在</span>
        <span class="token comment">// 移除文本节点</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> api<span class="token punctuation">.</span><span class="token function">setTextContent</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
        <span class="token comment">// 创建新的VNode的children的并添加到elm</span>
        <span class="token function">addVnodes</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> ch<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ch<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 旧的VNode有children而新的VNode没有children,也没有文本节点</span>
        <span class="token comment">// 直接删除旧的VNode的children</span>
        <span class="token function">removeVnodes</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> oldCh<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果新旧VNode的children都不存在，但是旧的VNode有text而新的没有</span>
        <span class="token comment">// 直接删除旧的VNode的文本节点即可</span>
        api<span class="token punctuation">.</span><span class="token function">setTextContent</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>text <span class="token operator">!==</span> vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 新的VNode有文本节点且和旧的VNode的文本节点不同</span>
      <span class="token comment">// 旧的VNode有子元素</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 删除子元素，这样子可以触发destory和remove勾子</span>
        <span class="token function">removeVnodes</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> oldCh<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 更新文本节点</span>
      api<span class="token punctuation">.</span><span class="token function">setTextContent</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> vnode<span class="token punctuation">.</span>text<span class="token operator">!</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 执行新的Vnode的postpatch勾子</span>
    hook<span class="token operator">?.</span>postpatch<span class="token operator">?.</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br></div></div><p>当发现两个<code>vnode</code>的<code>key</code>和<code>sel</code>是相同的时候，但是他们的<code>children</code>都存在且不相同时，我们会执行<code>updateChildren</code>函数</p> <ul><li><code>updateChildren(elm, oldCh, ch, insertedVnodeQueue)</code> <ul><li>对比两个<code>key</code>和<code>sel</code>相同的<code>vnode</code>的<code>children</code>(都存在)</li> <li>其他情况我们都是使用<code>patchVnode</code>来对比更新的两个vnode</li> <li>是diff算法的核心</li></ul></li></ul> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code>  <span class="token comment">/**
   * 对比两个vnode的children
   * @param parentElm 
   * @param oldCh 
   * @param newCh 
   * @param insertedVnodeQueue 
   */</span>
  <span class="token keyword">function</span> <span class="token function">updateChildren</span> <span class="token punctuation">(</span><span class="token parameter">parentElm<span class="token operator">:</span> Node<span class="token punctuation">,</span>
    oldCh<span class="token operator">:</span> VNode<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    newCh<span class="token operator">:</span> VNode<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    insertedVnodeQueue<span class="token operator">:</span> VNodeQueue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 对比过程中需要使用到的变量  </span>
    <span class="token keyword">let</span> oldStartIdx <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">// 旧的vnode的children的开始索引</span>
    <span class="token keyword">let</span> newStartIdx <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">//新的vnode的children的开始索引</span>
    <span class="token keyword">let</span> oldEndIdx <span class="token operator">=</span> oldCh<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span> <span class="token comment">//旧的vnode的children的结束索引</span>
    <span class="token keyword">let</span> oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token comment">// 旧的vnode的children中的第一个vnode</span>
    <span class="token keyword">let</span> oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span>oldEndIdx<span class="token punctuation">]</span> <span class="token comment">//旧的vnode的children中的最后一个vnode</span>
    <span class="token keyword">let</span> newEndIdx <span class="token operator">=</span> newCh<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span> <span class="token comment">//新的vnode的children的结束索引</span>
    <span class="token keyword">let</span> newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token comment">//新的vnode的children中的第一个vnode</span>
    <span class="token keyword">let</span> newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span>newEndIdx<span class="token punctuation">]</span> <span class="token comment">//新的vnode的children中的最后一个vnode</span>
    <span class="token keyword">let</span> oldKeyToIdx<span class="token operator">:</span> KeyToIndexMap <span class="token operator">|</span> <span class="token keyword">undefined</span>  <span class="token comment">// 通过索引去查找下标的对象</span>
    <span class="token keyword">let</span> idxInOld<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token comment">//索引</span>
    <span class="token keyword">let</span> elmToMove<span class="token operator">:</span> VNode <span class="token comment">//需要移动的元素</span>
    <span class="token keyword">let</span> before<span class="token operator">:</span> <span class="token builtin">any</span> <span class="token comment">//</span>
    <span class="token comment">// 整个diff算法的核心  </span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>oldStartIdx <span class="token operator">&lt;=</span> oldEndIdx <span class="token operator">&amp;&amp;</span> newStartIdx <span class="token operator">&lt;=</span> newEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 忽律children中为null的vnode</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartVnode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span> <span class="token comment">// Vnode might have been moved left</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldEndVnode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newStartVnode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newEndVnode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">--</span>newEndIdx<span class="token punctuation">]</span>  
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 对比两个开始节点，当新旧vnode的children元素的中的开始节点相同时</span>
        <span class="token comment">// 使用patchVode对比更新两个vnodo的内部(children 或者 text)</span>
        <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>
        <span class="token comment">// 两个下标同时后移</span>
        oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span>
        newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 当开始节点不同时，对比children中的最后面的节点，当新旧vnode的children元素的中的结束节点相同时</span>
        <span class="token comment">// 使用patchVode去对比跟新两个vnodo的内部(children 或者 text)</span>
        <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>
        <span class="token comment">//  下标前移</span>
        oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span>
        newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">--</span>newEndIdx<span class="token punctuation">]</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// Vnode moved right</span>
        <span class="token comment">// 当新旧vnode的chilren中开始和开始，结束和结束位置对比失败时</span>
        <span class="token comment">// 开始对你旧的开始节点和新的结束节点，当相同时，使用使用patchVode对比跟新两个vnodo的内部(children 或者 text)</span>
        <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>
        <span class="token comment">// 将vnode插入oldEndVnode元素的后面</span>
        api<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token operator">!</span><span class="token punctuation">,</span> api<span class="token punctuation">.</span><span class="token function">nextSibling</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">.</span>elm<span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment">// 然后一个前移，一个后移去继续对比</span>
        oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span>
        newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">--</span>newEndIdx<span class="token punctuation">]</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// Vnode moved left</span>
        <span class="token comment">//  当新旧vnode的chilren中开始和开始，结束和结束位置，旧的开始和新的结束对比失败时</span>
        <span class="token comment">//  对比新的开始和旧的结束节点</span>
        <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>
        <span class="token comment">// 将元素前移</span>
        api<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> oldEndVnode<span class="token punctuation">.</span>elm<span class="token operator">!</span><span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token operator">!</span><span class="token punctuation">)</span>
        <span class="token comment">// 继续跟新下标对比</span>
        oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span>
        newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 上面的四种情况都对比失败了，那么应该去查找新的节点在旧的旧的节点列表中是否存在</span>
        <span class="token comment">// 建立key和下标的映射在旧的未对比的vnode.children中</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldKeyToIdx <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          oldKeyToIdx <span class="token operator">=</span> <span class="token function">createKeyToOldIdx</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">,</span> oldStartIdx<span class="token punctuation">,</span> oldEndIdx<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 使用key去查找</span>
        idxInOld <span class="token operator">=</span> oldKeyToIdx<span class="token punctuation">[</span>newStartVnode<span class="token punctuation">.</span>key <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>idxInOld<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// New element</span>
          <span class="token comment">// 当没找到，我们创建新的节点</span>
          api<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> <span class="token function">createElm</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token operator">!</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// 当找到了</span>
          elmToMove <span class="token operator">=</span> oldCh<span class="token punctuation">[</span>idxInOld<span class="token punctuation">]</span>
          <span class="token comment">// 我们还需要对比sel属性</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>elmToMove<span class="token punctuation">.</span>sel <span class="token operator">!==</span> newStartVnode<span class="token punctuation">.</span>sel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 当key相同但是sel不同，我们需要去新建节点</span>
            api<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> <span class="token function">createElm</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token operator">!</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">//当key和sel相同的时候，我们认为是相同的节点</span>
            <span class="token comment">// 对比跟新子节点</span>
            <span class="token function">patchVnode</span><span class="token punctuation">(</span>elmToMove<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>
            <span class="token comment">// 将这个位置设置为undefined</span>
            oldCh<span class="token punctuation">[</span>idxInOld<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">undefined</span> <span class="token keyword">as</span> <span class="token builtin">any</span>
            <span class="token comment">// 插入跟新后的节点到旧的开始节点的前面</span>
            api<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> elmToMove<span class="token punctuation">.</span>elm<span class="token operator">!</span><span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token operator">!</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 移动新的开始指针</span>
        newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 对比完成后我们的收尾工作</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartIdx <span class="token operator">&lt;=</span> oldEndIdx <span class="token operator">||</span> newStartIdx <span class="token operator">&lt;=</span> newEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 此时说明新的vnode的children中还有没有创建的元素</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartIdx <span class="token operator">&gt;</span> oldEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        before <span class="token operator">=</span> newCh<span class="token punctuation">[</span>newEndIdx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> newCh<span class="token punctuation">[</span>newEndIdx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>elm
        <span class="token comment">// 插入新的节点到</span>
        <span class="token function">addVnodes</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> before<span class="token punctuation">,</span> newCh<span class="token punctuation">,</span> newStartIdx<span class="token punctuation">,</span> newEndIdx<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 说明旧的vnode中有剩余的节点需要去删除</span>
        <span class="token function">removeVnodes</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> oldStartIdx<span class="token punctuation">,</span> oldEndIdx<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br></div></div><h5 id="diff算法"><a href="#diff算法" class="header-anchor">#</a> <code>diff算法</code></h5> <ul><li>使用diff算法的目的
<ul><li>操作<code>dom</code>会引起浏览器的重绘和重排，比较耗性能</li> <li>使用<code>diff</code>算法可以对比两个<code>vnode</code>,最小化去更新<code>dom</code></li></ul></li></ul> <p>传统的对比两个树结构的算法：</p> <ul><li>需要遍历每个节点去和另一个<code>dom</code>树做对比(事件复杂度O(n*n))</li></ul> <p><img src="/frontEnd/old-diff.png" alt="diff"></p> <ul><li><code>snabbdom</code>的<code>diff</code>算法对传统的<code>diff</code>算法做了优化：
<ul><li><code>dom</code>操作时很少跨级别操作节点</li> <li>只比较同级别的节点</li></ul></li></ul> <p><img src="/frontEnd/snabbdom-diff.png" alt="snabbdom-diff"></p> <p>具体对比过程</p> <ul><li><p><code>vnode</code>中的开始节点和<code>oldVnode</code>的开始节点对比</p> <p><img src="/frontEnd/start-start.png" alt="diff"></p></li> <li><p><code>vnode</code>中的接受节点和<code>oldVnode</code>的结束节点对比(和第一种类似)</p></li> <li><p><code>vnode</code>中的结束节点和<code>oldVnode</code>的开始节点对比</p> <p><img src="/frontEnd/start-end.png" alt="diff"></p></li> <li><p><code>vnode</code>中的开始节点和<code>oldVnode</code>的结束节点对比</p> <p><img src="/frontEnd/end-start.png" alt="diff"></p></li> <li><p>当上面四种情况对比失败后，根据<code>key</code>去旧的<code>vnode</code>中查找</p> <ul><li>当找不到key对应的节点或者找到了但是<code>sel</code>不同，新建节点</li> <li>当找到且sel相同，调用<code>pacthVnode</code>去对比子节点</li></ul> <p><img src="/frontEnd/other-diff.png" alt=""></p></li></ul> <p>当比较结束；我们还需要去检查新旧<code>vnode</code>中有没有未对比到的元素:</p> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code>    <span class="token comment">// 对比完成后我们的收尾工作</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartIdx <span class="token operator">&lt;=</span> oldEndIdx <span class="token operator">||</span> newStartIdx <span class="token operator">&lt;=</span> newEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 此时说明新的vnode的children中还有没有创建的元素</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartIdx <span class="token operator">&gt;</span> oldEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        before <span class="token operator">=</span> newCh<span class="token punctuation">[</span>newEndIdx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> newCh<span class="token punctuation">[</span>newEndIdx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>elm
        <span class="token comment">// 插入新的节点到</span>
        <span class="token function">addVnodes</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> before<span class="token punctuation">,</span> newCh<span class="token punctuation">,</span> newStartIdx<span class="token punctuation">,</span> newEndIdx<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 说明旧的vnode中有剩余的节点需要去删除</span>
        <span class="token function">removeVnodes</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> oldStartIdx<span class="token punctuation">,</span> oldEndIdx<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>调用上面的<code>updateChildren</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>
<span class="token keyword">import</span> <span class="token punctuation">{</span> h <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;snabbdom/build/package/h&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> init <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;snabbdom/build/package/init&quot;</span><span class="token punctuation">;</span>  

<span class="token keyword">const</span> patch <span class="token operator">=</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 第一个参数是元素的标签和选择器</span>
<span class="token comment">// 第二个参数是元素的内容</span>
<span class="token keyword">const</span> vNode <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'ul'</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span><span class="token string">'首页'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span><span class="token string">'电影'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span><span class="token string">'微博'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
 


<span class="token comment">// 第一个参数可以是旧的vNode，也可以是真实dom</span>
<span class="token comment">// 第一个参数是新vNode</span>
<span class="token comment">// 返回值是的新的vNode</span>

<span class="token keyword">const</span> el <span class="token operator">=</span>  document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#app&quot;</span><span class="token punctuation">)</span>
<span class="token comment">// 为下一次更新去使用</span>
<span class="token keyword">const</span> oldVnode <span class="token operator">=</span> <span class="token function">patch</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span>vNode<span class="token punctuation">)</span>

<span class="token comment">// 继续跟新节点</span>



<span class="token function">patch</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'ul'</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span><span class="token string">'首页'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span><span class="token string">'微博'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span><span class="token string">'电影'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><ul><li>我们的再第二次调用<code>patch</code>函数会触发到（可以设置断点）</li> <li><code>updateChildren</code>的调试我们可以发现：
<ul><li>这个三个<code>li</code>元素的只会去对比开始位置(<code>key=li,sel=undefined</code>)，然后去更新文本节点的内容</li></ul></li></ul> <p>更新上面的调试代码：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> h <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;snabbdom/build/package/h&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> init <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;snabbdom/build/package/init&quot;</span><span class="token punctuation">;</span>  

<span class="token keyword">const</span> patch <span class="token operator">=</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 第一个参数是元素的标签和选择器</span>
<span class="token comment">// 第二个参数是元素的内容</span>
<span class="token keyword">const</span> vNode <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'ul'</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>key<span class="token operator">:</span><span class="token string">'a'</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">'首页'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>key<span class="token operator">:</span><span class="token string">'b'</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">'电影'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>key<span class="token operator">:</span><span class="token string">'c'</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">'微博'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
 


<span class="token comment">// 第一个参数可以是旧的vNode，也可以是真实dom</span>
<span class="token comment">// 第一个参数是新vNode</span>
<span class="token comment">// 返回值是的新的vNode</span>

<span class="token keyword">const</span> el <span class="token operator">=</span>  document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#app&quot;</span><span class="token punctuation">)</span>
<span class="token comment">// 为下一次更新去使用</span>
<span class="token keyword">const</span> oldVnode <span class="token operator">=</span> <span class="token function">patch</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span>vNode<span class="token punctuation">)</span>

<span class="token comment">// 继续跟新节点</span>

<span class="token function">patch</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'ul'</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>key<span class="token operator">:</span><span class="token string">'a'</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">'首页'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>key<span class="token operator">:</span><span class="token string">'c'</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">'微博'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>key<span class="token operator">:</span><span class="token string">'b'</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">'电影'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><ul><li>当我们设置<code>key</code>后，这个三个<code>li</code>元素是通过调换<code>dom</code>元素的位置来实现更新的</li></ul> <p>我们设置key的意义：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>
<span class="token keyword">import</span> <span class="token punctuation">{</span> init <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'snabbdom/build/package/init'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> h <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'snabbdom/build/package/h'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> attributesModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'snabbdom/build/package/modules/attributes'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> eventListenersModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'snabbdom/build/package/modules/eventlisteners'</span>

<span class="token keyword">let</span> patch <span class="token operator">=</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">[</span>attributesModule<span class="token punctuation">,</span> eventListenersModule<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span>
<span class="token keyword">let</span> oldVnode <span class="token operator">=</span> <span class="token keyword">null</span>

<span class="token keyword">function</span> <span class="token function">view</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  data<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 不设置 key</span>
    <span class="token comment">// arr.push(h('li', [h('input', { attrs: { type: 'checkbox' } }), h('span', item)]))</span>
    <span class="token comment">// 设置key</span>
    arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> key<span class="token operator">:</span> item <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'input'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> attrs<span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'checkbox'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> vnode <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> on<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token function-variable function">click</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    data<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
    vnode <span class="token operator">=</span> <span class="token function">view</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    oldVnode <span class="token operator">=</span> <span class="token function">patch</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'按钮'</span><span class="token punctuation">)</span> <span class="token punctuation">,</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'ul'</span><span class="token punctuation">,</span> arr<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> vnode
<span class="token punctuation">}</span>


<span class="token keyword">let</span> app <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span>
<span class="token comment">// 首次渲染</span>
oldVnode <span class="token operator">=</span> <span class="token function">patch</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> <span class="token function">view</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><ul><li>当我们不设置<code>key</code>的时候，选中第一个复选框，然后点击按钮添加新的元素，发现选中的还是第一个的元素</li> <li>所以给相同的<code>vnode</code>的子元素设置唯一的<code>key</code>可以解决子元素渲染错误</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/es/vue-observer.html" class="prev">
        Vue.js响应式原理
      </a></span> <span class="next"><a href="/es/vuejs-source.html">
        Vue 源码解析 响应式原理
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.9b56a05a.js" defer></script><script src="/assets/js/2.b22280cb.js" defer></script><script src="/assets/js/50.497cb73f.js" defer></script>
  </body>
</html>
