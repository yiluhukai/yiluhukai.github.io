<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>webpack和tapable | yiluhuakai</title>
    <meta name="generator" content="VuePress 1.7.1">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/assets/css/0.styles.992cb7aa.css" as="style"><link rel="preload" href="/assets/js/app.9b56a05a.js" as="script"><link rel="preload" href="/assets/js/2.b22280cb.js" as="script"><link rel="preload" href="/assets/js/58.220252cd.js" as="script"><link rel="prefetch" href="/assets/js/10.413ab2ab.js"><link rel="prefetch" href="/assets/js/100.2d785741.js"><link rel="prefetch" href="/assets/js/101.a9fd3349.js"><link rel="prefetch" href="/assets/js/11.99f54ddd.js"><link rel="prefetch" href="/assets/js/12.c46f64f3.js"><link rel="prefetch" href="/assets/js/13.6add00c5.js"><link rel="prefetch" href="/assets/js/14.40115781.js"><link rel="prefetch" href="/assets/js/15.c3827c6c.js"><link rel="prefetch" href="/assets/js/16.304d275d.js"><link rel="prefetch" href="/assets/js/17.006e2fe4.js"><link rel="prefetch" href="/assets/js/18.7f93828f.js"><link rel="prefetch" href="/assets/js/19.a72c6116.js"><link rel="prefetch" href="/assets/js/20.d175ff74.js"><link rel="prefetch" href="/assets/js/21.7092a034.js"><link rel="prefetch" href="/assets/js/22.1419ba41.js"><link rel="prefetch" href="/assets/js/23.ce5e3c1b.js"><link rel="prefetch" href="/assets/js/24.9f9edaa3.js"><link rel="prefetch" href="/assets/js/25.a57ae5dc.js"><link rel="prefetch" href="/assets/js/26.5ba697f1.js"><link rel="prefetch" href="/assets/js/27.9ecaa5dc.js"><link rel="prefetch" href="/assets/js/28.290c65fe.js"><link rel="prefetch" href="/assets/js/29.bdbc3eeb.js"><link rel="prefetch" href="/assets/js/3.ac44586b.js"><link rel="prefetch" href="/assets/js/30.6f37d998.js"><link rel="prefetch" href="/assets/js/31.b1ac1238.js"><link rel="prefetch" href="/assets/js/32.024f8182.js"><link rel="prefetch" href="/assets/js/33.202e11b5.js"><link rel="prefetch" href="/assets/js/34.e755ffc0.js"><link rel="prefetch" href="/assets/js/35.376b8f63.js"><link rel="prefetch" href="/assets/js/36.56735f24.js"><link rel="prefetch" href="/assets/js/37.b7d03c63.js"><link rel="prefetch" href="/assets/js/38.d9407e30.js"><link rel="prefetch" href="/assets/js/39.4f87e45d.js"><link rel="prefetch" href="/assets/js/4.a4a037c8.js"><link rel="prefetch" href="/assets/js/40.5a53ee48.js"><link rel="prefetch" href="/assets/js/41.f7fa6a68.js"><link rel="prefetch" href="/assets/js/42.3c07d4ad.js"><link rel="prefetch" href="/assets/js/43.2965402d.js"><link rel="prefetch" href="/assets/js/44.fef5da48.js"><link rel="prefetch" href="/assets/js/45.ff058ba7.js"><link rel="prefetch" href="/assets/js/46.5a74f2cd.js"><link rel="prefetch" href="/assets/js/47.5931bb97.js"><link rel="prefetch" href="/assets/js/48.cbf85ab3.js"><link rel="prefetch" href="/assets/js/49.0319f8e4.js"><link rel="prefetch" href="/assets/js/5.d0d45788.js"><link rel="prefetch" href="/assets/js/50.497cb73f.js"><link rel="prefetch" href="/assets/js/51.4b6e5c5b.js"><link rel="prefetch" href="/assets/js/52.f4edf34f.js"><link rel="prefetch" href="/assets/js/53.df9c0557.js"><link rel="prefetch" href="/assets/js/54.1654be3b.js"><link rel="prefetch" href="/assets/js/55.c9e37e1f.js"><link rel="prefetch" href="/assets/js/56.052c5808.js"><link rel="prefetch" href="/assets/js/57.cf8cebef.js"><link rel="prefetch" href="/assets/js/59.7e76271a.js"><link rel="prefetch" href="/assets/js/6.b5583d51.js"><link rel="prefetch" href="/assets/js/60.38c88311.js"><link rel="prefetch" href="/assets/js/61.c4b0da1c.js"><link rel="prefetch" href="/assets/js/62.d8be952c.js"><link rel="prefetch" href="/assets/js/63.19c02fd0.js"><link rel="prefetch" href="/assets/js/64.9d51d342.js"><link rel="prefetch" href="/assets/js/65.31c63e7c.js"><link rel="prefetch" href="/assets/js/66.badcb6df.js"><link rel="prefetch" href="/assets/js/67.83764c63.js"><link rel="prefetch" href="/assets/js/68.152c45b6.js"><link rel="prefetch" href="/assets/js/69.2119cafb.js"><link rel="prefetch" href="/assets/js/7.d21b1042.js"><link rel="prefetch" href="/assets/js/70.ff7211f3.js"><link rel="prefetch" href="/assets/js/71.26e7783e.js"><link rel="prefetch" href="/assets/js/72.dc5a3ba6.js"><link rel="prefetch" href="/assets/js/73.d8356ad1.js"><link rel="prefetch" href="/assets/js/74.10184aff.js"><link rel="prefetch" href="/assets/js/75.716811ca.js"><link rel="prefetch" href="/assets/js/76.046e6155.js"><link rel="prefetch" href="/assets/js/77.d287e80f.js"><link rel="prefetch" href="/assets/js/78.635ed9d3.js"><link rel="prefetch" href="/assets/js/79.4485123f.js"><link rel="prefetch" href="/assets/js/8.8bd3dfa9.js"><link rel="prefetch" href="/assets/js/80.74fc122c.js"><link rel="prefetch" href="/assets/js/81.cb3ce31c.js"><link rel="prefetch" href="/assets/js/82.bf81591e.js"><link rel="prefetch" href="/assets/js/83.01b0002d.js"><link rel="prefetch" href="/assets/js/84.6af4ae46.js"><link rel="prefetch" href="/assets/js/85.31122a7c.js"><link rel="prefetch" href="/assets/js/86.7641b1ab.js"><link rel="prefetch" href="/assets/js/87.63912fdd.js"><link rel="prefetch" href="/assets/js/88.01d6d061.js"><link rel="prefetch" href="/assets/js/89.ec494ad7.js"><link rel="prefetch" href="/assets/js/9.17f8341c.js"><link rel="prefetch" href="/assets/js/90.a2905192.js"><link rel="prefetch" href="/assets/js/91.5b1b5e00.js"><link rel="prefetch" href="/assets/js/92.f8112523.js"><link rel="prefetch" href="/assets/js/93.8e9fd5a8.js"><link rel="prefetch" href="/assets/js/94.41217af6.js"><link rel="prefetch" href="/assets/js/95.b253d44f.js"><link rel="prefetch" href="/assets/js/96.76495ed0.js"><link rel="prefetch" href="/assets/js/97.9f48729e.js"><link rel="prefetch" href="/assets/js/98.0e36c4a8.js"><link rel="prefetch" href="/assets/js/99.5b6ab9af.js">
    <link rel="stylesheet" href="/assets/css/0.styles.992cb7aa.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">yiluhuakai</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/leetcode/" class="nav-link">
  LeetCode
</a></div><div class="nav-item"><a href="/golang/" class="nav-link">
  Go
</a></div><div class="nav-item"><a href="/mysql/" class="nav-link">
  Mysql
</a></div><div class="nav-item"><a href="/clang/" class="nav-link">
  C语言
</a></div><div class="nav-item"><a href="/es/" class="nav-link router-link-active">
  前端
</a></div><div class="nav-item"><a href="/nodejs/" class="nav-link">
  nodejs
</a></div><div class="nav-item"><a href="/react/" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/java/" class="nav-link">
  Java
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/leetcode/" class="nav-link">
  LeetCode
</a></div><div class="nav-item"><a href="/golang/" class="nav-link">
  Go
</a></div><div class="nav-item"><a href="/mysql/" class="nav-link">
  Mysql
</a></div><div class="nav-item"><a href="/clang/" class="nav-link">
  C语言
</a></div><div class="nav-item"><a href="/es/" class="nav-link router-link-active">
  前端
</a></div><div class="nav-item"><a href="/nodejs/" class="nav-link">
  nodejs
</a></div><div class="nav-item"><a href="/react/" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/java/" class="nav-link">
  Java
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/es/const_let.html" class="sidebar-link">let和const</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/es/obj.html" class="sidebar-link">对象</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/es/obj.html#对象字面量的增强" class="sidebar-link">对象字面量的增强</a></li><li class="sidebar-sub-header"><a href="/es/obj.html#object-assign" class="sidebar-link">Object.assign</a></li><li class="sidebar-sub-header"><a href="/es/obj.html#object-is" class="sidebar-link">Object.is</a></li><li class="sidebar-sub-header"><a href="/es/obj.html#proxy" class="sidebar-link">Proxy</a></li><li class="sidebar-sub-header"><a href="/es/obj.html#reflect" class="sidebar-link">Reflect</a></li><li class="sidebar-sub-header"><a href="/es/obj.html#promise" class="sidebar-link">Promise</a></li><li class="sidebar-sub-header"><a href="/es/obj.html#class" class="sidebar-link">Class</a></li></ul></li><li><a href="/es/func.html" class="sidebar-link">函数</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/es/func.html#默认值参数" class="sidebar-link">默认值参数</a></li><li class="sidebar-sub-header"><a href="/es/func.html#剩余参数" class="sidebar-link">剩余参数</a></li><li class="sidebar-sub-header"><a href="/es/func.html#数组的解构" class="sidebar-link">数组的解构</a></li><li class="sidebar-sub-header"><a href="/es/func.html#箭头函数" class="sidebar-link">箭头函数</a></li></ul></li><li><a href="/es/string.html" class="sidebar-link">ES中的模版字符串</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/es/string.html#es中的模版字符串" class="sidebar-link">ES中的模版字符串</a></li><li class="sidebar-sub-header"><a href="/es/string.html#es2015中新增的关于操作字符串的方法" class="sidebar-link">ES2015中新增的关于操作字符串的方法</a></li></ul></li><li><a href="/es/set_map.html" class="sidebar-link">set 和 map</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/es/set_map.html#set" class="sidebar-link">set</a></li><li class="sidebar-sub-header"><a href="/es/set_map.html#map" class="sidebar-link">map</a></li></ul></li><li><a href="/es/deconstruction.html" class="sidebar-link">解构</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/es/deconstruction.html#数组的解构" class="sidebar-link">数组的解构</a></li><li class="sidebar-sub-header"><a href="/es/deconstruction.html#对象的解构" class="sidebar-link">对象的解构</a></li><li class="sidebar-sub-header"><a href="/es/deconstruction.html#字符串的解构" class="sidebar-link">字符串的解构</a></li></ul></li><li><a href="/es/Symbol.html" class="sidebar-link">Symbol</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/es/for_of.html" class="sidebar-link">for..of 和迭代器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/es/for_of.html#for-of-和迭代器" class="sidebar-link">for..of 和迭代器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/es/for_of.html#for-of-循环" class="sidebar-link">for ... of 循环</a></li><li class="sidebar-sub-header"><a href="/es/for_of.html#迭代器模式和迭代器" class="sidebar-link">迭代器模式和迭代器</a></li><li class="sidebar-sub-header"><a href="/es/for_of.html#生成器函数" class="sidebar-link">生成器函数</a></li></ul></li></ul></li><li><a href="/es/es2016_17.html" class="sidebar-link">ES2016和ES2017新特性</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/es/es2016_17.html#es2016和es2017新特性" class="sidebar-link">ES2016和ES2017新特性</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/es/es2016_17.html#es2016" class="sidebar-link">ES2016</a></li><li class="sidebar-sub-header"><a href="/es/es2016_17.html#es2017" class="sidebar-link">ES2017</a></li></ul></li></ul></li><li><a href="/es/Ts.html" class="sidebar-link">TypeScript</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/es/Ts.html#typescript" class="sidebar-link">TypeScript</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/es/Ts.html#强类型和弱类型" class="sidebar-link">强类型和弱类型</a></li><li class="sidebar-sub-header"><a href="/es/Ts.html#typescript简介" class="sidebar-link">TypeScript简介</a></li><li class="sidebar-sub-header"><a href="/es/Ts.html#typescript上手" class="sidebar-link">TypeScript上手</a></li><li class="sidebar-sub-header"><a href="/es/Ts.html#ts的原始类型" class="sidebar-link">ts的原始类型</a></li><li class="sidebar-sub-header"><a href="/es/Ts.html#中文错误消息" class="sidebar-link">中文错误消息</a></li><li class="sidebar-sub-header"><a href="/es/Ts.html#ts作用域问题" class="sidebar-link">TS作用域问题</a></li><li class="sidebar-sub-header"><a href="/es/Ts.html#ts中的类型注解" class="sidebar-link">TS中的类型注解</a></li><li class="sidebar-sub-header"><a href="/es/Ts.html#ts的polyfill-垫片" class="sidebar-link">TS的polyfill(垫片)</a></li><li class="sidebar-sub-header"><a href="/es/Ts.html#在vue项目中加入ts-https-cn-vuejs-org-v2-guide-typescript-html" class="sidebar-link">[在vue项目中加入ts]（https://cn.vuejs.org/v2/guide/typescript.html）</a></li><li class="sidebar-sub-header"><a href="/es/Ts.html#标注-prop" class="sidebar-link" style="padding-left:3rem;">标注 Prop</a></li><li class="sidebar-sub-header"><a href="/es/Ts.html#再已有的js项目中加入类型验https-cloud-tencent-com-developer-article-1006180" class="sidebar-link">再已有的JS项目中加入类型验https://cloud.tencent.com/developer/article/1006180</a></li></ul></li></ul></li><li><a href="/es/flow.html" class="sidebar-link">flow</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/es/flow.html#flow" class="sidebar-link">flow</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/es/flow.html#flow的使用" class="sidebar-link">flow的使用</a></li><li class="sidebar-sub-header"><a href="/es/flow.html#flow的语法规则" class="sidebar-link">flow的语法规则</a></li><li class="sidebar-sub-header"><a href="/es/flow.html#flow类型文档" class="sidebar-link">flow类型文档</a></li><li class="sidebar-sub-header"><a href="/es/flow.html#运行环境api" class="sidebar-link">运行环境api</a></li></ul></li></ul></li><li><a href="/es/js-better.html" class="sidebar-link">JS性能优化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/es/js-better.html#js性能优化" class="sidebar-link">JS性能优化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/es/js-better.html#什么是性能优化" class="sidebar-link">什么是性能优化</a></li><li class="sidebar-sub-header"><a href="/es/js-better.html#js的内存管理" class="sidebar-link">JS的内存管理</a></li><li class="sidebar-sub-header"><a href="/es/js-better.html#js的垃圾回收" class="sidebar-link">JS的垃圾回收</a></li><li class="sidebar-sub-header"><a href="/es/js-better.html#gc的定义与作用" class="sidebar-link">GC的定义与作用</a></li><li class="sidebar-sub-header"><a href="/es/js-better.html#gc里面的垃圾" class="sidebar-link">GC里面的垃圾</a></li><li class="sidebar-sub-header"><a href="/es/js-better.html#gc算法" class="sidebar-link">GC算法</a></li><li class="sidebar-sub-header"><a href="/es/js-better.html#常见的gc算法" class="sidebar-link">常见的GC算法</a></li><li class="sidebar-sub-header"><a href="/es/js-better.html#引用计数算法" class="sidebar-link">引用计数算法</a></li><li class="sidebar-sub-header"><a href="/es/js-better.html#标记清除算法" class="sidebar-link">标记清除算法</a></li><li class="sidebar-sub-header"><a href="/es/js-better.html#标记整理算法" class="sidebar-link">标记整理算法</a></li><li class="sidebar-sub-header"><a href="/es/js-better.html#v8介绍" class="sidebar-link">V8介绍</a></li><li class="sidebar-sub-header"><a href="/es/js-better.html#v8的垃圾回收" class="sidebar-link">v8的垃圾回收</a></li><li class="sidebar-sub-header"><a href="/es/js-better.html#使用performance" class="sidebar-link">使用performance</a></li><li class="sidebar-sub-header"><a href="/es/js-better.html#如何判断是否存在频繁的gc" class="sidebar-link">如何判断是否存在频繁的GC</a></li><li class="sidebar-sub-header"><a href="/es/js-better.html#频繁gc的带来的问题" class="sidebar-link">频繁GC的带来的问题</a></li><li class="sidebar-sub-header"><a href="/es/js-better.html#代码优化介绍" class="sidebar-link">代码优化介绍</a></li><li class="sidebar-sub-header"><a href="/es/js-better.html#遍历对象" class="sidebar-link">遍历对象</a></li></ul></li></ul></li><li><a href="/es/project.html" class="sidebar-link">前端工程化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/es/project.html#前端工程化" class="sidebar-link">前端工程化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/es/project.html#前端工程化的目的" class="sidebar-link">前端工程化的目的</a></li><li class="sidebar-sub-header"><a href="/es/project.html#前端工程化的表现" class="sidebar-link">前端工程化的表现</a></li><li class="sidebar-sub-header"><a href="/es/project.html#一些成熟的工程化集成" class="sidebar-link">一些成熟的工程化集成</a></li><li class="sidebar-sub-header"><a href="/es/project.html#脚手架工具" class="sidebar-link">脚手架工具</a></li><li class="sidebar-sub-header"><a href="/es/project.html#常用的脚手架工具" class="sidebar-link">常用的脚手架工具</a></li><li class="sidebar-sub-header"><a href="/es/project.html#yeoman的使用" class="sidebar-link">yeoman的使用</a></li><li class="sidebar-sub-header"><a href="/es/project.html#自定义generator" class="sidebar-link">自定义generator</a></li><li class="sidebar-sub-header"><a href="/es/project.html#创建一个vue-js的脚手架" class="sidebar-link">创建一个vue.js的脚手架</a></li><li class="sidebar-sub-header"><a href="/es/project.html#plop脚手架" class="sidebar-link">plop脚手架</a></li><li class="sidebar-sub-header"><a href="/es/project.html#plop的使用" class="sidebar-link">plop的使用</a></li><li class="sidebar-sub-header"><a href="/es/project.html#使用plop在react中创建组件" class="sidebar-link">使用plop在react中创建组件</a></li><li class="sidebar-sub-header"><a href="/es/project.html#脚手架的工具原理" class="sidebar-link">脚手架的工具原理</a></li><li class="sidebar-sub-header"><a href="/es/project.html#脚手架具体实现" class="sidebar-link">脚手架具体实现</a></li><li class="sidebar-sub-header"><a href="/es/project.html#自动化构建" class="sidebar-link">自动化构建</a></li><li class="sidebar-sub-header"><a href="/es/project.html#自动化构建初体验" class="sidebar-link">自动化构建初体验</a></li><li class="sidebar-sub-header"><a href="/es/project.html#常用的自动化构建工具" class="sidebar-link">常用的自动化构建工具</a></li><li class="sidebar-sub-header"><a href="/es/project.html#grunt的基本使用" class="sidebar-link">grunt的基本使用</a></li><li class="sidebar-sub-header"><a href="/es/project.html#grunt常用插件的使用" class="sidebar-link">grunt常用插件的使用</a></li><li class="sidebar-sub-header"><a href="/es/project.html#gulp的使用" class="sidebar-link">gulp的使用</a></li><li class="sidebar-sub-header"><a href="/es/project.html#创建项目目录并进入" class="sidebar-link" style="padding-left:3rem;">创建项目目录并进入</a></li><li class="sidebar-sub-header"><a href="/es/project.html#在项目目录下创建-package-json-文件" class="sidebar-link" style="padding-left:3rem;">在项目目录下创建 package.json 文件</a></li><li class="sidebar-sub-header"><a href="/es/project.html#安装-gulp-作为开发时依赖项" class="sidebar-link" style="padding-left:3rem;">安装 gulp，作为开发时依赖项</a></li><li class="sidebar-sub-header"><a href="/es/project.html#创建-gulpfile-文件" class="sidebar-link" style="padding-left:3rem;">创建 gulpfile 文件</a></li><li class="sidebar-sub-header"><a href="/es/project.html#测试" class="sidebar-link" style="padding-left:3rem;">测试</a></li><li class="sidebar-sub-header"><a href="/es/project.html#gulp的组合任务" class="sidebar-link" style="padding-left:3rem;">gulp的组合任务</a></li><li class="sidebar-sub-header"><a href="/es/project.html#测试-2" class="sidebar-link" style="padding-left:3rem;">测试</a></li><li class="sidebar-sub-header"><a href="/es/project.html#gulp的异步任务" class="sidebar-link" style="padding-left:3rem;">gulp的异步任务</a></li><li class="sidebar-sub-header"><a href="/es/project.html#gulp的核心工作原理" class="sidebar-link">gulp的核心工作原理</a></li><li class="sidebar-sub-header"><a href="/es/project.html#gulp中关系文件的api" class="sidebar-link">gulp中关系文件的API</a></li><li class="sidebar-sub-header"><a href="/es/project.html#fis-fis3" class="sidebar-link" style="padding-left:3rem;">fis(fis3)</a></li></ul></li></ul></li><li><a href="/es/gulp-demo.html" class="sidebar-link">使用gulp构建一个web项目</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/es/gulp-demo.html#使用gulp构建一个web项目" class="sidebar-link">使用gulp构建一个web项目</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/es/gulp-demo.html#安装gulp的依赖" class="sidebar-link" style="padding-left:3rem;">安装gulp的依赖</a></li><li class="sidebar-sub-header"><a href="/es/gulp-demo.html#使用gulp-sass插件对样式文件做处理" class="sidebar-link" style="padding-left:3rem;">使用gulp-sass插件对样式文件做处理</a></li><li class="sidebar-sub-header"><a href="/es/gulp-demo.html#配置gulpfile-js文件" class="sidebar-link" style="padding-left:3rem;">配置gulpfile.js文件</a></li><li class="sidebar-sub-header"><a href="/es/gulp-demo.html#测试" class="sidebar-link" style="padding-left:3rem;">测试</a></li><li class="sidebar-sub-header"><a href="/es/gulp-demo.html#使用gulp-babel转换es语法-安装依赖" class="sidebar-link" style="padding-left:3rem;">使用gulp-babel转换ES语法，安装依赖</a></li><li class="sidebar-sub-header"><a href="/es/gulp-demo.html#在gulpfile-js中加入下面的内容" class="sidebar-link" style="padding-left:3rem;">在gulpfile.js中加入下面的内容</a></li><li class="sidebar-sub-header"><a href="/es/gulp-demo.html#测试-2" class="sidebar-link" style="padding-left:3rem;">测试</a></li><li class="sidebar-sub-header"><a href="/es/gulp-demo.html#使用gulp-swim处理html模版文件" class="sidebar-link" style="padding-left:3rem;">使用gulp-swim处理html模版文件</a></li><li class="sidebar-sub-header"><a href="/es/gulp-demo.html#安装gulp-swim的依赖" class="sidebar-link" style="padding-left:3rem;">安装gulp-swim的依赖</a></li><li class="sidebar-sub-header"><a href="/es/gulp-demo.html#修改gulpfile-js文件" class="sidebar-link" style="padding-left:3rem;">修改gulpfile.js文件</a></li><li class="sidebar-sub-header"><a href="/es/gulp-demo.html#测试-3" class="sidebar-link" style="padding-left:3rem;">测试</a></li><li class="sidebar-sub-header"><a href="/es/gulp-demo.html#让上面的三个任务同时执行" class="sidebar-link" style="padding-left:3rem;">让上面的三个任务同时执行</a></li><li class="sidebar-sub-header"><a href="/es/gulp-demo.html#测试-4" class="sidebar-link" style="padding-left:3rem;">测试</a></li><li class="sidebar-sub-header"><a href="/es/gulp-demo.html#处理图片和字体文件" class="sidebar-link" style="padding-left:3rem;">处理图片和字体文件</a></li><li class="sidebar-sub-header"><a href="/es/gulp-demo.html#复制public下的文件" class="sidebar-link" style="padding-left:3rem;">复制public下的文件</a></li><li class="sidebar-sub-header"><a href="/es/gulp-demo.html#清除dist目录下的文件" class="sidebar-link" style="padding-left:3rem;">清除dist目录下的文件</a></li><li class="sidebar-sub-header"><a href="/es/gulp-demo.html#自动加载插件" class="sidebar-link" style="padding-left:3rem;">自动加载插件</a></li><li class="sidebar-sub-header"><a href="/es/gulp-demo.html#构建一个开发服务器" class="sidebar-link" style="padding-left:3rem;">构建一个开发服务器</a></li><li class="sidebar-sub-header"><a href="/es/gulp-demo.html#处理生产环境的路径问题" class="sidebar-link" style="padding-left:3rem;">处理生产环境的路径问题</a></li><li class="sidebar-sub-header"><a href="/es/gulp-demo.html#删除gulpfile中不需要到处的任务" class="sidebar-link" style="padding-left:3rem;">删除gulpfile中不需要到处的任务</a></li><li class="sidebar-sub-header"><a href="/es/gulp-demo.html#自动化工作流的复用" class="sidebar-link" style="padding-left:3rem;">自动化工作流的复用</a></li><li class="sidebar-sub-header"><a href="/es/gulp-demo.html#工作流的封装" class="sidebar-link" style="padding-left:3rem;">工作流的封装</a></li><li class="sidebar-sub-header"><a href="/es/gulp-demo.html#发布我们的包到npm" class="sidebar-link" style="padding-left:3rem;">发布我们的包到npm</a></li><li class="sidebar-sub-header"><a href="/es/gulp-demo.html#在项目中使用我们发布的包" class="sidebar-link" style="padding-left:3rem;">在项目中使用我们发布的包</a></li></ul></li></ul></li><li><a href="/es/this.html" class="sidebar-link">this 的指向</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/es/module.html" class="sidebar-link">模块化的发展历程</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/es/webpack.html" class="sidebar-link">webpack</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/es/webpack2.html" class="sidebar-link">使用webpack去增强开发体验</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/es/rollup.html" class="sidebar-link">rollup</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/es/ruler.html" class="sidebar-link">前端规范化</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/es/webpack-source.html" class="sidebar-link">webpack源码分析</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/es/webpack3.html" aria-current="page" class="active sidebar-link">webpack和tapable</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/es/webpack4.html" class="sidebar-link">webpack的打包入口</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/es/webpack5.html" class="sidebar-link">手写 webpack源码</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/es/webpack6.html" class="sidebar-link">webpack源码分析（二）</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/es/webpack7.html" class="sidebar-link">处理模块依赖</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/es/debound.html" class="sidebar-link">防抖和节流</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/es/vue_router.html" class="sidebar-link">VueRouter</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/es/vue-observer.html" class="sidebar-link">Vue.js响应式原理</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/es/virtual-dom.html" class="sidebar-link">虚拟dom</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/es/vuejs-source.html" class="sidebar-link">Vue 源码解析 响应式原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#课程目标" class="sidebar-link">课程目标</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#准备工作" class="sidebar-link">准备工作</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#源码目录结构" class="sidebar-link">源码目录结构</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#了解-flow" class="sidebar-link">了解 Flow</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#调试设置" class="sidebar-link">调试设置</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#打包" class="sidebar-link" style="padding-left:3rem;">打包</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#调试" class="sidebar-link" style="padding-left:3rem;">调试</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#vue-的不同构建版本" class="sidebar-link">Vue 的不同构建版本</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#术语" class="sidebar-link" style="padding-left:3rem;">术语</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#runtime-compiler-vs-runtime-only" class="sidebar-link">Runtime + Compiler vs. Runtime-only</a></li></ul></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#寻找入口文件" class="sidebar-link">寻找入口文件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#执行构建" class="sidebar-link">执行构建</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#结果" class="sidebar-link">结果</a></li></ul></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#从入口开始" class="sidebar-link">从入口开始</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#通过查看源码解决下面问题" class="sidebar-link">通过查看源码解决下面问题</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#vue-的构造函数在哪里" class="sidebar-link">Vue 的构造函数在哪里</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#四个导出-vue-的模块" class="sidebar-link">四个导出 Vue 的模块</a></li></ul></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#vue-的初始化" class="sidebar-link">Vue 的初始化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#src-core-global-api-index-js" class="sidebar-link">src/core/global-api/index.js</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#src-core-instance-index-js" class="sidebar-link">src/core/instance/index.js</a></li></ul></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#首次渲染过程" class="sidebar-link">首次渲染过程</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#数据响应式原理" class="sidebar-link">数据响应式原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#通过查看源码解决下面问题-2" class="sidebar-link">通过查看源码解决下面问题</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#响应式处理的入口" class="sidebar-link">响应式处理的入口</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#observer" class="sidebar-link">Observer</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#definereactive" class="sidebar-link">defineReactive()</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#对象响应式处理" class="sidebar-link" style="padding-left:3rem;">对象响应式处理</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#数组的响应式处理" class="sidebar-link" style="padding-left:3rem;">数组的响应式处理</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#dep-类" class="sidebar-link">Dep 类</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#watcher-类" class="sidebar-link">Watcher 类</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#调试响应式数据执行过程" class="sidebar-link">调试响应式数据执行过程</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#回答以下问题" class="sidebar-link">回答以下问题</a></li></ul></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#实例方法-数据" class="sidebar-link">实例方法/数据</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#vm-set" class="sidebar-link">vm.\$set</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#定义位置" class="sidebar-link" style="padding-left:3rem;">定义位置</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#源码" class="sidebar-link" style="padding-left:3rem;">源码</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#调试-2" class="sidebar-link" style="padding-left:3rem;">调试</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#vm-delete" class="sidebar-link">vm.\$delete</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#定义位置-2" class="sidebar-link" style="padding-left:3rem;">定义位置</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#源码-2" class="sidebar-link" style="padding-left:3rem;">源码</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#vm-watch" class="sidebar-link">vm.\$watch</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#三种类型的-watcher-对象" class="sidebar-link" style="padding-left:3rem;">三种类型的 Watcher 对象</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#源码-3" class="sidebar-link" style="padding-left:3rem;">源码</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#调试-3" class="sidebar-link" style="padding-left:3rem;">调试</a></li></ul></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#异步更新队列-nexttick" class="sidebar-link">异步更新队列-nextTick()</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#vm-nexttick-代码演示" class="sidebar-link">vm.\$nextTick() 代码演示</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#定义位置-3" class="sidebar-link">定义位置</a></li><li class="sidebar-sub-header"><a href="/es/vuejs-source.html#源码-4" class="sidebar-link">源码</a></li></ul></li></ul></li><li><a href="/es/bind.html" class="sidebar-link">Function.prototype.bind()</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/es/circleDep.html" class="sidebar-link">循环依赖</a><ul class="sidebar-sub-headers"></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h4 id="webpack和tapable"><a href="#webpack和tapable" class="header-anchor">#</a> webpack和tapable</h4> <h4 id="webpack的编译流程"><a href="#webpack的编译流程" class="header-anchor">#</a> webpack的编译流程</h4> <ul><li>配置初始化</li> <li>编译内容</li> <li>输出编译后的内容</li></ul> <p><code>webpack</code>的工作机制可以看作事件驱动的事件工作流机制，将不同的插件串联了起来。 <code>webpack</code>的底层大量用到了<code>tapable</code>库，比如负责编译的<code>compiler</code>,负责创建<code>bundles</code>的<code>compilation</code>，都是<code>tapable</code>中的实例。</p> <p><code>tapable</code>本身就是一个独立的库，<code>tapable</code>的工作流程：</p> <ul><li>实例化<code>hook</code>去注册事件监听</li> <li>通过<code>hook</code>去触发事件监听</li> <li>执行懒编译生成的核心代码</li></ul> <h4 id="hook"><a href="#hook" class="header-anchor">#</a> Hook</h4> <p><code>hook</code>本身就是<code>tapable</code>中的实例对象。<code>hook</code>根据不同的执行机制可以分成同步和异步<code>hook</code>.</p> <p><code>Hook</code>的执行特点：</p> <ul><li><code>Hook</code>:普通钩子，监听器之间互相独立不干扰</li> <li><code>BailHook</code>:熔断钩子，某个监听返回非<code>undefined</code>时后续不执行</li> <li><code>WaterfallHook</code>:瀑布钩子，上一个监听的返回值可以传递到下一个钩子中</li> <li><code>LoopHook</code>：如果当前未返回<code>false</code>,则一直执行</li></ul> <p><code>tapable</code>库的同步钩子</p> <ul><li>SyncHook</li> <li>SyncBailHook</li> <li>SyncWaterfallHook</li> <li>SyncLoopHook</li></ul> <p><code>tapable</code>库中的串行异步钩子</p> <ul><li>AsyncSeriesHook</li> <li>AsyncSeriesBailHook</li> <li>AsyncSeriesWaterfallHook</li></ul> <p><code>tapable</code>库中的并行异步钩子</p> <ul><li>AsyncParalleHook</li> <li>AsyncParalleBailHook</li></ul> <h4 id="同步hook的基本使用"><a href="#同步hook的基本使用" class="header-anchor">#</a> 同步Hook的基本使用</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">mkdir</span> syncHook <span class="token operator">&amp;</span> <span class="token builtin class-name">cd</span> syncHook 
<span class="token function">npm</span> init -y
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>安装依赖：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">npm</span> <span class="token function">install</span> tapable -D
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>在<code>01_sync_hook.js</code>中使用<code>SyncHook</code>:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> SyncHook <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span>

<span class="token comment">// 创建一个SyncHook实例</span>
<span class="token keyword">const</span> sh <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'age'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment">// 注册监听事件</span>
sh<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'fn1'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn1'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

sh<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'fn2'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn2'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

sh<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'fn3'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn3'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">sh</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'yiluhuakai'</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>使用<code>node</code>执行：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ node 01_sync_hook.js
fn1 yiluhuakai <span class="token number">25</span>
fn2 yiluhuakai <span class="token number">25</span>
fn3 yiluhuakai <span class="token number">25</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>在<code>02-sync-bail-hook.js</code>中使用<code>SyncBailHook</code>:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> SyncBailHook <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span>

<span class="token comment">// 创建一个SyncHook实例</span>
<span class="token keyword">const</span> sh <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncBailHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'age'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment">// 注册监听事件</span>
sh<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'fn1'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn1'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

sh<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'fn2'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn2'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

sh<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'fn3'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn3'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">sh</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'yiluhuakai'</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p><code>node</code>中执行：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ node 02_sync_bail_hook.js 
fn1 yiluhuakai <span class="token number">25</span>
fn2 yiluhuakai <span class="token number">25</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>当一个监听返回非<code>undefined</code>后序的钩子终止执行。</p> <p>在<code>03-sync-waterfall-hook.js</code>中使用<code>SyncWaterfallHook</code>:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> SyncWaterfallHook <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span>

<span class="token comment">// 创建一个SyncHook实例</span>
<span class="token keyword">const</span> sh <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncWaterfallHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'age'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment">// 注册监听事件</span>
sh<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'fn1'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn1'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token string">'z1'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

sh<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'fn2'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn2'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token string">'z2'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

sh<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'fn3'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn3'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">sh</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'yiluhuakai'</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p><code>node</code>中的执行结果：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ node 03_sync_waterfall_hook.js 
fn1 yiluhuakai <span class="token number">25</span>
fn2 z1 <span class="token number">25</span>
fn3 z2 <span class="token number">25</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>在<code>04-sync-loop-hook.js</code>中使用<code>SyncLoopHook</code>:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> SyncLoopHook <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span>

<span class="token comment">// 创建一个SyncHook实例</span>
<span class="token keyword">const</span> sh <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncLoopHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'age'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> count1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
	count2 <span class="token operator">=</span> <span class="token number">0</span>
<span class="token comment">// 注册监听事件</span>
sh<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'fn1'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn1'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>count1 <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token keyword">undefined</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

sh<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'fn2'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn2'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

sh<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'fn3'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn3'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">sh</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'yiluhuakai'</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p><code>node中的执行结果</code>：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ node 04_sync_loop_hook.js
fn1 yiluhuakai <span class="token number">25</span>
fn2 yiluhuakai <span class="token number">25</span>
fn3 yiluhuakai <span class="token number">25</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>修改代码继续执行：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> SyncLoopHook <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span>

<span class="token comment">// 创建一个SyncHook实例</span>
<span class="token keyword">const</span> sh <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncLoopHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'age'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> count1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
	count2 <span class="token operator">=</span> <span class="token number">0</span>
<span class="token comment">// 注册监听事件</span>
sh<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'fn1'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn1'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>count1 <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token keyword">undefined</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//return false</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

sh<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'fn2'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn2'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>count2 <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">//count2 = 0</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token keyword">undefined</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

sh<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'fn3'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn3'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">sh</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'yiluhuakai'</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p><code>node</code>中的执行结果：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ node 04_sync_loop_hook.js
fn1 yiluhuakai <span class="token number">25</span>
fn2 yiluhuakai <span class="token number">25</span>
fn1 yiluhuakai <span class="token number">25</span>
fn2 yiluhuakai <span class="token number">25</span>
fn3 yiluhuakai <span class="token number">25</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>通过断点调试可以发现调用执行的代码是实际上执行的是的下面代码：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">anonymous</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> _context<span class="token punctuation">;</span>
<span class="token comment">// this_x = [f1,f2,f3] 代表的是上面的监听函数  </span>
<span class="token keyword">var</span> _x <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_x<span class="token punctuation">;</span>
<span class="token keyword">var</span> _loop<span class="token punctuation">;</span>
<span class="token keyword">do</span> <span class="token punctuation">{</span>
    _loop <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> _fn0 <span class="token operator">=</span> _x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> _result0 <span class="token operator">=</span> <span class="token function">_fn0</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>_result0 <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				_loop <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> _fn1 <span class="token operator">=</span> _x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> _result1 <span class="token operator">=</span> <span class="token function">_fn1</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>_result1 <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     		  _loop <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">var</span> _fn2 <span class="token operator">=</span> _x<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token keyword">var</span> _result2 <span class="token operator">=</span> <span class="token function">_fn2</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span><span class="token punctuation">(</span>_result2 <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
             _loop <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>_loop<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token punctuation">}</span>
		 		<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
	 <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">while</span><span class="token punctuation">(</span>_loop<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>可以看出来只要函数返回值不等于<code>undefined</code>，就会执行循环。</p> <h4 id="异步钩子的使用"><a href="#异步钩子的使用" class="header-anchor">#</a> 异步钩子的使用</h4> <p>异步钩子的监听有三种方式：<code>tap</code>、<code>tapAsync</code>、<code>tapPromise</code>，对应的执行方式：<code>callAsync</code>、<code>callAsync</code>、<code>promise</code></p> <ul><li>AsyncParallelHook</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> AsyncParallelHook <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> asyncHook <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AsyncParallelHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'time'</span><span class="token punctuation">)</span>

asyncHook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'fn1'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn1'</span><span class="token punctuation">,</span> <span class="token string">'---&gt;'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

asyncHook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'fn2'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn1'</span><span class="token punctuation">,</span> <span class="token string">'---&gt;'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

asyncHook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'fn3'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn1'</span><span class="token punctuation">,</span> <span class="token string">'---&gt;'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

asyncHook<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token string">'ylp'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'执行了回调函数'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>在<code>node</code>中的执行结果：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ node 01_async_parallel_hook.js
执行了回调函数
fn1 ---<span class="token operator">&gt;</span> ylp
fn1 ---<span class="token operator">&gt;</span> ylp
fn1 ---<span class="token operator">&gt;</span> ylp
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>代码的触发了钩子的事件监听，但是无法保证回调函数在钩子执行完成后执行。</p> <p>使用<code>tapAsync</code>去注册事件监听：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> AsyncParallelHook <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> asyncHook <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AsyncParallelHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'time'</span><span class="token punctuation">)</span>

asyncHook<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">'fn1'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn1'</span><span class="token punctuation">,</span> <span class="token string">'---&gt;'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
		<span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

asyncHook<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">'fn2'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn2'</span><span class="token punctuation">,</span> <span class="token string">'---&gt;'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
		<span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

asyncHook<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token string">'ylp'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'最后一个钩子执行了'</span><span class="token punctuation">)</span>
	console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'time'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>在<code>node</code>中执行：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ node 01_async_parallel_hook.js
fn1 ---<span class="token operator">&gt;</span> ylp
fn2 ---<span class="token operator">&gt;</span> ylp
最后一个钩子执行了
time: <span class="token number">2010</span>.713ms
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>上面的回调用来告诉<code>hook</code>,钩子中的任务执行完成了。</p> <p>使用<code>tapPromise</code>来注册事件监听：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'time'</span><span class="token punctuation">)</span>

asyncHook<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">'fn1'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
			console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn1'</span><span class="token punctuation">,</span> <span class="token string">'---&gt;'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
			<span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

asyncHook<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">'fn2'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
			console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn2'</span><span class="token punctuation">,</span> <span class="token string">'---&gt;'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
			<span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

asyncHook<span class="token punctuation">.</span><span class="token function">promise</span><span class="token punctuation">(</span><span class="token string">'ylp'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'最后一个钩子执行了'</span><span class="token punctuation">)</span>
	console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'time'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p><code>node</code>中执行：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ node 01_async_parallel_hook.js
fn1 ---<span class="token operator">&gt;</span> ylp
fn2 ---<span class="token operator">&gt;</span> ylp
最后一个钩子执行了
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li><code>AsyncParalleBailHook</code></li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> AsyncParallelBailHook <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> asyncHook <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AsyncParallelBailHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'time'</span><span class="token punctuation">)</span>

asyncHook<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">'fn1'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
			console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn1'</span><span class="token punctuation">,</span> <span class="token string">'---&gt;'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
			<span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

asyncHook<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">'fn2'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
			console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn2'</span><span class="token punctuation">,</span> <span class="token string">'---&gt;'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
			<span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

asyncHook<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">'fn3'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
			console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn3'</span><span class="token punctuation">,</span> <span class="token string">'---&gt;'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
			<span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

asyncHook<span class="token punctuation">.</span><span class="token function">promise</span><span class="token punctuation">(</span><span class="token string">'ylp'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'最后一个钩子执行了'</span><span class="token punctuation">)</span>
	console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'time'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p><code>node</code>中执行的结果：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ node 02_async_parallel_bailhook.js
fn1 ---<span class="token operator">&gt;</span> ylp
fn2 ---<span class="token operator">&gt;</span> ylp
最后一个钩子执行了
time: <span class="token number">2014</span>.157ms
fn3 ---<span class="token operator">&gt;</span> ylp
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>第二个钩子返回了一个非<code>undefined</code>的值，钩子执行完成的回调提前执行。</p> <ul><li>AsyncSeriesHook</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code>
<span class="token keyword">const</span> <span class="token punctuation">{</span> AsyncSeriesHook <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> asyncHook <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">'time'</span><span class="token punctuation">)</span>

asyncHook<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">'fn1'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
			console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn1'</span><span class="token punctuation">,</span> <span class="token string">'---&gt;'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
			<span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

asyncHook<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">'fn2'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
			console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn2'</span><span class="token punctuation">,</span> <span class="token string">'---&gt;'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
			<span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

asyncHook<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">'fn3'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
			console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn3'</span><span class="token punctuation">,</span> <span class="token string">'---&gt;'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
			<span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

asyncHook<span class="token punctuation">.</span><span class="token function">promise</span><span class="token punctuation">(</span><span class="token string">'ylp'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'最后一个钩子执行了'</span><span class="token punctuation">)</span>
	console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">'time'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p><code>node</code>中执行：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ node 03_async_series_hook.js      
fn1 ---<span class="token operator">&gt;</span> ylp
fn2 ---<span class="token operator">&gt;</span> ylp
fn3 ---<span class="token operator">&gt;</span> ylp
最后一个钩子执行了
time: <span class="token number">6017</span>.058ms
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>异步串行钩子的执行过程和同步钩子有点类似。</p> <p>接下来我们对<code>tapable</code>中源码进行调试：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> SyncHook <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span>

<span class="token comment">// 创建一个SyncHook实例</span>
<span class="token keyword">const</span> sh <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'age'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment">// 注册监听事件</span>
sh<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'fn1'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn1'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

sh<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'fn2'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn2'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

sh<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'fn3'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn3'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">sh</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'yiluhuakai'</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>首先执行<code>new SyncHook(['name', 'age'])</code>,进入到函数内部：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// SyncHook.js</span>
<span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> Hook <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./Hook&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> HookCodeFactory <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./HookCodeFactory&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">SyncHookCodeFactory</span> <span class="token keyword">extends</span> <span class="token class-name">HookCodeFactory</span> <span class="token punctuation">{</span>
	<span class="token function">content</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> onError<span class="token punctuation">,</span> onDone<span class="token punctuation">,</span> rethrowIfPossible <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callTapsSeries</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
			<span class="token function-variable function">onError</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">i<span class="token punctuation">,</span> err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">onError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">,</span>
			onDone<span class="token punctuation">,</span>
			rethrowIfPossible
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncHookCodeFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">TAP_ASYNC</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;tapAsync is not supported on a SyncHook&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">TAP_PROMISE</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;tapPromise is not supported on a SyncHook&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">COMPILE</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	factory<span class="token punctuation">.</span><span class="token function">setup</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> factory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">SyncHook</span><span class="token punctuation">(</span><span class="token parameter">args <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token keyword">undefined</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> hook <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hook</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
	hook<span class="token punctuation">.</span>constructor <span class="token operator">=</span> SyncHook<span class="token punctuation">;</span>
	hook<span class="token punctuation">.</span>tapAsync <span class="token operator">=</span> <span class="token constant">TAP_ASYNC</span><span class="token punctuation">;</span>
	hook<span class="token punctuation">.</span>tapPromise <span class="token operator">=</span> <span class="token constant">TAP_PROMISE</span><span class="token punctuation">;</span>
	hook<span class="token punctuation">.</span>compile <span class="token operator">=</span> <span class="token constant">COMPILE</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> hook<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">SyncHook</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> SyncHook<span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><p>在<code>SyncHook.js</code>中我们调用了<code>Hook.js</code>的Hook函数：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Hook</span> <span class="token punctuation">{</span>
	<span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">args <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token keyword">undefined</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>_args <span class="token operator">=</span> args<span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>taps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>interceptors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>_call <span class="token operator">=</span> <span class="token constant">CALL_DELEGATE</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>call <span class="token operator">=</span> <span class="token constant">CALL_DELEGATE</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>_callAsync <span class="token operator">=</span> <span class="token constant">CALL_ASYNC_DELEGATE</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>callAsync <span class="token operator">=</span> <span class="token constant">CALL_ASYNC_DELEGATE</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>_promise <span class="token operator">=</span> <span class="token constant">PROMISE_DELEGATE</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>promise <span class="token operator">=</span> <span class="token constant">PROMISE_DELEGATE</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>_x <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>

		<span class="token keyword">this</span><span class="token punctuation">.</span>compile <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>compile<span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>tap <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tap<span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>tapAsync <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tapAsync<span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>tapPromise <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tapPromise<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">compile</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Abstract: should be overridden&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">_createCall</span><span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
			taps<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>taps<span class="token punctuation">,</span>
			interceptors<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>interceptors<span class="token punctuation">,</span>
			args<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_args<span class="token punctuation">,</span>
			type<span class="token operator">:</span> type
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">_tap</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> options<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> options <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			options <span class="token operator">=</span> <span class="token punctuation">{</span>
				name<span class="token operator">:</span> options<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> options <span class="token operator">!==</span> <span class="token string">&quot;object&quot;</span> <span class="token operator">||</span> options <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Invalid tap options&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> options<span class="token punctuation">.</span>name <span class="token operator">!==</span> <span class="token string">&quot;string&quot;</span> <span class="token operator">||</span> options<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Missing name for tap&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> options<span class="token punctuation">.</span>context <span class="token operator">!==</span> <span class="token string">&quot;undefined&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">deprecateContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		options <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">,</span> fn <span class="token punctuation">}</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
		options <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_runRegisterInterceptors</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_insert</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">tap</span><span class="token punctuation">(</span><span class="token parameter">options<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_tap</span><span class="token punctuation">(</span><span class="token string">&quot;sync&quot;</span><span class="token punctuation">,</span> options<span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token parameter">options<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_tap</span><span class="token punctuation">(</span><span class="token string">&quot;async&quot;</span><span class="token punctuation">,</span> options<span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token parameter">options<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_tap</span><span class="token punctuation">(</span><span class="token string">&quot;promise&quot;</span><span class="token punctuation">,</span> options<span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br></div></div><p>我们创建<code>SyncHook</code>实例的过程实际上我们先调用<code>new Hook</code>创建一个实例，然后对实例上的一些方法、属性做了重写：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">SyncHook</span><span class="token punctuation">(</span><span class="token parameter">args <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token keyword">undefined</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> hook <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hook</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
	hook<span class="token punctuation">.</span>constructor <span class="token operator">=</span> SyncHook<span class="token punctuation">;</span>
	hook<span class="token punctuation">.</span>tapAsync <span class="token operator">=</span> <span class="token constant">TAP_ASYNC</span><span class="token punctuation">;</span>
	hook<span class="token punctuation">.</span>tapPromise <span class="token operator">=</span> <span class="token constant">TAP_PROMISE</span><span class="token punctuation">;</span>
	hook<span class="token punctuation">.</span>compile <span class="token operator">=</span> <span class="token constant">COMPILE</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> hook<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>然后我们执行<code>tap</code>方法去注册第一个事件监听：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>sh<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'fn1'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn1'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// Hook.js</span>
<span class="token comment">/*
	type:'sync',
	options:'fn1'
	fn:function (name, age) {
	console.log('fn1', name, age)
}) 
*/</span>
<span class="token function">_tap</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> options<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> options <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    options <span class="token operator">=</span> <span class="token punctuation">{</span>
      name<span class="token operator">:</span> options<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> options <span class="token operator">!==</span> <span class="token string">&quot;object&quot;</span> <span class="token operator">||</span> options <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Invalid tap options&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> options<span class="token punctuation">.</span>name <span class="token operator">!==</span> <span class="token string">&quot;string&quot;</span> <span class="token operator">||</span> options<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Missing name for tap&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> options<span class="token punctuation">.</span>context <span class="token operator">!==</span> <span class="token string">&quot;undefined&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">deprecateContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  options <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">,</span> fn <span class="token punctuation">}</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  options <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_runRegisterInterceptors</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_insert</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">tap</span><span class="token punctuation">(</span><span class="token parameter">options<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_tap</span><span class="token punctuation">(</span><span class="token string">&quot;sync&quot;</span><span class="token punctuation">,</span> options<span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p><code>_tap</code>方法会将上面的参数转换成一个<code>options</code>对象,然后去执行<code>this._insert</code>方法：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>options <span class="token operator">=</span><span class="token punctuation">{</span>
  type<span class="token operator">:</span><span class="token string">'sync'</span><span class="token punctuation">,</span>
  name<span class="token operator">:</span><span class="token string">'fn1'</span><span class="token punctuation">,</span>
  <span class="token function-variable function">fn</span><span class="token operator">:</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn1'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span> 
<span class="token punctuation">}</span> 
<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_insert</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// Hook.js</span>

	<span class="token function">_insert</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_resetCompilation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">let</span> before<span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> item<span class="token punctuation">.</span>before <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			before <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span>item<span class="token punctuation">.</span>before<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>before<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			before <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>before<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">let</span> stage <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> item<span class="token punctuation">.</span>stage <span class="token operator">===</span> <span class="token string">&quot;number&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			stage <span class="token operator">=</span> item<span class="token punctuation">.</span>stage<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>taps<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
		<span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			i<span class="token operator">--</span><span class="token punctuation">;</span>
			<span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>taps<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>taps<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> x<span class="token punctuation">;</span>
			<span class="token keyword">const</span> xStage <span class="token operator">=</span> x<span class="token punctuation">.</span>stage <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>before<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>before<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					before<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">continue</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>before<span class="token punctuation">.</span>size <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token keyword">continue</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>xStage <span class="token operator">&gt;</span> stage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">continue</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			i<span class="token operator">++</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>taps<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> item<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p>执行<code>_insert</code>方法，会将上面的<code>options</code>放到数组的第一个位置。后面我们继续执行下面的<code>tap</code>方法，会将新的<code>options</code>添加到<code>this.taps</code>中：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>
sh<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'fn2'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn2'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

sh<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'fn3'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn3'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>然后我们去触发钩子：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">sh</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'yiluhuakai'</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>会进入到<code>Hook.js</code>中执行<code>CALL_DELEGATE</code>,原因是<code>new Hook</code>时执行了<code>this.call = CALL_DELEGATE;</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// this.call = CALL_DELEGATE;</span>
<span class="token keyword">const</span> <span class="token function-variable function">CALL_DELEGATE</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>call <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_createCall</span><span class="token punctuation">(</span><span class="token string">&quot;sync&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">_createCall</span><span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
			taps<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>taps<span class="token punctuation">,</span>
			interceptors<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>interceptors<span class="token punctuation">,</span>
			args<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_args<span class="token punctuation">,</span>
			type<span class="token operator">:</span> type
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>执行<code>this._createCall(&quot;sync&quot;)</code>后<code>this.call</code>被赋值了<code>this.compile</code>的返回值：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
			taps<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>taps<span class="token punctuation">,</span>
			interceptors<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>interceptors<span class="token punctuation">,</span>
			args<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_args<span class="token punctuation">,</span>
			type<span class="token operator">:</span> type
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// SyncHook.js</span>

<span class="token comment">//hook.compile = COMPILE;</span>
<span class="token keyword">const</span> <span class="token function-variable function">COMPILE</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	factory<span class="token punctuation">.</span><span class="token function">setup</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> factory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>上面的<code>factory</code>是<code>SyncHookCodeFactory</code>的实例：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// SyncHook.js</span>
<span class="token keyword">const</span> Hook <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./Hook&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> HookCodeFactory <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./HookCodeFactory&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">SyncHookCodeFactory</span> <span class="token keyword">extends</span> <span class="token class-name">HookCodeFactory</span> <span class="token punctuation">{</span>
	<span class="token function">content</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> onError<span class="token punctuation">,</span> onDone<span class="token punctuation">,</span> rethrowIfPossible <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callTapsSeries</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
			<span class="token function-variable function">onError</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">i<span class="token punctuation">,</span> err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">onError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">,</span>
			onDone<span class="token punctuation">,</span>
			rethrowIfPossible
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncHookCodeFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>执行<code>factory.setup(this, options);</code>:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 	HookCodeFactory.js</span>

<span class="token comment">// instance = Hook对象</span>
<span class="token comment">/* options={
			taps: this.taps,
			interceptors: this.interceptors,
			args: this._args,
			type: type
		}
*/</span>		
<span class="token function">setup</span><span class="token punctuation">(</span><span class="token parameter">instance<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		instance<span class="token punctuation">.</span>_x <span class="token operator">=</span> options<span class="token punctuation">.</span>taps<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">t</span> <span class="token operator">=&gt;</span> t<span class="token punctuation">.</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>执行完<code>setup</code>方法相当于将<code>this._x =this.taps.map(t =&gt; t.fn);</code>然后去执行：<code>return factory.create(options);</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 	HookCodeFactory.js</span>


	<span class="token function">create</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">let</span> fn<span class="token punctuation">;</span>
		<span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">case</span> <span class="token string">&quot;sync&quot;</span><span class="token operator">:</span>
				fn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span>
					<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">args</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
					<span class="token string">'&quot;use strict&quot;;\n'</span> <span class="token operator">+</span>
						<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
						<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">contentWithInterceptors</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
							<span class="token function-variable function">onError</span><span class="token operator">:</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">throw </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>err<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
							<span class="token function-variable function">onResult</span><span class="token operator">:</span> <span class="token parameter">result</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">return </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>result<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
							resultReturns<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
							<span class="token function-variable function">onDone</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
							rethrowIfPossible<span class="token operator">:</span> <span class="token boolean">true</span>
						<span class="token punctuation">}</span><span class="token punctuation">)</span>
				<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> <span class="token string">&quot;async&quot;</span><span class="token operator">:</span>
				fn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span>
					<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">args</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
						after<span class="token operator">:</span> <span class="token string">&quot;_callback&quot;</span>
					<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
					<span class="token string">'&quot;use strict&quot;;\n'</span> <span class="token operator">+</span>
						<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
						<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">contentWithInterceptors</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
							<span class="token function-variable function">onError</span><span class="token operator">:</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_callback(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>err<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">);\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
							<span class="token function-variable function">onResult</span><span class="token operator">:</span> <span class="token parameter">result</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_callback(null, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>result<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">);\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
							<span class="token function-variable function">onDone</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">&quot;_callback();\n&quot;</span>
						<span class="token punctuation">}</span><span class="token punctuation">)</span>
				<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> <span class="token string">&quot;promise&quot;</span><span class="token operator">:</span>
				<span class="token keyword">let</span> errorHelperUsed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
				<span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">contentWithInterceptors</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
					<span class="token function-variable function">onError</span><span class="token operator">:</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
						errorHelperUsed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
						<span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_error(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>err<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">);\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span><span class="token punctuation">,</span>
					<span class="token function-variable function">onResult</span><span class="token operator">:</span> <span class="token parameter">result</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_resolve(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>result<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">);\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
					<span class="token function-variable function">onDone</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">&quot;_resolve();\n&quot;</span>
				<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">let</span> code <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
				code <span class="token operator">+=</span> <span class="token string">'&quot;use strict&quot;;\n'</span><span class="token punctuation">;</span>
				code <span class="token operator">+=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				code <span class="token operator">+=</span> <span class="token string">&quot;return new Promise((function(_resolve, _reject) {\n&quot;</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>errorHelperUsed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					code <span class="token operator">+=</span> <span class="token string">&quot;var _sync = true;\n&quot;</span><span class="token punctuation">;</span>
					code <span class="token operator">+=</span> <span class="token string">&quot;function _error(_err) {\n&quot;</span><span class="token punctuation">;</span>
					code <span class="token operator">+=</span> <span class="token string">&quot;if(_sync)\n&quot;</span><span class="token punctuation">;</span>
					code <span class="token operator">+=</span>
						<span class="token string">&quot;_resolve(Promise.resolve().then((function() { throw _err; })));\n&quot;</span><span class="token punctuation">;</span>
					code <span class="token operator">+=</span> <span class="token string">&quot;else\n&quot;</span><span class="token punctuation">;</span>
					code <span class="token operator">+=</span> <span class="token string">&quot;_reject(_err);\n&quot;</span><span class="token punctuation">;</span>
					code <span class="token operator">+=</span> <span class="token string">&quot;};\n&quot;</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				code <span class="token operator">+=</span> content<span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>errorHelperUsed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					code <span class="token operator">+=</span> <span class="token string">&quot;_sync = false;\n&quot;</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				code <span class="token operator">+=</span> <span class="token string">&quot;}));\n&quot;</span><span class="token punctuation">;</span>
				fn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">args</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">deinit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> fn<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">init</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> options<span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>_args <span class="token operator">=</span> options<span class="token punctuation">.</span>args<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br></div></div><p>首先是执行<code>this.init()</code>只要是在<code>factory(SyncHookCodeFactory实例)</code>上添加了<code>options</code>和<code>_args</code>属性：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>options<span class="token operator">=</span><span class="token punctuation">{</span>
  taps<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">&quot;sync&quot;</span><span class="token punctuation">,</span>
      <span class="token function-variable function">fn</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn1'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      name<span class="token operator">:</span> <span class="token string">&quot;fn1&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">&quot;sync&quot;</span><span class="token punctuation">,</span>
      <span class="token function-variable function">fn</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn2'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      name<span class="token operator">:</span> <span class="token string">&quot;fn2&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">&quot;sync&quot;</span><span class="token punctuation">,</span>
      <span class="token function-variable function">fn</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn3'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      name<span class="token operator">:</span> <span class="token string">&quot;fn3&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  interceptors<span class="token operator">:</span> <span class="token punctuation">[</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  args<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  type<span class="token operator">:</span> <span class="token string">&quot;sync&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>接下来我们去执行<code>create</code>方法中的</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">case</span> <span class="token string">&quot;sync&quot;</span><span class="token operator">:</span>
				fn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span>
					<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">args</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
					<span class="token string">'&quot;use strict&quot;;\n'</span> <span class="token operator">+</span>
						<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
						<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">contentWithInterceptors</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
							<span class="token function-variable function">onError</span><span class="token operator">:</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">throw </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>err<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
							<span class="token function-variable function">onResult</span><span class="token operator">:</span> <span class="token parameter">result</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">return </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>result<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
							resultReturns<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
							<span class="token function-variable function">onDone</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
							rethrowIfPossible<span class="token operator">:</span> <span class="token boolean">true</span>
						<span class="token punctuation">}</span><span class="token punctuation">)</span>
				<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>执行完成后<code>fn</code>:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">anonymous</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> _context<span class="token punctuation">;</span>
  <span class="token keyword">var</span> _x <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_x<span class="token punctuation">;</span>
  <span class="token keyword">var</span> _fn0 <span class="token operator">=</span> _x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">_fn0</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> _fn1 <span class="token operator">=</span> _x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">_fn1</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> _fn2 <span class="token operator">=</span> _x<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">_fn2</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>接下来返回<code>fn</code>:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">deinit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> fn<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><code>this.deinit()</code>是对我们调用<code>setup</code>方法是<code>factory</code>添加的属性的清除：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>
<span class="token function">deinit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>_args <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>然后函数返回：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">COMPILE</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	factory<span class="token punctuation">.</span><span class="token function">setup</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> factory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>接着返回到：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">_createCall</span><span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
			taps<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>taps<span class="token punctuation">,</span>
			interceptors<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>interceptors<span class="token punctuation">,</span>
			args<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_args<span class="token punctuation">,</span>
			type<span class="token operator">:</span> type
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>接着返回到：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">CALL_DELEGATE</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>call <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_createCall</span><span class="token punctuation">(</span><span class="token string">&quot;sync&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>这个时候<code>this.call = fn</code>函数,然后执行该函数：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>args<span class="token operator">:</span><span class="token punctuation">[</span>
  <span class="token string">&quot;yiluhuakai&quot;</span><span class="token punctuation">,</span>
  <span class="token number">25</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>

<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">call</span> <span class="token operator">=</span><span class="token keyword">function</span> <span class="token function">anonymous</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> _context<span class="token punctuation">;</span>
  <span class="token keyword">var</span> _x <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_x<span class="token punctuation">;</span>
  <span class="token keyword">var</span> _fn0 <span class="token operator">=</span> _x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">_fn0</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> _fn1 <span class="token operator">=</span> _x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">_fn1</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> _fn2 <span class="token operator">=</span> _x<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">_fn2</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>通过上面的调试我们可以发现创建<code>SyncHook</code>实例的时候我们会在SyncHook构造方法中调用<code>Hook</code>的构造函数去保存形参到实例<code>_args</code>（[&quot;name&quot;,&quot;age&quot;,]）中。然后去覆盖<code>Hook</code>实例上一些用不到的方法,然后调用<code>tap</code>方法事件处理函数的信息(<code>options</code>)保存进<code>this._taps</code>中。然后我们调用<code>call</code>方法时，会使用到<code>SyncHookCodeFactory</code>的实例去生成执行函数到<code>call</code>.并将事件监听函数挂载到<code>hook</code>的<code>_x</code>属性上。最终执行<code>call</code>方法。</p> <h4 id="手写synchook源码"><a href="#手写synchook源码" class="header-anchor">#</a> 手写SyncHook源码</h4> <ul><li><p>我们需要一个Hook类让SyncHook去继承，实例上主要保存我们传入的形参(<code>_args</code>)和事件处理信息taps([])和注册同步事件的方法<code>tap</code>:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Hook</span> <span class="token punctuation">{</span>
	<span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>_args <span class="token operator">=</span> args
		<span class="token keyword">this</span><span class="token punctuation">.</span>taps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>_x <span class="token operator">=</span> <span class="token keyword">undefined</span>
	<span class="token punctuation">}</span>

	<span class="token function">_tap</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> options<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> options <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			options <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> options <span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token comment">//  将fn函数合并进去</span>

		options <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span> fn<span class="token punctuation">,</span> type <span class="token punctuation">}</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span>

		<span class="token comment">// 掉用this._insert方法去保存options到 this.taps上</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_insert</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/**
	 * 使用tap方法去注册同步钩子的处理事件
	 */</span>

	<span class="token function">tap</span><span class="token punctuation">(</span><span class="token parameter">options<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_tap</span><span class="token punctuation">(</span><span class="token string">'sync'</span><span class="token punctuation">,</span> options<span class="token punctuation">,</span> fn<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token function">_insert</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>taps<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>taps<span class="token punctuation">.</span>length<span class="token punctuation">]</span> <span class="token operator">=</span> item
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
	Hook
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div></li> <li><p><code>SyncHook</code>去继承<code>Hook</code>然后实现自己的call方法：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> Hook <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./Hook.js'</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">SyncCodeFactory</span> <span class="token punctuation">{</span>
	<span class="token comment">/**
	 * 保存钩子的执行函数到钩子实例的_x中，然后生成的执行到代码是对象_x中函数的调用
	 */</span>
	<span class="token function">setup</span><span class="token punctuation">(</span><span class="token parameter">instance<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		instance<span class="token punctuation">.</span>_x <span class="token operator">=</span> options<span class="token punctuation">.</span>taps<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">option</span> <span class="token operator">=&gt;</span> option<span class="token punctuation">.</span>fn<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/**
	 * 保存信息到当前的factory实例上
	 */</span>
	<span class="token function">init</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> options
		<span class="token keyword">this</span><span class="token punctuation">.</span>args <span class="token operator">=</span> options<span class="token punctuation">.</span>args<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/*
    
        我们的factory是单例的，所以我们使用完要清除factory上的信息
    */</span>

	<span class="token function">deinit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> <span class="token keyword">undefined</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>args <span class="token operator">=</span> <span class="token keyword">undefined</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/**
	 *
	 * 生成对钩子的执行代码
	 */</span>

	<span class="token function">create</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
		<span class="token keyword">let</span> content <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">var _x =  this._x;</span><span class="token template-punctuation string">`</span></span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>taps<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			content <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">var _fn</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> = _x[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">];_fn</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>args<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">);</span><span class="token template-punctuation string">`</span></span>
		<span class="token punctuation">}</span>
		<span class="token keyword">const</span> fn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>args<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">,</span> content<span class="token punctuation">)</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">deinit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> fn
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> fatcory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncCodeFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">SyncHook</span> <span class="token keyword">extends</span> <span class="token class-name">Hook</span> <span class="token punctuation">{</span>
	<span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">super</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">/**
	 * 实现对SyncHook的调用
	 */</span>
	<span class="token function">call</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">let</span> call <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_createCall</span><span class="token punctuation">(</span><span class="token string">'sync'</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token function">call</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token function">_createCall</span><span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// 传递taps和args给factory</span>
		<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
			taps<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>taps<span class="token punctuation">,</span>
			type<span class="token punctuation">,</span>
			args<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_args
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/**
	 *
	 * @param {*} options
	 *
	 * 调用factory的方法生成钩子的执行函数
	 */</span>
	<span class="token function">compile</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		fatcory<span class="token punctuation">.</span><span class="token function">setup</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span>
		<span class="token keyword">return</span> fatcory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span> SyncHook <span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br></div></div></li> <li><p>测试代码：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> SyncHook <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./SyncHook.js'</span><span class="token punctuation">)</span>

<span class="token comment">// 创建一个SyncHook实例</span>
<span class="token keyword">const</span> sh <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'age'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment">// 注册监听事件</span>
sh<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'fn1'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn1'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

sh<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'fn2'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn2'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

sh<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'fn3'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fn3'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">sh</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'yiluhuakai'</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div></li></ul> <h4 id="asyncparallelhook"><a href="#asyncparallelhook" class="header-anchor">#</a> AsyncParallelHook</h4> <p><code>AsyncParallelHook</code>钩子的<code>tapAsync</code>方法和<code>SyncHook</code>的<code>tap</code>方法基本类似：区别在于传入的<code>type</code>是<code>async</code>而不是<code>sync</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//Hook.js</span>

<span class="token keyword">class</span> <span class="token class-name">Hook</span> <span class="token punctuation">{</span>
	<span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>_args <span class="token operator">=</span> args
		<span class="token keyword">this</span><span class="token punctuation">.</span>taps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>_x <span class="token operator">=</span> <span class="token keyword">undefined</span>
	<span class="token punctuation">}</span>

	<span class="token function">_tap</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> options<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> options <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			options <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> options <span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token comment">//  将fn函数合并进去</span>

		options <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span> fn<span class="token punctuation">,</span> type <span class="token punctuation">}</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span>

		<span class="token comment">// 掉用this._insert方法去保存options到 this.taps上</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_insert</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/**
	 * 使用tap方法去注册同步钩子的处理事件
	 */</span>

	<span class="token function">tap</span><span class="token punctuation">(</span><span class="token parameter">options<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_tap</span><span class="token punctuation">(</span><span class="token string">'sync'</span><span class="token punctuation">,</span> options<span class="token punctuation">,</span> fn<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token function">_insert</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>taps<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>taps<span class="token punctuation">.</span>length<span class="token punctuation">]</span> <span class="token operator">=</span> item
	<span class="token punctuation">}</span>

	<span class="token comment">/**
	 * 异步钩子添加事件的方法
	 */</span>
	<span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token parameter">options<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_tap</span><span class="token punctuation">(</span><span class="token string">'async'</span><span class="token punctuation">,</span> options<span class="token punctuation">,</span> fn<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
	Hook
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><p><code>AsyncParallelHook</code>钩子的<code>callAsync</code>方法也和SyncHook的<code>call</code>类似，区别就在于最终由<code>CodeFactory</code>生成的执行代码不一样：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>
<span class="token keyword">const</span> <span class="token punctuation">{</span> Hook <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./Hook.js'</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">AsyncCodeFactory</span> <span class="token punctuation">{</span>
	<span class="token comment">/**
	 * 保存钩子的执行函数到钩子实例的_x中，然后生成的执行到代码是对象_x中函数的调用
	 */</span>
	<span class="token function">_args</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> before<span class="token punctuation">,</span> after <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">let</span> allArgs <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>args
		<span class="token keyword">if</span> <span class="token punctuation">(</span>before<span class="token punctuation">)</span> allArgs <span class="token operator">=</span> <span class="token punctuation">[</span>before<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>allArgs<span class="token punctuation">)</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>after<span class="token punctuation">)</span> allArgs <span class="token operator">=</span> allArgs<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>after<span class="token punctuation">)</span>
		<span class="token keyword">return</span> allArgs<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token function">setup</span><span class="token punctuation">(</span><span class="token parameter">instance<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		instance<span class="token punctuation">.</span>_x <span class="token operator">=</span> options<span class="token punctuation">.</span>taps<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">option</span> <span class="token operator">=&gt;</span> option<span class="token punctuation">.</span>fn<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/**
	 * 保存信息到当前的factory实例上
	 */</span>
	<span class="token function">init</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> options
		<span class="token keyword">this</span><span class="token punctuation">.</span>args <span class="token operator">=</span> options<span class="token punctuation">.</span>args<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token function">header</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&quot;use strict&quot;\nvar _context;\nvar _x = this._x;\n</span><span class="token template-punctuation string">`</span></span>
	<span class="token punctuation">}</span>

	<span class="token comment">/*
    
        我们的factory是单例的，所以我们使用完要清除factory上的信息
    */</span>

	<span class="token function">deinit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> <span class="token keyword">undefined</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>args <span class="token operator">=</span> <span class="token keyword">undefined</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/**
	 *
	 * 生成对钩子的执行代码
	 */</span>
	<span class="token comment">// function anonymous(name, _callback) {</span>
	<span class="token comment">//     &quot;use strict&quot;;</span>
	<span class="token comment">//     var _context;</span>
	<span class="token comment">//     var _x = this._x;</span>
	<span class="token comment">//     do {</span>
	<span class="token comment">//         var _counter = 2;</span>
	<span class="token comment">//         var _done = (function() {</span>
	<span class="token comment">//             _callback();</span>
	<span class="token comment">//         });</span>

	<span class="token comment">//         if(_counter &lt;= 0) break;</span>

	<span class="token comment">//         var _fn0 = _x[0];</span>
	<span class="token comment">//         _fn0(name, function() {   if(--_counter === 0) _done();})</span>
	<span class="token comment">//         if(_counter &lt;= 0) break;</span>
	<span class="token comment">//         var _fn1 = _x[1];</span>
	<span class="token comment">//         _fn1(name, (function(_err1) {   if(--_counter === 0) _done();})</span>
	<span class="token comment">//     } while(false);</span>
	<span class="token comment">// }</span>
	<span class="token function">create</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>

		console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">let</span> content <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">do {\n _counter = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>options<span class="token punctuation">.</span>taps<span class="token punctuation">.</span>length<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;\n var _done = (function() {\n_callback();\n});</span><span class="token template-punctuation string">`</span></span>

		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>taps<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			content <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"> if(_counter &lt;= 0) break; var _fn</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> = _x[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">];
                _fn</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>args<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,
				function () {
					if (--_counter === 0) {
						_done()
					}
				});</span><span class="token template-punctuation string">`</span></span>
		<span class="token punctuation">}</span>
		content <span class="token operator">+=</span> <span class="token string">'\n} while(false)'</span>
		<span class="token keyword">const</span> fn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_args</span><span class="token punctuation">(</span><span class="token punctuation">{</span> after<span class="token operator">:</span> <span class="token string">'_callback'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> content<span class="token punctuation">)</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">deinit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> fn
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br></div></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/es/webpack-source.html" class="prev">
        webpack源码分析
      </a></span> <span class="next"><a href="/es/webpack4.html">
        webpack的打包入口
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.9b56a05a.js" defer></script><script src="/assets/js/2.b22280cb.js" defer></script><script src="/assets/js/58.220252cd.js" defer></script>
  </body>
</html>
