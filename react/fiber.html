<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>3. Fiber 算法 | yiluhuakai</title>
    <meta name="generator" content="VuePress 1.7.1">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/assets/css/0.styles.992cb7aa.css" as="style"><link rel="preload" href="/assets/js/app.9b56a05a.js" as="script"><link rel="preload" href="/assets/js/2.b22280cb.js" as="script"><link rel="preload" href="/assets/js/95.b253d44f.js" as="script"><link rel="prefetch" href="/assets/js/10.413ab2ab.js"><link rel="prefetch" href="/assets/js/100.2d785741.js"><link rel="prefetch" href="/assets/js/101.a9fd3349.js"><link rel="prefetch" href="/assets/js/11.99f54ddd.js"><link rel="prefetch" href="/assets/js/12.c46f64f3.js"><link rel="prefetch" href="/assets/js/13.6add00c5.js"><link rel="prefetch" href="/assets/js/14.40115781.js"><link rel="prefetch" href="/assets/js/15.c3827c6c.js"><link rel="prefetch" href="/assets/js/16.304d275d.js"><link rel="prefetch" href="/assets/js/17.006e2fe4.js"><link rel="prefetch" href="/assets/js/18.7f93828f.js"><link rel="prefetch" href="/assets/js/19.a72c6116.js"><link rel="prefetch" href="/assets/js/20.d175ff74.js"><link rel="prefetch" href="/assets/js/21.7092a034.js"><link rel="prefetch" href="/assets/js/22.1419ba41.js"><link rel="prefetch" href="/assets/js/23.ce5e3c1b.js"><link rel="prefetch" href="/assets/js/24.9f9edaa3.js"><link rel="prefetch" href="/assets/js/25.a57ae5dc.js"><link rel="prefetch" href="/assets/js/26.5ba697f1.js"><link rel="prefetch" href="/assets/js/27.9ecaa5dc.js"><link rel="prefetch" href="/assets/js/28.290c65fe.js"><link rel="prefetch" href="/assets/js/29.bdbc3eeb.js"><link rel="prefetch" href="/assets/js/3.ac44586b.js"><link rel="prefetch" href="/assets/js/30.6f37d998.js"><link rel="prefetch" href="/assets/js/31.b1ac1238.js"><link rel="prefetch" href="/assets/js/32.024f8182.js"><link rel="prefetch" href="/assets/js/33.202e11b5.js"><link rel="prefetch" href="/assets/js/34.e755ffc0.js"><link rel="prefetch" href="/assets/js/35.376b8f63.js"><link rel="prefetch" href="/assets/js/36.56735f24.js"><link rel="prefetch" href="/assets/js/37.b7d03c63.js"><link rel="prefetch" href="/assets/js/38.d9407e30.js"><link rel="prefetch" href="/assets/js/39.4f87e45d.js"><link rel="prefetch" href="/assets/js/4.a4a037c8.js"><link rel="prefetch" href="/assets/js/40.5a53ee48.js"><link rel="prefetch" href="/assets/js/41.f7fa6a68.js"><link rel="prefetch" href="/assets/js/42.3c07d4ad.js"><link rel="prefetch" href="/assets/js/43.2965402d.js"><link rel="prefetch" href="/assets/js/44.fef5da48.js"><link rel="prefetch" href="/assets/js/45.ff058ba7.js"><link rel="prefetch" href="/assets/js/46.5a74f2cd.js"><link rel="prefetch" href="/assets/js/47.5931bb97.js"><link rel="prefetch" href="/assets/js/48.cbf85ab3.js"><link rel="prefetch" href="/assets/js/49.0319f8e4.js"><link rel="prefetch" href="/assets/js/5.d0d45788.js"><link rel="prefetch" href="/assets/js/50.497cb73f.js"><link rel="prefetch" href="/assets/js/51.4b6e5c5b.js"><link rel="prefetch" href="/assets/js/52.f4edf34f.js"><link rel="prefetch" href="/assets/js/53.df9c0557.js"><link rel="prefetch" href="/assets/js/54.1654be3b.js"><link rel="prefetch" href="/assets/js/55.c9e37e1f.js"><link rel="prefetch" href="/assets/js/56.052c5808.js"><link rel="prefetch" href="/assets/js/57.cf8cebef.js"><link rel="prefetch" href="/assets/js/58.220252cd.js"><link rel="prefetch" href="/assets/js/59.7e76271a.js"><link rel="prefetch" href="/assets/js/6.b5583d51.js"><link rel="prefetch" href="/assets/js/60.38c88311.js"><link rel="prefetch" href="/assets/js/61.c4b0da1c.js"><link rel="prefetch" href="/assets/js/62.d8be952c.js"><link rel="prefetch" href="/assets/js/63.19c02fd0.js"><link rel="prefetch" href="/assets/js/64.9d51d342.js"><link rel="prefetch" href="/assets/js/65.31c63e7c.js"><link rel="prefetch" href="/assets/js/66.badcb6df.js"><link rel="prefetch" href="/assets/js/67.83764c63.js"><link rel="prefetch" href="/assets/js/68.152c45b6.js"><link rel="prefetch" href="/assets/js/69.2119cafb.js"><link rel="prefetch" href="/assets/js/7.d21b1042.js"><link rel="prefetch" href="/assets/js/70.ff7211f3.js"><link rel="prefetch" href="/assets/js/71.26e7783e.js"><link rel="prefetch" href="/assets/js/72.dc5a3ba6.js"><link rel="prefetch" href="/assets/js/73.d8356ad1.js"><link rel="prefetch" href="/assets/js/74.10184aff.js"><link rel="prefetch" href="/assets/js/75.716811ca.js"><link rel="prefetch" href="/assets/js/76.046e6155.js"><link rel="prefetch" href="/assets/js/77.d287e80f.js"><link rel="prefetch" href="/assets/js/78.635ed9d3.js"><link rel="prefetch" href="/assets/js/79.4485123f.js"><link rel="prefetch" href="/assets/js/8.8bd3dfa9.js"><link rel="prefetch" href="/assets/js/80.74fc122c.js"><link rel="prefetch" href="/assets/js/81.cb3ce31c.js"><link rel="prefetch" href="/assets/js/82.bf81591e.js"><link rel="prefetch" href="/assets/js/83.01b0002d.js"><link rel="prefetch" href="/assets/js/84.6af4ae46.js"><link rel="prefetch" href="/assets/js/85.31122a7c.js"><link rel="prefetch" href="/assets/js/86.7641b1ab.js"><link rel="prefetch" href="/assets/js/87.63912fdd.js"><link rel="prefetch" href="/assets/js/88.01d6d061.js"><link rel="prefetch" href="/assets/js/89.ec494ad7.js"><link rel="prefetch" href="/assets/js/9.17f8341c.js"><link rel="prefetch" href="/assets/js/90.a2905192.js"><link rel="prefetch" href="/assets/js/91.5b1b5e00.js"><link rel="prefetch" href="/assets/js/92.f8112523.js"><link rel="prefetch" href="/assets/js/93.8e9fd5a8.js"><link rel="prefetch" href="/assets/js/94.41217af6.js"><link rel="prefetch" href="/assets/js/96.76495ed0.js"><link rel="prefetch" href="/assets/js/97.9f48729e.js"><link rel="prefetch" href="/assets/js/98.0e36c4a8.js"><link rel="prefetch" href="/assets/js/99.5b6ab9af.js">
    <link rel="stylesheet" href="/assets/css/0.styles.992cb7aa.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">yiluhuakai</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/leetcode/" class="nav-link">
  LeetCode
</a></div><div class="nav-item"><a href="/golang/" class="nav-link">
  Go
</a></div><div class="nav-item"><a href="/mysql/" class="nav-link">
  Mysql
</a></div><div class="nav-item"><a href="/clang/" class="nav-link">
  C语言
</a></div><div class="nav-item"><a href="/es/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/nodejs/" class="nav-link">
  nodejs
</a></div><div class="nav-item"><a href="/react/" class="nav-link router-link-active">
  React
</a></div><div class="nav-item"><a href="/java/" class="nav-link">
  Java
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/leetcode/" class="nav-link">
  LeetCode
</a></div><div class="nav-item"><a href="/golang/" class="nav-link">
  Go
</a></div><div class="nav-item"><a href="/mysql/" class="nav-link">
  Mysql
</a></div><div class="nav-item"><a href="/clang/" class="nav-link">
  C语言
</a></div><div class="nav-item"><a href="/es/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/nodejs/" class="nav-link">
  nodejs
</a></div><div class="nav-item"><a href="/react/" class="nav-link router-link-active">
  React
</a></div><div class="nav-item"><a href="/java/" class="nav-link">
  Java
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/react/react_basic.html" class="sidebar-link">1. React 介绍</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/react/virtualDom.html" class="sidebar-link">2.Virtual DOM 及 Diff 算法</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/react/virtualDom.html#_2-virtual-dom-及-diff-算法" class="sidebar-link">2.Virtual DOM 及 Diff 算法</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/react/virtualDom.html#_1-jsx-到底是什么" class="sidebar-link">1. JSX 到底是什么</a></li><li class="sidebar-sub-header"><a href="/react/virtualDom.html#_2-dom-操作问题" class="sidebar-link">2. DOM 操作问题</a></li><li class="sidebar-sub-header"><a href="/react/virtualDom.html#_3-什么是-virtual-dom" class="sidebar-link">3. 什么是 Virtual DOM</a></li><li class="sidebar-sub-header"><a href="/react/virtualDom.html#_4-virtual-dom-如何提升效率" class="sidebar-link">4. Virtual DOM 如何提升效率</a></li><li class="sidebar-sub-header"><a href="/react/virtualDom.html#_5-创建-virtual-dom" class="sidebar-link">5. 创建 Virtual DOM</a></li><li class="sidebar-sub-header"><a href="/react/virtualDom.html#_6-渲染-virtual-dom-对象为-dom-对象" class="sidebar-link">6. 渲染 Virtual DOM 对象为 DOM 对象</a></li><li class="sidebar-sub-header"><a href="/react/virtualDom.html#_7-为元素节点添加属性" class="sidebar-link">7. 为元素节点添加属性</a></li><li class="sidebar-sub-header"><a href="/react/virtualDom.html#_8-渲染组件" class="sidebar-link">8. 渲染组件</a></li><li class="sidebar-sub-header"><a href="/react/virtualDom.html#_8-1-函数组件" class="sidebar-link" style="padding-left:3rem;">8.1 函数组件</a></li><li class="sidebar-sub-header"><a href="/react/virtualDom.html#_8-2-类组件" class="sidebar-link" style="padding-left:3rem;">8.2 类组件</a></li><li class="sidebar-sub-header"><a href="/react/virtualDom.html#_9-virtual-dom-比对" class="sidebar-link">9. Virtual DOM 比对</a></li><li class="sidebar-sub-header"><a href="/react/virtualDom.html#_9-1-virtual-dom-类型相同" class="sidebar-link" style="padding-left:3rem;">9.1 Virtual DOM 类型相同</a></li><li class="sidebar-sub-header"><a href="/react/virtualDom.html#_9-2-virtual-dom-类型不同" class="sidebar-link" style="padding-left:3rem;">9.2 Virtual DOM 类型不同</a></li><li class="sidebar-sub-header"><a href="/react/virtualDom.html#_9-3-删除节点" class="sidebar-link" style="padding-left:3rem;">9.3 删除节点</a></li><li class="sidebar-sub-header"><a href="/react/virtualDom.html#_9-4-类组件状态更新" class="sidebar-link" style="padding-left:3rem;">9.4 类组件状态更新</a></li><li class="sidebar-sub-header"><a href="/react/virtualDom.html#_9-5-组件更新" class="sidebar-link" style="padding-left:3rem;">9.5 组件更新</a></li><li class="sidebar-sub-header"><a href="/react/virtualDom.html#_10-ref-属性" class="sidebar-link">10. ref 属性</a></li><li class="sidebar-sub-header"><a href="/react/virtualDom.html#_11-key-属性" class="sidebar-link">11. key 属性</a></li><li class="sidebar-sub-header"><a href="/react/virtualDom.html#_11-1-节点对比" class="sidebar-link" style="padding-left:3rem;">11.1 节点对比</a></li><li class="sidebar-sub-header"><a href="/react/virtualDom.html#_11-2-节点卸载" class="sidebar-link" style="padding-left:3rem;">11.2 节点卸载</a></li></ul></li></ul></li><li><a href="/react/fiber.html" aria-current="page" class="active sidebar-link">3. Fiber 算法</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/react/formik.html" class="sidebar-link">formik</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/react/hooks.html" class="sidebar-link">React Hooks</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/react/hooks.html#react-hooks" class="sidebar-link">React Hooks</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/react/hooks.html#_1-react-hooks-介绍" class="sidebar-link">1. React Hooks 介绍</a></li><li class="sidebar-sub-header"><a href="/react/hooks.html#_1-1-react-hooks-是用来做什么的" class="sidebar-link" style="padding-left:3rem;">1.1 React Hooks 是用来做什么的</a></li><li class="sidebar-sub-header"><a href="/react/hooks.html#_1-2-类组件的不足-hooks-要解决的问题" class="sidebar-link" style="padding-left:3rem;">1.2 类组件的不足 (Hooks 要解决的问题)</a></li><li class="sidebar-sub-header"><a href="/react/hooks.html#react的使用" class="sidebar-link">React的使用</a></li><li class="sidebar-sub-header"><a href="/react/hooks.html#_2-1-usestate" class="sidebar-link" style="padding-left:3rem;">2.1 useState</a></li><li class="sidebar-sub-header"><a href="/react/hooks.html#_2-1-usereducer" class="sidebar-link" style="padding-left:3rem;">2.1 useReducer</a></li><li class="sidebar-sub-header"><a href="/react/hooks.html#_2-1-usecontext" class="sidebar-link" style="padding-left:3rem;">2.1 useContext</a></li><li class="sidebar-sub-header"><a href="/react/hooks.html#_2-4-useeffect" class="sidebar-link" style="padding-left:3rem;">2.4 useEffect()</a></li><li class="sidebar-sub-header"><a href="/react/hooks.html#usememo" class="sidebar-link" style="padding-left:3rem;">useMemo</a></li><li class="sidebar-sub-header"><a href="/react/hooks.html#memo方法" class="sidebar-link" style="padding-left:3rem;">memo方法</a></li><li class="sidebar-sub-header"><a href="/react/hooks.html#_2-7-usecallback" class="sidebar-link" style="padding-left:3rem;">2.7 useCallback()</a></li><li class="sidebar-sub-header"><a href="/react/hooks.html#_2-8-useref" class="sidebar-link" style="padding-left:3rem;">2.8 useRef()</a></li><li class="sidebar-sub-header"><a href="/react/hooks.html#_3-自定义-hook" class="sidebar-link" style="padding-left:3rem;">3. 自定义 Hook</a></li><li class="sidebar-sub-header"><a href="/react/hooks.html#_4-usestate实现" class="sidebar-link" style="padding-left:3rem;">4.useState实现</a></li><li class="sidebar-sub-header"><a href="/react/hooks.html#_5-useeffect实现" class="sidebar-link" style="padding-left:3rem;">5.useEffect实现</a></li><li class="sidebar-sub-header"><a href="/react/hooks.html#_6-usereducer实现" class="sidebar-link" style="padding-left:3rem;">6.useReducer实现</a></li></ul></li></ul></li><li><a href="/react/jest.html" class="sidebar-link">Jest使用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/react/jest.html#jest使用" class="sidebar-link">Jest使用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/react/jest.html#什么是测试" class="sidebar-link" style="padding-left:3rem;">什么是测试</a></li></ul></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h3 id="_3-fiber-算法"><a href="#_3-fiber-算法" class="header-anchor">#</a> 3. Fiber 算法</h3> <p>Fiber 算法是 diff 算法中对比虚拟 dom 的一部分。</p> <p>`1. 开发环境配置</p> <h4 id="_1-1-文件夹结构"><a href="#_1-1-文件夹结构" class="header-anchor">#</a> 1.1 文件夹结构</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>├── babel.config.json           // babel 配置文件
├── build                       // 存储服务端代码打包文件
│   └── server.js
├── dist                        // 存储客户端代码打包文件
│   ├── bundle.js
│   └── bundle.js.map
├── package-lock.json
├── package.json                // 项目工程文件
├── server.js                   // 存储服务器端代码
├── src                         // 存储源文件
│   └── index.js
├── webpack.config.client.js    // 服务端 webpack 配置文件
└── webpack.config.server.js    // 客户端 webpack 配置文件

<span class="token number">3</span> directories, <span class="token number">10</span> files
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>创建 package.json 文件：<code>npm init -y</code></p> <h4 id="_1-2-安装项目依赖"><a href="#_1-2-安装项目依赖" class="header-anchor">#</a> 1.2 安装项目依赖</h4> <p>开发依赖：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">npm</span> <span class="token function">install</span> webpack webpack-cli webpack-node-externals @babel/core @babel/preset-env @babel/preset-react babel-loader nodemon npm-run-all -D
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>项目依赖：<code>npm install express</code></p> <table><thead><tr><th>依赖项</th> <th>描述</th></tr></thead> <tbody><tr><td>webpack</td> <td>模块打包工具</td></tr> <tr><td>webpack-cli</td> <td>打包命令</td></tr> <tr><td>webpack-node-externals</td> <td>打包服务器端模块时剔除 node_modules 文件夹中的模块</td></tr> <tr><td>@babel/core</td> <td>JavaScript 代码转换工具</td></tr> <tr><td>@babel/preset-env</td> <td>babel 预置，转换高级 JavaScript 语法</td></tr> <tr><td>@babel/preset-react</td> <td>babel 预置，转换 JSX 语法</td></tr> <tr><td>babel-loader</td> <td>webpack 中的 babel 工具加载器</td></tr> <tr><td>nodemon</td> <td>监控服务端文件变化，重启应用</td></tr> <tr><td>npm-run-all</td> <td>命令行工具，可以同时执行多个命令</td></tr> <tr><td>express</td> <td>基于 node 平台的 web 开发框架</td></tr></tbody></table> <h4 id="_1-3-环境配置"><a href="#_1-3-环境配置" class="header-anchor">#</a> 1.3 环境配置</h4> <h5 id="_1-3-1-创建-web-服务器"><a href="#_1-3-1-创建-web-服务器" class="header-anchor">#</a> 1.3.1 创建 web 服务器</h5> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// server.js</span>
<span class="token keyword">import</span> express <span class="token keyword">from</span> <span class="token string">&quot;express&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span><span class="token string">&quot;dist&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> template <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  &lt;html&gt;
    &lt;head&gt;
      &lt;title&gt;React Fiber&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
      &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;
			&lt;script src=&quot;bundle.js&quot;&gt;&lt;/script&gt;
    &lt;/body&gt;
  &lt;/html&gt;
</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;*&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>template<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;server is running&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h5 id="_1-3-2-服务端-webpack-配置"><a href="#_1-3-2-服务端-webpack-配置" class="header-anchor">#</a> 1.3.2 服务端 webpack 配置</h5> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// webpack.config.server.js</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;path&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> nodeExternals <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;webpack-node-externals&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    target<span class="token operator">:</span> <span class="token string">&quot;node&quot;</span><span class="token punctuation">,</span>
    mode<span class="token operator">:</span> <span class="token string">&quot;development&quot;</span><span class="token punctuation">,</span>
    entry<span class="token operator">:</span> <span class="token string">&quot;./server.js&quot;</span><span class="token punctuation">,</span>
    output<span class="token operator">:</span> <span class="token punctuation">{</span>
        filename<span class="token operator">:</span> <span class="token string">&quot;server.js&quot;</span><span class="token punctuation">,</span>
        path<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;build&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    module<span class="token operator">:</span> <span class="token punctuation">{</span>
        rules<span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
                exclude<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">node_modules</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
                use<span class="token operator">:</span> <span class="token punctuation">{</span>
                    loader<span class="token operator">:</span> <span class="token string">&quot;babel-loader&quot;</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 只打包 server.js文件，它的依赖在node_module中不处理</span>
    externals<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">nodeExternals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h5 id="_1-3-3-babel-配置"><a href="#_1-3-3-babel-配置" class="header-anchor">#</a> 1.3.3 babel 配置</h5> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;presets&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;@babel/preset-env&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;@babel/preset-react&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h5 id="_1-3-4-客户端-webpack-配置"><a href="#_1-3-4-客户端-webpack-配置" class="header-anchor">#</a> 1.3.4 客户端 webpack 配置</h5> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;path&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    target<span class="token operator">:</span> <span class="token string">&quot;web&quot;</span><span class="token punctuation">,</span>
    mode<span class="token operator">:</span> <span class="token string">&quot;development&quot;</span><span class="token punctuation">,</span>
    entry<span class="token operator">:</span> <span class="token string">&quot;./src/index.js&quot;</span><span class="token punctuation">,</span>
    output<span class="token operator">:</span> <span class="token punctuation">{</span>
        filename<span class="token operator">:</span> <span class="token string">&quot;bundle.js&quot;</span><span class="token punctuation">,</span>
        path<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;dist&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    devtool<span class="token operator">:</span> <span class="token string">&quot;source-map&quot;</span><span class="token punctuation">,</span>
    module<span class="token operator">:</span> <span class="token punctuation">{</span>
        rules<span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
                exclude<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">node_modules</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
                use<span class="token operator">:</span> <span class="token punctuation">{</span>
                    loader<span class="token operator">:</span> <span class="token string">&quot;babel-loader&quot;</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h5 id="_1-3-5-启动命令"><a href="#_1-3-5-启动命令" class="header-anchor">#</a> 1.3.5 启动命令</h5> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token string">&quot;npm-run-all --parallel dev:*&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;dev:server-compile&quot;</span><span class="token operator">:</span> <span class="token string">&quot;webpack --config webpack.config.server.js --watch&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;dev:server&quot;</span><span class="token operator">:</span> <span class="token string">&quot;nodemon ./build/server.js&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;dev:client-compile&quot;</span><span class="token operator">:</span> <span class="token string">&quot;webpack --config webpack.config.client.js --watch&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="_2-requestidlecallback"><a href="#_2-requestidlecallback" class="header-anchor">#</a> 2. <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/requestIdleCallback" target="_blank" rel="noopener noreferrer">requestIdleCallback<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h3> <h4 id="_2-1-核心-api-功能介绍"><a href="#_2-1-核心-api-功能介绍" class="header-anchor">#</a> 2.1 核心 API 功能介绍</h4> <p>利用浏览器的空余时间执行任务，如果有更高优先级的任务要执行时，当前执行的任务可以被终止，优先执行高级别任务。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token function">requestIdleCallback</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">deadline</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// deadline.timeRemaining() 获取浏览器的空余时间</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="_2-2-浏览器空余时间"><a href="#_2-2-浏览器空余时间" class="header-anchor">#</a> 2.2 浏览器空余时间</h4> <p>页面是一帧一帧绘制出来的，当每秒绘制的帧数达到 60 时，页面是流畅的，小于这个值时， 用户会感觉到卡顿</p> <p>1s 60 帧，每一帧分到的时间是 1000/60 ≈ 16 ms，如果每一帧执行的时间小于 16ms，就说明浏览器有空余时间</p> <p>如果任务在剩余的时间内没有完成则会停止任务执行，继续优先执行主任务，也就是说 requestIdleCallback 总是利用浏览器的空余时间执行任务</p> <h4 id="_2-3-api-功能体验"><a href="#_2-3-api-功能体验" class="header-anchor">#</a> 2.3 API 功能体验</h4> <p>页面中有两个按钮和一个 DIV，点击第一个按钮执行一项昂贵的计算，使其长期占用主线程，当计算任务执行的时候去点击第二个按钮更改页面中 DIV 的背景颜色。</p> <p>使用 requestIdleCallback 就可以完美解决这个卡顿问题。</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>playground<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>play<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>playground<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>work<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>start work<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>interaction<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>handle some user interaction<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-css line-numbers-mode"><pre class="language-css"><code><span class="token selector">&lt;style&gt;
  .playground</span> <span class="token punctuation">{</span>
    <span class="token property">background</span><span class="token punctuation">:</span> palevioletred<span class="token punctuation">;</span>
    <span class="token property">padding</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span>
    <span class="token property">margin-bottom</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
&lt;/style&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> play <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;play&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> workBtn <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;work&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> interactionBtn <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;interaction&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> iterationCount <span class="token operator">=</span> <span class="token number">100000000</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> value <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> <span class="token function-variable function">expensiveCalculation</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">IdleDeadline</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>iterationCount <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> IdleDeadline<span class="token punctuation">.</span><span class="token function">timeRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        value <span class="token operator">=</span>
            Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0.5</span> <span class="token operator">?</span> value <span class="token operator">+</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> value <span class="token operator">+</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        iterationCount <span class="token operator">=</span> iterationCount <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 中断后需要再次调用才会继续执行</span>
    <span class="token function">requestIdleCallback</span><span class="token punctuation">(</span>expensiveCalculation<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

workBtn<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">requestIdleCallback</span><span class="token punctuation">(</span>expensiveCalculation<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

interactionBtn<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    play<span class="token punctuation">.</span>style<span class="token punctuation">.</span>background <span class="token operator">=</span> <span class="token string">&quot;palegreen&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h3 id="_3-fiber"><a href="#_3-fiber" class="header-anchor">#</a> 3 Fiber</h3> <h4 id="_3-1-问题"><a href="#_3-1-问题" class="header-anchor">#</a> 3.1 问题</h4> <p>React 16 之前的版本比对更新 VirtualDOM 的过程是采用循环加递归实现的，这种比对方式有一个问题，就是一旦任务开始进行就无法中断，如果应用中组件数量庞大，主线程被长期占用，直到整棵 VirtualDOM 树比对更新完成之后主线程才能被释放，主线程才能执行其他任务。这就会导致一些用户交互，动画等任务无法立即得到执行，页面就会产生卡顿, 非常的影响用户体验。</p> <p>核心问题：递归无法中断，执行重任务耗时长。 JavaScript 又是单线程，无法同时执行其他任务，导致任务延迟页面卡顿，用户体验差。</p> <h4 id="_3-2-解决方案"><a href="#_3-2-解决方案" class="header-anchor">#</a> 3.2 解决方案</h4> <ol><li>利用浏览器空闲时间执行任务，拒绝长时间占用主线程</li> <li>放弃递归只采用循环，因为循环可以被中断</li> <li>任务拆分，将任务拆分成一个个的小任务</li></ol> <h4 id="_3-3-实现思路"><a href="#_3-3-实现思路" class="header-anchor">#</a> 3.3 实现思路</h4> <p>在 Fiber 方案中，为了实现任务的终止再继续，DOM 比对算法被分成了两部分：</p> <ol><li>构建 Fiber (可中断)</li> <li>提交 Commit (不可中断)</li></ol> <p>DOM 初始渲染: virtualDOM -&gt; Fiber -&gt; Fiber[] -&gt; DOM</p> <p>DOM 更新操作: newFiber vs oldFiber -&gt; Fiber[] -&gt; DOM</p> <h4 id="_3-4-fiber-对象"><a href="#_3-4-fiber-对象" class="header-anchor">#</a> 3.4 Fiber 对象</h4> <p>fiber 对象也是一个<code>js</code>对象.</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>{
  type         节点类型 (元素, 文本, 组件)(具体的类型)
  props        节点属性
  stateNode    节点 DOM 对象 | 组件实例对象
  tag          节点标记 (对具体类型的分类 hostRoot || hostComponent || classComponent || functionComponent)
  effects      数组, 存储需要更改的 fiber 对象
  effectTag    当前 Fiber 要被执行的操作 (新增, 删除, 修改)
  parent       当前 Fiber 的父级 Fiber
  child        当前 Fiber 的子级 Fiber
  sibling      当前 Fiber 的下一个兄弟 Fiber
  alternate    Fiber 备份 fiber 比对时使用
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><img src="/react/fiber/3.png">
如何将虚拟`dom`对象转换成一个`fiber`对象？
从dom树的最外面开始，将dom树根节点转成fiber对象，然后该节点的第一个子节点对应的`fiber`对象是该`fiber`对象的孩子，从第二个孩子开始，是前一个孩子的`fiber`对象的兄弟节点。
<h4 id="_3-5-fiber-的使用"><a href="#_3-5-fiber-的使用" class="header-anchor">#</a> 3.5 fiber 的使用</h4> <p>接下来我们实现一个<code>demo</code>,将虚拟<code>dom</code>先转成<code>fiber</code>对象，最后利用<code>fiber</code>对象来生成和跟新真实<code>dom</code>。</p> <p>项目结构：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>src
├── index.js // 测试代码
└── react
    ├── CreateElement // React.createElement方法
    │   └── createElement.js
    ├── Misc  // 一些工具方法
    │   ├── CreateTaskQueue // 创建任务队列的方法
    │   │   └── index.js
    │   └── index.js
    ├── index.js  // 整个react项目的出口
    └── reconciliation // render方法
        └── index.js

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><code>src/index.js</code>:</p> <div class="language-jsx line-numbers-mode"><pre class="language-jsx"><code><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> render <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./react&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> jsx <span class="token operator">=</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">Hello wolrd!</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>jsx<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> root <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">render</span><span class="token punctuation">(</span>jsx<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><code>Misc/CreateTaskQueue/index.js</code>:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/**

* 导入一个生成任务队列的方法

*/</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">createTaskQueue</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> queue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token function-variable function">push</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">task</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> queue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function-variable function">pop</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> queue<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><code>CreateElement/createElement.js</code>:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> props<span class="token punctuation">,</span> <span class="token operator">...</span>children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 当我们的子元素是一个数组是需要拆分</span>
    <span class="token keyword">const</span> childElements <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token operator">...</span>children<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">result<span class="token punctuation">,</span> child</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 忽略布尔值和null</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>child <span class="token operator">!==</span> <span class="token boolean">true</span> <span class="token operator">&amp;&amp;</span> child <span class="token operator">!==</span> <span class="token boolean">false</span> <span class="token operator">&amp;&amp;</span> child <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 不是对象的时候是文本节点</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>child <span class="token keyword">instanceof</span> <span class="token class-name">Object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">//文本节点</span>
                result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> textContent<span class="token operator">:</span> child <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        type<span class="token punctuation">,</span>
        props<span class="token operator">:</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span> children<span class="token operator">:</span> childElements <span class="token punctuation">}</span><span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">,</span>
        children<span class="token operator">:</span> childElements<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p><code>reconciliation/index.js</code>:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/**
 *
 * 实现render方法：
 *
 * render方法主要功能：1.向任务队列中添加任务
 *                  2. 浏览器空闲的时候从任务队列中取出任务执行
 *
 * 任务：这里的任务就是通过vdom对象构建fiber对象
 *
 */</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> createTaskQueue <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../Misc&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> taskQueue <span class="token operator">=</span> <span class="token function">createTaskQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * render方法的参数，第一个element代表虚拟dom，第二个参数代表根元素
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">element<span class="token punctuation">,</span> dom</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 向任务队列中添加任务，</span>
    taskQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> dom<span class="token punctuation">,</span> props<span class="token operator">:</span> <span class="token punctuation">{</span> chilren<span class="token operator">:</span> element <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 取出我们刚刚添加的任务</span>

    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>taskQueue<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>添加任务的调用逻辑：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">*</span><span class="token operator">/</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> createTaskQueue <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../Misc&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> taskQueue <span class="token operator">=</span> <span class="token function">createTaskQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> subTask <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">getFirstTask</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">executeTask</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">workLoop</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">deadline</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>subTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        subTask <span class="token operator">=</span> <span class="token function">getFirstTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>subTask <span class="token operator">&amp;&amp;</span> deadline<span class="token punctuation">.</span><span class="token function">timeRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 执行任务</span>
        subTask <span class="token operator">=</span> <span class="token function">executeTask</span><span class="token punctuation">(</span>subTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 执行任务</span>
<span class="token keyword">const</span> <span class="token function-variable function">performTask</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">deadline</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 开启任务循环</span>
    <span class="token function">workLoop</span><span class="token punctuation">(</span>deadline<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 当任务执行中断后中心执行</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>subTask <span class="token operator">||</span> <span class="token operator">!</span>taskQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">requestIdleCallback</span><span class="token punctuation">(</span>performTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * render方法的参数，第一个element代表虚拟dom，第二个参数代表根元素
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">element<span class="token punctuation">,</span> dom</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 向任务队列中添加任务，</span>
    taskQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> dom<span class="token punctuation">,</span> props<span class="token operator">:</span> <span class="token punctuation">{</span> chilren<span class="token operator">:</span> element <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 取出我们刚刚添加的任务</span>

    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>taskQueue<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 取出任务队列中的任务执行</span>
    <span class="token function">requestIdleCallback</span><span class="token punctuation">(</span>performTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><p><code>createTask</code>中追加判空的方法</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">createTaskQueue</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> queue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token function-variable function">push</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">task</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> queue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function-variable function">pop</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> queue<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function-variable function">isEmpty</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> queue<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><code>getFirstTask</code>方法用于从任务队列中获取第一个子任务.</p> <div class="language-JavaScript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token function-variable function">getFirstTask</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 获取任务队列队列中第一个任务的子任务
     *
     */</span>

    <span class="token keyword">const</span> subTask <span class="token operator">=</span> taskQueue<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>subTask<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 构建fiber对象(最晚层元素root对应的fiber对象)
     */</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        props<span class="token operator">:</span> subTask<span class="token punctuation">.</span>props<span class="token punctuation">,</span>
        stateNode<span class="token operator">:</span> subTask<span class="token punctuation">.</span>dom<span class="token punctuation">,</span> <span class="token comment">//当前fiber对象对应的dom</span>
        tag<span class="token operator">:</span> <span class="token string">&quot;hostRoot&quot;</span><span class="token punctuation">,</span> <span class="token comment">//根节点</span>
        effects<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        child<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">//后面构建了子fiber节点再去设置</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>调用<code>executeTask</code>方法执行任务并返回新的任务。<code>reconcileChildren</code>方法用来将子节点的虚拟对象转化成<code>fiber</code>对象。</p> <div class="language-JavaScript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">/**
 *
 * @param {*} fiber 父fiber对象
 * @param {Array | Object} children 虚拟dom
 */</span>
<span class="token keyword">const</span> <span class="token function-variable function">reconcileChildren</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">fiber<span class="token punctuation">,</span> children</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">//当children是根fiber对象时，children是对象，当是用creaeElement方法创建的，则是数组</span>
    <span class="token comment">// 将children转成数组统一处理</span>
    <span class="token keyword">const</span> arrifiedChildren <span class="token operator">=</span> <span class="token function">arrified</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
        element <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        length <span class="token operator">=</span> arrifiedChildren<span class="token punctuation">.</span>length<span class="token punctuation">,</span>
        newFiber <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        prevFiber <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>index <span class="token operator">&lt;</span> length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        element <span class="token operator">=</span> arrifiedChildren<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">// 将当前的虚拟dom构建成fiber对象</span>
        newFiber <span class="token operator">=</span> <span class="token punctuation">{</span>
            type<span class="token operator">:</span> element<span class="token punctuation">.</span>type<span class="token punctuation">,</span>
            props<span class="token operator">:</span> element<span class="token punctuation">.</span>props<span class="token punctuation">,</span>
            tag<span class="token operator">:</span> <span class="token string">&quot;host_component&quot;</span><span class="token punctuation">,</span>
            effects<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            effectTag<span class="token operator">:</span> <span class="token string">&quot;placement&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 添加节点</span>
            stateNode<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
            parent<span class="token operator">:</span> fiber<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 作为当前节点的child</span>
            fiber<span class="token punctuation">.</span>child <span class="token operator">=</span> newFiber<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">//作为前一个兄弟节点的邻居节点</span>
            prevFiber<span class="token punctuation">.</span>subling <span class="token operator">=</span> newFiber<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        prevFiber <span class="token operator">=</span> newFiber<span class="token punctuation">;</span>
        index<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">executeTask</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 构建当前fiber对象的子fiber对象
     */</span>
    <span class="token function">reconcileChildren</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> fiber<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>fiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><p><code>fiber</code>对象的<code>stateNode</code>属性中保存的是当前 fiber 对象对应生成的<code>dom</code>元素，当<code>fiber</code>对象的<code>tag</code>类型不同，生成<code>dom</code>的方式也不同，我们可以使用<code>createStateNode</code>去生成<code>fiber</code>对象的<code>stateNode</code>属性：</p> <div class="language-JavaScript line-numbers-mode"><pre class="language-javascript"><code>		<span class="token comment">// 将当前的虚拟dom构建成fiber对象</span>
        newFiber <span class="token operator">=</span> <span class="token punctuation">{</span>
            type<span class="token operator">:</span> element<span class="token punctuation">.</span>type<span class="token punctuation">,</span>
            props<span class="token operator">:</span> element<span class="token punctuation">.</span>props<span class="token punctuation">,</span>
            tag<span class="token operator">:</span> <span class="token string">&quot;host_component&quot;</span><span class="token punctuation">,</span>
            effects<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            effectTag<span class="token operator">:</span> <span class="token string">&quot;placement&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 添加节点</span>
            <span class="token comment">// stateNode: null,</span>
            parent<span class="token operator">:</span> fiber<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment">// 给新创建的fiber对象添加stateNode属性</span>
        newFiber<span class="token punctuation">.</span>stateNode <span class="token operator">=</span> <span class="token function">createStateNode</span><span class="token punctuation">(</span>newFiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><code>fiber</code>对象的<code>tag</code>属性应该是动态变化的：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>newFiber <span class="token operator">=</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> element<span class="token punctuation">.</span>type<span class="token punctuation">,</span>
    props<span class="token operator">:</span> element<span class="token punctuation">.</span>props<span class="token punctuation">,</span>
    tag<span class="token operator">:</span> <span class="token function">getTag</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">,</span>
    effects<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    effectTag<span class="token operator">:</span> <span class="token string">&quot;placement&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 添加节点</span>
    <span class="token comment">// stateNode: null,</span>
    parent<span class="token operator">:</span> fiber<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><code>getTag</code>方法：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// MISC/getTag/index.js</span>
<span class="token keyword">const</span> <span class="token function-variable function">getTag</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">vdom</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 文本节点和元素节点</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> vdom<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;host_component&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> getTag<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>目前我们只完成了最外层节点和其子节点的对 fiber 对象的转化工作，我们还需要完成下层节点的转化，以及使用<code>effects</code>收集子节点的<code>fiber</code>对象。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">executeTask</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 构建当前fiber对象的子fiber对象
     */</span>
    <span class="token function">reconcileChildren</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> fiber<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 下次任务时继续构建fiber.child对象,z这块只处理了子节点，没有处理兄弟节点</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>child<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> fiber<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 当没有子节点的时候，开始去查找兄弟节点并构建fiber对象</span>
    <span class="token keyword">let</span> currentFiber <span class="token operator">=</span> fiber<span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 存放当前节点下的所有fiber对象，包含自身</span>
        currentFiber<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>effects <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>effects<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>
            currentFiber<span class="token punctuation">.</span>effects<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span>currentFiber<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>subling<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> currentFiber<span class="token punctuation">.</span>subling<span class="token punctuation">;</span> <span class="token comment">// 基于该节点去构建</span>
        <span class="token punctuation">}</span>
        currentFiber <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>parent<span class="token punctuation">;</span>
        <span class="token comment">// 向上去处理父节点subling节点</span>
    <span class="token punctuation">}</span>
    console<span class="token punctuation">.</span><span class="token function">dir</span><span class="token punctuation">(</span>fiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>完成了<code>fiber</code>对象的构建，接下来开始使用<code>fiber</code>对象完成初始渲染。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> pendingCommit <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">executeTask</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 构建当前fiber对象的子fiber对象
     */</span>
    <span class="token function">reconcileChildren</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> fiber<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 下次任务时继续构建fiber.child对象,z这块只处理了子节点，没有处理兄弟节点</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>child<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> fiber<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 当没有子节点的时候，开始去查找兄弟节点并构建fiber对象</span>
    <span class="token keyword">let</span> currentFiber <span class="token operator">=</span> fiber<span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 存放当前节点下的所有fiber对象，包含自身</span>
        currentFiber<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>effects <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>effects<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>
            currentFiber<span class="token punctuation">.</span>effects<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span>currentFiber<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>subling<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> currentFiber<span class="token punctuation">.</span>subling<span class="token punctuation">;</span> <span class="token comment">// 基于该节点去构建</span>
        <span class="token punctuation">}</span>
        currentFiber <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>parent<span class="token punctuation">;</span>
        <span class="token comment">// 向上去处理父节点subling节点</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 执行完成后，currentFiber指向的最外层的fiber对象</span>
    console<span class="token punctuation">.</span><span class="token function">dir</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
    pendingCommit <span class="token operator">=</span> currentFiber<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token template-punctuation string">`</span></span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">

</span><span class="token template-punctuation string">`</span></span>pendingCommit<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">用来接受最外层存储最外层的</span><span class="token template-punctuation string">`</span></span>fiber<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">对象。

</span><span class="token template-punctuation string">`</span></span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token template-punctuation string">`</span></span>js
<span class="token keyword">const</span> <span class="token function-variable function">workLoop</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">deadline</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>subTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        subTask <span class="token operator">=</span> <span class="token function">getFirstTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// console.log(subTask);</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>subTask <span class="token operator">&amp;&amp;</span> deadline<span class="token punctuation">.</span><span class="token function">timeRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 执行任务并返回一个新的任务,这里的任务是构建好的fiber对象</span>
        subTask <span class="token operator">=</span> <span class="token function">executeTask</span><span class="token punctuation">(</span>subTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 当上面的fiber对象构建完成，subTask === undefined</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>pendingCommit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">commitAllWork</span><span class="token punctuation">(</span>pendingCommit<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token comment">// fiber对象是最外层的fiber对象</span>
<span class="token keyword">const</span> <span class="token function-variable function">commitAllWork</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    fiber<span class="token punctuation">.</span>effects<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">subFiber</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>subFiber<span class="token punctuation">.</span>effectTag <span class="token operator">===</span> <span class="token string">&quot;placement&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 添加节点</span>
            subFiber<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>stateNode<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>subFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br></div></div><p>调用<code>commitAllWork</code>来完成渲染，此时已经完成了普通的节点的渲染。</p> <p>目前我们只完成了普通节点的处理，接下来完成类组件和函数时组件的更新,添加一个<code>Component</code>l 类供类组件继承：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// Component/index.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>props <span class="token operator">=</span> props<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// react_fiber/src/index.js</span>

<span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> render<span class="token punctuation">,</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./react&quot;</span><span class="token punctuation">;</span>
<span class="token comment">// const jsx = (</span>
<span class="token comment">//     &lt;div&gt;</span>
<span class="token comment">//         &lt;p&gt;Hello wolrd!&lt;/p&gt;</span>
<span class="token comment">//         &lt;h1&gt;subling&lt;/h1&gt;</span>
<span class="token comment">//     &lt;/div&gt;</span>
<span class="token comment">// );</span>

<span class="token comment">// console.log(jsx);</span>

<span class="token keyword">const</span> root <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// render(jsx, root);</span>

<span class="token keyword">class</span> <span class="token class-name">MyComponent</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span> Hello<span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token operator">!</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// function MyComponent(props) {</span>
<span class="token comment">//     return &lt;div&gt; Hello,{props.name}!&lt;/div&gt;;</span>
<span class="token comment">// }</span>

<span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>MyComponent name<span class="token operator">=</span><span class="token string">&quot;zce&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>首先在于<code>tag</code>的处理：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//getTag.js</span>

<span class="token keyword">import</span> Component <span class="token keyword">from</span> <span class="token string">&quot;../../Component&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">getTag</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">vdom</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 文本节点和元素节点</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> vdom<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;host_component&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">getPrototypeOf</span><span class="token punctuation">(</span>vdom<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token operator">===</span> Component<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 类组件</span>
        <span class="token keyword">return</span> <span class="token string">&quot;class_component&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;function_component&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> getTag<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>类组件和函数组件对应的<code>stateNode</code>分别为<code>类实例对象</code>和函数本身：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// createStateNode.js</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> createDOMElement <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../../DOM&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createReactInstance <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../CreateReactInstance&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">createStateNode</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 文本节点和元素节点</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">&quot;host_component&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">createDOMElement</span><span class="token punctuation">(</span>fiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">createReactInstance</span><span class="token punctuation">(</span>fiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> createStateNode<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p><code>CreateReactInstance.js</code>文件：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">createReactInstance</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> instance <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">&quot;class_component&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">fiber<span class="token punctuation">.</span>type</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        instance <span class="token operator">=</span> fiber<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> instance<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>接下来需要修改处理子组件的方法,不同的类型的<code>fiber</code>.获取子节点的虚拟对象的方式不同</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">executeTask</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 构建当前fiber对象的子fiber对象
     */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">&quot;class_component&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">reconcileChildren</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> fiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">&quot;function_component&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">reconcileChildren</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> fiber<span class="token punctuation">.</span><span class="token function">stateNode</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">reconcileChildren</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> fiber<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 下次任务时继续构建fiber.child对象,z这块只处理了子节点，没有处理兄弟节点</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>child<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> fiber<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 当没有子节点的时候，开始去查找兄弟节点并构建fiber对象</span>
    <span class="token keyword">let</span> currentFiber <span class="token operator">=</span> fiber<span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 存放当前节点下的所有fiber对象，包含自身</span>
        currentFiber<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>effects <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>effects<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>
            currentFiber<span class="token punctuation">.</span>effects<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span>currentFiber<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>subling<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> currentFiber<span class="token punctuation">.</span>subling<span class="token punctuation">;</span> <span class="token comment">// 基于该节点去构建</span>
        <span class="token punctuation">}</span>
        currentFiber <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>parent<span class="token punctuation">;</span>
        <span class="token comment">// 向上去处理父节点subling节点</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 执行完成后，currentFiber指向的最外层的fiber对象</span>
    <span class="token comment">// console.dir(currentFiber);</span>
    pendingCommit <span class="token operator">=</span> currentFiber<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>修改<code>commitAllWork</code>函数，当我们添加元素时，需要去忽略父元素时类组件和函数式组件的<code>fiber</code>对象。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// fiber对象是最外层的fiber对象</span>
<span class="token keyword">const</span> <span class="token function-variable function">commitAllWork</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    fiber<span class="token punctuation">.</span>effects<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">subFiber</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 添加的过程中忽略掉类组件和函数组件的fiber对象</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>subFiber<span class="token punctuation">.</span>effectTag <span class="token operator">===</span> <span class="token string">&quot;placement&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> parentFiber <span class="token operator">=</span> subFiber<span class="token punctuation">.</span>parent<span class="token punctuation">;</span>

            <span class="token keyword">while</span> <span class="token punctuation">(</span>
                parentFiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">&quot;class_component&quot;</span> <span class="token operator">||</span>
                parentFiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">&quot;function_component&quot;</span>
            <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                parentFiber <span class="token operator">=</span> parentFiber<span class="token punctuation">.</span>parent<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>subFiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">&quot;host_component&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 添加节点</span>
                parentFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>subFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>节点更新操作：</p> <p>测试代码：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> render<span class="token punctuation">,</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./react&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> jsx <span class="token operator">=</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>Hello world<span class="token operator">!</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span>subling<span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// console.log(jsx);</span>

<span class="token keyword">const</span> root <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">render</span><span class="token punctuation">(</span>jsx<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">render</span><span class="token punctuation">(</span>
        <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>奥利给<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span>subling<span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token punctuation">,</span>
        root
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>我们需要去缓存上一次的<code>fiber</code>对象，然后利用两次的<code>fiber</code>对象做比较去完成 dom 节点更新：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">commitAllWork</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    fiber<span class="token punctuation">.</span>effects<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">subFiber</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>subFiber<span class="token punctuation">.</span>effectTag <span class="token operator">===</span> <span class="token string">&quot;update&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 更新dom节点</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>subFiber<span class="token punctuation">.</span>type <span class="token operator">!==</span> subFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">/**
                 * dom节点的类型不同，创建一个新的节点去替换旧的节点
                 */</span>
                subFiber<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>stateNode<span class="token punctuation">.</span><span class="token function">replaceChild</span><span class="token punctuation">(</span>
                    subFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">,</span>
                    subFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">.</span>stateNode
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">/**
                 * 类型相同，更新节点的内容
                 */</span>
                <span class="token function">updateElementNode</span><span class="token punctuation">(</span>
                    subFiber<span class="token punctuation">,</span>
                    subFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">,</span>
                    subFiber<span class="token punctuation">.</span>alternate
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>subFiber<span class="token punctuation">.</span>effectTag <span class="token operator">===</span> <span class="token string">&quot;placement&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 添加的过程中忽略掉类组件和函数组件的fiber对象</span>
            <span class="token keyword">let</span> parentFiber <span class="token operator">=</span> subFiber<span class="token punctuation">.</span>parent<span class="token punctuation">;</span>

            <span class="token keyword">while</span> <span class="token punctuation">(</span>
                parentFiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">&quot;class_component&quot;</span> <span class="token operator">||</span>
                parentFiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">&quot;function_component&quot;</span>
            <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                parentFiber <span class="token operator">=</span> parentFiber<span class="token punctuation">.</span>parent<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>subFiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">&quot;host_component&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 添加节点</span>
                parentFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>subFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/**
         * 缓存旧的的fiber节点，为下次比对准备
         */</span>

        fiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">.</span>__rootFiberContainer <span class="token operator">=</span> fiber<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><p>每次生成新的<code>dom</code>后，我们都需要去存储旧的<code>fiber对象</code>。在每次创建新的<code>fiber</code>对象时获取：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">getFirstTask</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 获取任务队列队列中第一个任务的子任务
     *
     */</span>

    <span class="token keyword">const</span> subTask <span class="token operator">=</span> taskQueue<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// console.error(subTask);</span>

    <span class="token comment">/**
     * 构建fiber对象(最晚层元素root对应的fiber对象)
     */</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        props<span class="token operator">:</span> subTask<span class="token punctuation">.</span>props<span class="token punctuation">,</span>
        stateNode<span class="token operator">:</span> subTask<span class="token punctuation">.</span>dom<span class="token punctuation">,</span> <span class="token comment">//当前fiber对象对应的dom</span>
        tag<span class="token operator">:</span> <span class="token string">&quot;hostRoot&quot;</span><span class="token punctuation">,</span> <span class="token comment">//根节点</span>
        effects<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        child<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">//后面构建了子fiber节点再去设置,</span>
        alternate<span class="token operator">:</span> subTask<span class="token punctuation">.</span>dom<span class="token punctuation">.</span>__rootFiberContainer<span class="token punctuation">,</span> <span class="token comment">// 替换的节点对应的fiber对象</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>然后构建子<code>fiber</code>对象是找出对应的旧<code>fiber</code>对象去对比,然后重新创建<code>stateNode</code>属性还是去更新
<code>stateNode</code>属性：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>
<span class="token keyword">const</span> <span class="token function-variable function">reconcileChildren</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">fiber<span class="token punctuation">,</span> children</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">//当children是根fiber对象时，children是对象，当是用creaeElement方法创建的，则是数组</span>
    <span class="token comment">// 将children转成数组统一处理</span>
    <span class="token keyword">const</span> arrifiedChildren <span class="token operator">=</span> <span class="token function">arrified</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
        element <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        length <span class="token operator">=</span> arrifiedChildren<span class="token punctuation">.</span>length<span class="token punctuation">,</span>
        newFiber <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        prevFiber <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> alternate <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 存储每一个子节点对应的旧fiber节点</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>alternate <span class="token operator">&amp;&amp;</span> fiber<span class="token punctuation">.</span>alternate<span class="token punctuation">.</span>child<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        alternate <span class="token operator">=</span> fiber<span class="token punctuation">.</span>alternate<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>index <span class="token operator">&lt;</span> length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        element <span class="token operator">=</span> arrifiedChildren<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>element <span class="token operator">&amp;&amp;</span> alternate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 节点的类型不同</span>
            newFiber <span class="token operator">=</span> <span class="token punctuation">{</span>
                type<span class="token operator">:</span> element<span class="token punctuation">.</span>type<span class="token punctuation">,</span>
                props<span class="token operator">:</span> element<span class="token punctuation">.</span>props<span class="token punctuation">,</span>
                tag<span class="token operator">:</span> <span class="token function">getTag</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">,</span>
                effects<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                effectTag<span class="token operator">:</span> <span class="token string">&quot;update&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 更新节点</span>
                <span class="token comment">// stateNode: null,</span>
                parent<span class="token operator">:</span> fiber<span class="token punctuation">,</span>
                alternate<span class="token punctuation">,</span> <span class="token comment">// 当前节点对应的旧的fiber对象</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token comment">// 更新节点</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>element<span class="token punctuation">.</span>type <span class="token operator">!==</span> alternate<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 给新创建的fiber对象添加stateNode属性</span>
                newFiber<span class="token punctuation">.</span>stateNode <span class="token operator">=</span> <span class="token function">createStateNode</span><span class="token punctuation">(</span>newFiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// 节点的类型相同，用旧的几点代替新的节点</span>
                newFiber<span class="token punctuation">.</span>stateNode <span class="token operator">=</span> alternate<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>element <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>alternate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 初始渲染</span>
            <span class="token comment">// 将当前的虚拟dom构建成fiber对象</span>
            newFiber <span class="token operator">=</span> <span class="token punctuation">{</span>
                type<span class="token operator">:</span> element<span class="token punctuation">.</span>type<span class="token punctuation">,</span>
                props<span class="token operator">:</span> element<span class="token punctuation">.</span>props<span class="token punctuation">,</span>
                tag<span class="token operator">:</span> <span class="token function">getTag</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">,</span>
                effects<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                effectTag<span class="token operator">:</span> <span class="token string">&quot;placement&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 添加节点</span>
                <span class="token comment">// stateNode: null,</span>
                parent<span class="token operator">:</span> fiber<span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token comment">// 给新创建的fiber对象添加stateNode属性</span>
            newFiber<span class="token punctuation">.</span>stateNode <span class="token operator">=</span> <span class="token function">createStateNode</span><span class="token punctuation">(</span>newFiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 更新胡后续的child节点对应的alternate</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>alternate <span class="token operator">&amp;&amp;</span> alternate<span class="token punctuation">.</span>subling<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            alternate <span class="token operator">=</span> alternate<span class="token punctuation">.</span>subling<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            alternate <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 作为当前节点的child</span>
            fiber<span class="token punctuation">.</span>child <span class="token operator">=</span> newFiber<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">//作为前一个兄弟节点的邻居节点</span>
            prevFiber<span class="token punctuation">.</span>subling <span class="token operator">=</span> newFiber<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        prevFiber <span class="token operator">=</span> newFiber<span class="token punctuation">;</span>
        index<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br></div></div><p>更新完成在后续提交中更新<code>dom</code>;</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>
<span class="token comment">// fiber对象是最外层的fiber对象</span>
<span class="token keyword">const</span> <span class="token function-variable function">commitAllWork</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    fiber<span class="token punctuation">.</span>effects<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">subFiber</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>subFiber<span class="token punctuation">.</span>effectTag <span class="token operator">===</span> <span class="token string">&quot;update&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 更新dom节点</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>subFiber<span class="token punctuation">.</span>type <span class="token operator">!==</span> subFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">/**
                 * dom节点的类型不同，创建一个新的节点去替换旧的节点
                 */</span>
                subFiber<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>stateNode<span class="token punctuation">.</span><span class="token function">replaceChild</span><span class="token punctuation">(</span>
                    subFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">,</span>
                    subFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">.</span>stateNode
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">/**
                 * 类型相同，更新节点的内容
                 */</span>
                <span class="token function">updateElementNode</span><span class="token punctuation">(</span>
                    subFiber<span class="token punctuation">,</span>
                    subFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">,</span>
                    subFiber<span class="token punctuation">.</span>alternate
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>subFiber<span class="token punctuation">.</span>effectTag <span class="token operator">===</span> <span class="token string">&quot;placement&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 添加的过程中忽略掉类组件和函数组件的fiber对象</span>
            <span class="token keyword">let</span> parentFiber <span class="token operator">=</span> subFiber<span class="token punctuation">.</span>parent<span class="token punctuation">;</span>

            <span class="token keyword">while</span> <span class="token punctuation">(</span>
                parentFiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">&quot;class_component&quot;</span> <span class="token operator">||</span>
                parentFiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">&quot;function_component&quot;</span>
            <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                parentFiber <span class="token operator">=</span> parentFiber<span class="token punctuation">.</span>parent<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>subFiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">&quot;host_component&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 添加节点</span>
                parentFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>subFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/**
         * 缓存旧的的fiber节点，为下次比对准备
         */</span>

        fiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">.</span>__rootFiberContainer <span class="token operator">=</span> fiber<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><p>由于<code>updateElementNode</code>方法只能更新元素节点，我们需要添加对文本节点的更新：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">updateElementNode</span><span class="token punctuation">(</span>
    <span class="token parameter">virtualDom<span class="token punctuation">,</span>
    newElement<span class="token punctuation">,</span>
    oldVirtualDom <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> propsObj <span class="token operator">=</span> virtualDom<span class="token punctuation">.</span>props <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> oldPropsObj <span class="token operator">=</span> oldVirtualDom<span class="token punctuation">.</span>props <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// 对文本节点的更新</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>virtualDom<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 文本的属性不同</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>propsObj<span class="token punctuation">.</span>textContent <span class="token operator">!==</span> oldPropsObj<span class="token punctuation">.</span>textContent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 更新的时候需要去对比父元素的类型,为什么呢 ，因为父元素的类型不同，更新完子节点后回去创建新的父节点替换节点时找不到子文本节点，替换失败，</span>
            <span class="token comment">// 因为原来的子节点oldVirtualDom.stateNode，不存在virtualDom.parent.stateNode上</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>virtualDom<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>type <span class="token operator">!==</span> oldVirtualDom<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 父元素的类型不同</span>
                virtualDom<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>stateNode<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>
                    document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>propsObj<span class="token punctuation">.</span>textContent<span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// 父元素的类型相同</span>
                virtualDom<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>stateNode<span class="token punctuation">.</span><span class="token function">replaceChild</span><span class="token punctuation">(</span>
                    document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>propsObj<span class="token punctuation">.</span>textContent<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    oldVirtualDom<span class="token punctuation">.</span>stateNode
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>propsObj<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">prop</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> propValue <span class="token operator">=</span> propsObj<span class="token punctuation">[</span>prop<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> oldPropValue <span class="token operator">=</span> oldPropsObj<span class="token punctuation">[</span>prop<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>propValue <span class="token operator">!==</span> oldPropValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>prop<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">&quot;on&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 当我们要添加的属性是元素的事件</span>
                <span class="token keyword">const</span> eventName <span class="token operator">=</span> prop<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>oldPropValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 删除旧的事件</span>
                    newElement<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span>eventName<span class="token punctuation">,</span> oldPropValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                newElement<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>eventName<span class="token punctuation">,</span> propValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>prop <span class="token operator">===</span> <span class="token string">&quot;value&quot;</span> <span class="token operator">||</span> prop <span class="token operator">===</span> <span class="token string">&quot;checked&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// bool属性</span>
                newElement<span class="token punctuation">[</span>prop<span class="token punctuation">]</span> <span class="token operator">=</span> propValue<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>prop <span class="token operator">!==</span> <span class="token string">&quot;children&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// class属性和其他的属性</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>prop <span class="token operator">===</span> <span class="token string">&quot;className&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    newElement<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;class&quot;</span><span class="token punctuation">,</span> propValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    newElement<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>prop<span class="token punctuation">,</span> propValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 判断属性被删除的情况(旧的虚拟上有但是新的没有)</span>

    Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>oldPropsObj<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">prop</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> propValue <span class="token operator">=</span> propsObj<span class="token punctuation">[</span>prop<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> oldPropValue <span class="token operator">=</span> oldPropsObj<span class="token punctuation">[</span>prop<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>propValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>prop<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">&quot;on&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> eventName <span class="token operator">=</span> prop<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                newElement<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span>eventName<span class="token punctuation">,</span> oldPropValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>prop <span class="token operator">!==</span> <span class="token string">&quot;children&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                newElement<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span>prop<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    newElement<span class="token punctuation">.</span>_virtualDom <span class="token operator">=</span> virtualDom<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br></div></div><p>删除节点操作：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">reconcileChildren</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">fiber<span class="token punctuation">,</span> children</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">//当children是根fiber对象时，children是对象，当是用creaeElement方法创建的，则是数组</span>
    <span class="token comment">// 将children转成数组统一处理</span>
    <span class="token keyword">const</span> arrifiedChildren <span class="token operator">=</span> <span class="token function">arrified</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
        element <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        length <span class="token operator">=</span> arrifiedChildren<span class="token punctuation">.</span>length<span class="token punctuation">,</span>
        newFiber <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        prevFiber <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> alternate <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 存储每一个子节点对应的旧fiber节点</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>alternate <span class="token operator">&amp;&amp;</span> fiber<span class="token punctuation">.</span>alternate<span class="token punctuation">.</span>child<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        alternate <span class="token operator">=</span> fiber<span class="token punctuation">.</span>alternate<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 保证我们删除的时候可以进入</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>index <span class="token operator">&lt;</span> length <span class="token operator">||</span> alternate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        element <span class="token operator">=</span> arrifiedChildren<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>element <span class="token operator">&amp;&amp;</span> alternate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//说明子节点中有删除</span>
            alternate<span class="token punctuation">.</span>effectTag <span class="token operator">=</span> <span class="token string">&quot;delete&quot;</span><span class="token punctuation">;</span>
            <span class="token comment">// 将删除操作添加到新的fiber对象中</span>
            fiber<span class="token punctuation">.</span>effects<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>alternate<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>element <span class="token operator">&amp;&amp;</span> alternate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 更新节点</span>
            <span class="token comment">// 节点的类型不同</span>
            newFiber <span class="token operator">=</span> <span class="token punctuation">{</span>
                type<span class="token operator">:</span> element<span class="token punctuation">.</span>type<span class="token punctuation">,</span>
                props<span class="token operator">:</span> element<span class="token punctuation">.</span>props<span class="token punctuation">,</span>
                tag<span class="token operator">:</span> <span class="token function">getTag</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">,</span>
                effects<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                effectTag<span class="token operator">:</span> <span class="token string">&quot;update&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 更新节点</span>
                <span class="token comment">// stateNode: null,</span>
                parent<span class="token operator">:</span> fiber<span class="token punctuation">,</span>
                alternate<span class="token punctuation">,</span> <span class="token comment">// 当前节点对应的旧的fiber对象</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token comment">// 更新节点</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>element<span class="token punctuation">.</span>type <span class="token operator">!==</span> alternate<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 给新创建的fiber对象添加stateNode属性</span>
                newFiber<span class="token punctuation">.</span>stateNode <span class="token operator">=</span> <span class="token function">createStateNode</span><span class="token punctuation">(</span>newFiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// 节点的类型相同，用旧的几点代替新的节点</span>
                newFiber<span class="token punctuation">.</span>stateNode <span class="token operator">=</span> alternate<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>element <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>alternate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 初始渲染</span>
            <span class="token comment">// 将当前的虚拟dom构建成fiber对象</span>
            newFiber <span class="token operator">=</span> <span class="token punctuation">{</span>
                type<span class="token operator">:</span> element<span class="token punctuation">.</span>type<span class="token punctuation">,</span>
                props<span class="token operator">:</span> element<span class="token punctuation">.</span>props<span class="token punctuation">,</span>
                tag<span class="token operator">:</span> <span class="token function">getTag</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">,</span>
                effects<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                effectTag<span class="token operator">:</span> <span class="token string">&quot;placement&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 添加节点</span>
                <span class="token comment">// stateNode: null,</span>
                parent<span class="token operator">:</span> fiber<span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token comment">// 给新创建的fiber对象添加stateNode属性</span>
            newFiber<span class="token punctuation">.</span>stateNode <span class="token operator">=</span> <span class="token function">createStateNode</span><span class="token punctuation">(</span>newFiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 更新胡后续的child节点对应的alternate</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>alternate <span class="token operator">&amp;&amp;</span> alternate<span class="token punctuation">.</span>subling<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            alternate <span class="token operator">=</span> alternate<span class="token punctuation">.</span>subling<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            alternate <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 作为当前节点的child</span>
            fiber<span class="token punctuation">.</span>child <span class="token operator">=</span> newFiber<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>element<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//避免删除节点的时候去添加过去的节点</span>
            <span class="token comment">//作为前一个兄弟节点的邻居节点</span>
            prevFiber<span class="token punctuation">.</span>subling <span class="token operator">=</span> newFiber<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        prevFiber <span class="token operator">=</span> newFiber<span class="token punctuation">;</span>
        index<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br></div></div><p><code>alternate</code>存在时且<code>element</code>不存在时(本质上是子节点的数量减少，先更新同位置的子节点，再去删除多余子节点)。然后在<code>commit</code>的时候去处理<code>dom</code>:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>
<span class="token keyword">const</span> <span class="token function-variable function">commitAllWork</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    fiber<span class="token punctuation">.</span>effects<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">subFiber</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>subFiber<span class="token punctuation">.</span>effectTag <span class="token operator">===</span> <span class="token string">&quot;delete&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 删除节点</span>
            subFiber<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>stateNode<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>subFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>subFiber<span class="token punctuation">.</span>effectTag <span class="token operator">===</span> <span class="token string">&quot;update&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 更新dom节点</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>subFiber<span class="token punctuation">.</span>type <span class="token operator">!==</span> subFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">/**
                 * dom节点的类型不同，创建一个新的节点去替换旧的节点
                 */</span>
                subFiber<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>stateNode<span class="token punctuation">.</span><span class="token function">replaceChild</span><span class="token punctuation">(</span>
                    subFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">,</span>
                    subFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">.</span>stateNode
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">/**
                 * 类型相同，更新节点的内容
                 */</span>
                <span class="token function">updateElementNode</span><span class="token punctuation">(</span>
                    subFiber<span class="token punctuation">,</span>
                    subFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">,</span>
                    subFiber<span class="token punctuation">.</span>alternate
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>subFiber<span class="token punctuation">.</span>effectTag <span class="token operator">===</span> <span class="token string">&quot;placement&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 添加的过程中忽略掉类组件和函数组件的fiber对象</span>
            <span class="token keyword">let</span> parentFiber <span class="token operator">=</span> subFiber<span class="token punctuation">.</span>parent<span class="token punctuation">;</span>

            <span class="token keyword">while</span> <span class="token punctuation">(</span>
                parentFiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">&quot;class_component&quot;</span> <span class="token operator">||</span>
                parentFiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">&quot;function_component&quot;</span>
            <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                parentFiber <span class="token operator">=</span> parentFiber<span class="token punctuation">.</span>parent<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>subFiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">&quot;host_component&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 添加节点</span>
                parentFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>subFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/**
         * 缓存旧的的fiber节点，为下次比对准备
         */</span>

        fiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">.</span>__rootFiberContainer <span class="token operator">=</span> fiber<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/react/virtualDom.html" class="prev">
        2.Virtual DOM 及 Diff 算法
      </a></span> <span class="next"><a href="/react/formik.html">
        formik
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.9b56a05a.js" defer></script><script src="/assets/js/2.b22280cb.js" defer></script><script src="/assets/js/95.b253d44f.js" defer></script>
  </body>
</html>
