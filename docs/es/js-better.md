

##  JS性能优化

### 什么是性能优化

所谓的性能优化就是提升代码的运行效率、减少代码运行时资源消耗。而JS性能优化就是在这门语言中优化代码的性能。

### JS的内存管理

内存:可读写单元，表示一片可操作的区域。

管理:人为的操作一片空间的申请、使用和释放

内存管理：开发者主动去申请内存空间、使用内存空间、和释放内存空间

JS不能想C语言那样主动去申请和释放内存空间，但是我们我还能还是可通过执行脚本来观察JS中内存使用的生命周期变化

```js
/**
 *
 * 内存管理
 *
 */

// 申请内存

let a = {}

// 使用内存

a.name = 'tom'

// 释放内存

a = null

```

### JS的垃圾回收

* JS中的垃圾
  * JS的内存管理是自动的
  * 对象不再被引用是就是垃圾
  * 对象不能从根上去访问到是垃圾

当JS的垃圾回收器认为对象是一个垃圾时，就会自动对对象占用的内存地址进行回收。

* JS中的可达对象
  * 可以被访问到对象就是可达对象(引用和作用域)
  *  可达的标准就是从根(全局对象)上出发可以能被找到。
  * JS中的根可以理解为全局对象

```js
/**
 * 可达对象
 */

function objGroup(obj1, obj2) {
	obj1.prev = obj2
	obj2.next = obj1
	return {
		o1: obj1,
		o2: obj2
	}
}

const obj = objGroup({ name: 'obj1' }, { name: 'obj2' })
```

上面的三个对象都是可达对象，他们之间的关系如下

![reachable](/frontEnd/reachable.png)

当我们断开obj1对象的引用时，obj1就会变成一个垃圾对象

```js
Reflect.deleteProperty(obj, 'o1')

Reflect.deleteProperty(obj.o2, 'next')
```

![reachable](/frontEnd/garbage.png)

### GC的定义与作用

* GC就是垃圾回收机制的简写

* GC可以找到内存中的垃圾并释放和回收

### GC里面的垃圾

* 程序中不再需要使用到的对象

  ```js
  function Str() {
  	name = 'hello'
  	return `${name} world`
  }
  ```

* 程序中不能再访问到的对象

  ```js
  function Str() {
  	const name = 'hello'
  	return `${name} world`
  }
  ```

### GC算法

* GC是一种机制，垃圾回收器去完成具体的工作
* 工作的内容就是查找垃圾、释放空间、回收空间
* 算法就是工作时查找和回收所遵循的规则

### 常见的GC算法

* 引用计数
* 标记清除
* 标记整理
* 分带回收

### 引用计数算法

引用计数算法的核心就是就是为变量设置引用计数器。当变量的引用计数器为0被GC回收。

```js
/**
 *
 * 引用计数
 *
 */

const a = { name: 'a' }

const b = { name: 'b' }

const list = [a.name, b.name]

function f() {
	const a = 1
	const b = 1
}

f()
```

根据引用计数的算法:全局变量a,b，list一直有引用全局对象指向他们，所以它们不会被回收.而f执行的时候创建的变量a,b在函数执行过程位于函数的作用域脸上，当函数执行接受后不在有引用指向他们，他们就会被回收掉。

* 引用计数算法的好处

  * 发现垃圾时立马回收(引用计数为0)
  * 最大限度减少程序暂停

* 引用计数算法的坏处

  * 时间开销大(要不断的去检测引用数的变化)
  * 无法回收循环引用的对象

  ```js
  function fun() {
  	const a = { name: 'a' }
  	const b = { name: 'b' }
  	a.b = b
  	b.a = a
  	return ''
  }
  // a和b对象相互引用，引用计数器不为0
  fun()
  ```

### 标记清除算法

* 标记清除算法的分标记和清除两个阶段完成
* 遍历所有对象去找活动对象(可达对象)
* 遍历所有对象去清除没有标记的对象，将所有清除对象的内存释放并放入空闲链表中，方便下次直接使用。

![标记清除算法示意图](/frontEnd/sign.png)

:::tip

标记清除算法会遍历所有的对象并标记处可达对象，想局部作用域中的对象a1和a2是不可达的，即使循环引用，依旧会被回收。

:::

* 算法的优缺点

  * 优点是可以发现循环引用的不可达对象并回收
  * 缺点是:会造成内存空间碎片,回收后的空间在内存中可能不连续且大小不固定，我们下次要分配的空间不一定满足。
  * 不可以立即回收内存空间

  ![标记清除算法的缺点](/frontEnd/memory.png)

### 标记整理算法

* 标记整理算法是对标记清除算法的增强
* 标记阶段和清除阶段是一样的
* 清除之前会先执行整理操作，移动对象的位置

* 标记阶段

![标记阶段](/frontEnd/before_clear.png)

* 整理阶段

![整理阶段](/frontEnd/arrange.png)

* 清除阶段

![清除阶段](/frontEnd/cleared.png)

* 优缺点：
  * 可以减少内存碎片
  * 不可以立即回收内存空间

### V8介绍

* v8是一款主流的JS执行引擎
* v8采用的技术编译(直接编译成机器码)
* v8内存设限(64 ->1.5G 32->800M),这样子可以快速回收垃圾

